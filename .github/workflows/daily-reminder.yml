name: Daily reminder push

on:
  schedule:
    - cron: "0 12 * * *"   # 台北 20:00（UTC+8）
    - cron: "0 14 * * *"   # 台北 22:00（UTC+8）
  workflow_dispatch: {}

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      # 1) 用服務帳戶登入
      - name: Auth to Google
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      # 2) 安裝 gcloud 並指定專案
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.FIREBASE_PROJECT_ID }}

      # 3) 安裝 jq
      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      # 4) 取 Access Token（給 Firestore / FCM 用）
      - name: Get access token
        id: token
        run: echo "ACCESS_TOKEN=$(gcloud auth application-default print-access-token)" >> $GITHUB_OUTPUT

      # 5) 用 REST 讀取 Firestore：daily/{UID}
      - name: Read pendingCount from Firestore (REST)
        id: read_pending
        shell: bash
        env:
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          UID: ${{ secrets.FIREBASE_UID }}           # 例如：pogm0xwb6eX...（你剛確認的那個）
          ACCESS_TOKEN: ${{ steps.token.outputs.ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          URL="https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/daily/${UID}"
          echo "GET ${URL}"

          HTTP_STATUS=$(curl -sS -o doc.json -w "%{http_code}" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Accept: application/json" \
            "${URL}")

          echo "HTTP_STATUS=${HTTP_STATUS}"
          echo "----- Raw doc (first 80 lines) -----"
          head -n 80 doc.json || true
          echo "------------------------------------"

          if [ "${HTTP_STATUS}" != "200" ]; then
            echo "Firestore read failed (maybe doc not found?)."
            echo "pending="  >> $GITHUB_OUTPUT
            echo "dayToken=" >> $GITHUB_OUTPUT
            exit 0
          fi

          PENDING=$(jq -r '.fields.meta.mapValue.fields.pendingCount.integerValue // empty' doc.json)
          DAYTOKEN=$(jq -r '.fields.meta.mapValue.fields.dayToken.stringValue // empty' doc.json)

          echo "parsed pending='${PENDING}', dayToken='${DAYTOKEN}'"
          echo "pending=${PENDING}"   >> $GITHUB_OUTPUT
          echo "dayToken=${DAYTOKEN}" >> $GITHUB_OUTPUT

      # 6) 決策：今天且未清空才推
      - name: Decide to push?
        id: decide
        shell: bash
        run: |
          set -euo pipefail
          P="${{ steps.read_pending.outputs.pending }}"
          DT="${{ steps.read_pending.outputs.dayToken }}"
          TODAY="$(TZ=Asia/Taipei date +%Y-%m-%d)"

          PN=0
          if [[ "${P}" =~ ^[0-9]+$ ]]; then
            PN="${P}"
          fi

          echo "PN=${PN}, DT='${DT}', TODAY='${TODAY}'"

          if [[ "${DT}" == "${TODAY}" ]] && [[ ${PN} -gt 0 ]]; then
            echo "should_send=true"  >> $GITHUB_OUTPUT
            echo "Decision: PUSH (pending>0 & dayToken=today)"
          else
            echo "should_send=false" >> $GITHUB_OUTPUT
            echo "Decision: SKIP (no pending or not today)"
          fi

      # 7) 組 FCM payload
      - name: Build FCM payload
        if: steps.decide.outputs.should_send == 'true'
        run: |
          cat > payload.json <<'JSON'
          {
            "message": {
              "token": "${{ secrets.FCM_TOKEN }}",
              "notification": {
                "title": "每日任務提醒",
                "body": "你還有未完成的每日任務喔！"
              },
              "webpush": {
                "headers": {
                  "Urgency": "high",
                  "TTL": "300"
                },
                "fcm_options": {
                  "link": "https://eyvind95.github.io/hello/apps/ledger/daily.html"
                },
                "notification": {
                  "icon": "https://eyvind95.github.io/hello/apps/ledger/6.png",
                  "badge": "https://eyvind95.github.io/hello/apps/ledger/8.png",
                  "tag": "daily-reminder"
                }
              }
            }
          }
          JSON
          echo "Payload built:"
          cat payload.json

      # 8) 打 FCM HTTP v1
      - name: Send FCM HTTP v1
        if: steps.decide.outputs.should_send == 'true'
        shell: bash
        env:
          ACCESS_TOKEN: ${{ steps.token.outputs.ACCESS_TOKEN }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          set -euo pipefail
          HTTP_STATUS=$(curl -sS -o response.json -w "%{http_code}" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json; charset=UTF-8" \
            "https://fcm.googleapis.com/v1/projects/${PROJECT_ID}/messages:send" \
            -d @payload.json)
          echo "HTTP_STATUS=${HTTP_STATUS}"
          echo "RESPONSE:"; cat response.json
          if [ "${HTTP_STATUS}" != "200" ]; then
            echo "Send failed."
            exit 1
          fi
          echo "Send OK."

      # 9) 跳過時的說明
      - name: Skip push (no need)
        if: steps.decide.outputs.should_send != 'true'
        run: |
          echo "Skip push: pending='${{ steps.read_pending.outputs.pending }}' dayToken='${{ steps.read_pending.outputs.dayToken }}' today='$(TZ=Asia/Taipei date +%Y-%m-%d)'"
