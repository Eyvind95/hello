name: Daily reminder push

on:
  schedule:
    - cron: "0 12 * * *"   # å°åŒ— 20:00ï¼ˆUTC+8ï¼‰
    - cron: "0 14 * * *"   # å°åŒ— 22:00ï¼ˆUTC+8ï¼‰
  workflow_dispatch: {}

jobs:
  push:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ç™»å…¥ Google
      - name: Auth to Google
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      # 2ï¸âƒ£ å®‰è£ gcloud
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.FIREBASE_PROJECT_ID }}

      # 3ï¸âƒ£ å®‰è£ jqï¼ˆç”¨ä¾†è™•ç† JSONï¼‰
      - name: Install jq
        run: sudo apt-get install -y jq

      # 4ï¸âƒ£ å–å¾— Access Token
      - name: Get access token
        run: |
          ACCESS_TOKEN=$(gcloud auth application-default print-access-token)
          echo "ACCESS_TOKEN=${ACCESS_TOKEN}" >> $GITHUB_ENV

      # 5ï¸âƒ£ å¾ž Firestore è®€å– pendingCount
- name: Read pendingCount from Firestore
  id: firestore
  run: |
    echo "ðŸ“¥ Fetching Firestore document..."
    curl -sS -X GET \
      -H "Authorization: Bearer $ACCESS_TOKEN" \
      -H "Content-Type: application/json" \
      "https://firestore.googleapis.com/v1/projects/${{ secrets.FIREBASE_PROJECT_ID }}/databases/(default)/documents/daily/${{ secrets.FIREBASE_UID }}" \
      -o firestore.json

    echo "Firestore response (truncated):"
    jq 'del(.fields | .. | objects | .[]? |= (type=="string" and (.|length>200)? then .[0:200]+"..." else . end))' firestore.json | head -n 80

    # ä¾åºå˜—è©¦ï¼š
    # 1) æ ¹å±¤ pendingCount
    # 2) meta.pendingCount
    # éƒ½æ²’æœ‰ => 0
    pendingCount=$(jq -r '
      if (.fields.pendingCount.integerValue? // empty) then
        .fields.pendingCount.integerValue
      elif (.fields.meta.mapValue.fields.pendingCount.integerValue? // empty) then
        .fields.meta.mapValue.fields.pendingCount.integerValue
      else
        "0"
      end
    ' firestore.json)

    echo "pendingCount=${pendingCount}" | tee -a $GITHUB_ENV

      # 6ï¸âƒ£ æª¢æŸ¥æ˜¯å¦éœ€è¦ç™¼é€šçŸ¥
      - name: Skip push (nothing pending)
        if: env.pendingCount == '0'
        run: echo "âœ… æ‰€æœ‰ä»»å‹™éƒ½å®Œæˆï¼Œè·³éŽæŽ¨æ’­ã€‚"

      # 7ï¸âƒ£ å»ºç«‹æŽ¨æ’­ payload
      - name: Build FCM payload
        if: env.pendingCount != '0'
        run: |
          cat > payload.json <<'JSON'
          {
            "message": {
              "token": "${{ secrets.FCM_TOKEN }}",
              "notification": {
                "title": "æ¯æ—¥ä»»å‹™æé†’",
                "body": "ä½ é‚„æœ‰æœªå®Œæˆçš„æ¯æ—¥ä»»å‹™å–”ï¼"
              },
              "webpush": {
                "headers": {
                  "Urgency": "high",
                  "TTL": "300"
                },
                "fcm_options": {
                  "link": "https://eyvind95.github.io/hello/apps/ledger/daily.html"
                },
                "notification": {
                  "icon": "https://eyvind95.github.io/hello/apps/ledger/6.png",
                  "badge": "https://eyvind95.github.io/hello/apps/ledger/8.png",
                  "tag": "daily-reminder"
                }
              }
            }
          }
          JSON
          echo "Payload built:"
          cat payload.json

      # 8ï¸âƒ£ å‚³é€æŽ¨æ’­
      - name: Send FCM HTTP v1
        if: env.pendingCount != '0'
        run: |
          set -euo pipefail
          HTTP_STATUS=$(curl -sS -o response.json -w "%{http_code}" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json; charset=UTF-8" \
            "https://fcm.googleapis.com/v1/projects/${{ secrets.FIREBASE_PROJECT_ID }}/messages:send" \
            -d @payload.json)

          echo "HTTP_STATUS=${HTTP_STATUS}"
          echo "RESPONSE:"
          cat response.json

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ FCM send failed."
            exit 1
          fi

      # 9ï¸âƒ£ å®Œæˆ
      - name: Done
        run: echo "ðŸŽ‰ Workflow finished."
