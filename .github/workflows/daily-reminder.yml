name: Daily reminder push

on:
  schedule:
    - cron: "20 11 * * *"   # 台灣時間 20:00
    - cron: "20 13 * * *"   # 台灣時間 22:00
  workflow_dispatch: {}

# 避免同一時間重疊運行
concurrency:
  group: daily-reminder
  cancel-in-progress: true

jobs:
  push:
    runs-on: ubuntu-latest

    steps:
      - name: Auth to Google
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # 讀 /daily/<uid> 判斷是否今天要推
      - name: Read pendingCount & dayToken from Firestore (REST)
        id: read_pending
        env:
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          UID: ${{ secrets.FIREBASE_UID }}
        run: |
          set -euo pipefail
          ACCESS_TOKEN="$(gcloud auth application-default print-access-token)"
          DOC_URL="https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/daily/${UID}"

          HTTP_STATUS=$(curl -sS -o doc.json -w "%{http_code}" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json; charset=UTF-8" \
            "$DOC_URL")
          echo "HTTP_STATUS=${HTTP_STATUS}"
          head -n 80 doc.json || true

          if [ "$HTTP_STATUS" != "200" ] || [ ! -s doc.json ]; then
            echo "pending="   >> "$GITHUB_OUTPUT"
            echo "dayToken="  >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 防呆：非 JSON → {}
          if ! head -c1 doc.json | grep -q '{'; then echo '{}' > doc.json; fi

          PENDING=$(jq -r 'try .fields.meta.mapValue.fields.pendingCount.integerValue // empty' doc.json)
          DAYTOKEN=$(jq -r 'try .fields.meta.mapValue.fields.dayToken.stringValue   // empty' doc.json)

          echo "pending=${PENDING}"   >> "$GITHUB_OUTPUT"
          echo "dayToken=${DAYTOKEN}" >> "$GITHUB_OUTPUT"

      - name: Decide to push?
        id: decide
        run: |
          set -euo pipefail
          PENDING="${{ steps.read_pending.outputs.pending }}"
          DT="${{ steps.read_pending.outputs.dayToken }}"
          TODAY="$(TZ=Asia/Taipei date +%Y-%m-%d)"
          TS="$(TZ=Asia/Taipei date +%Y%m%d-%H%M)"
          echo "ts=${TS}" >> "$GITHUB_OUTPUT"
          echo "Today=${TODAY}, pending='${PENDING}', dayToken='${DT}'"

          if [ -z "${DT}" ] || [ -z "${PENDING}" ]; then echo "do_send=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          if ! [[ "$PENDING" =~ ^[0-9]+$ ]]; then PENDING=0; fi
          if [ "$DT" != "$TODAY" ]; then echo "do_send=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          if [ "$PENDING" -le 0 ]; then echo "do_send=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          echo "do_send=true" >> "$GITHUB_OUTPUT"

      # 列出 /daily/<uid>/tokens（分頁）→ tokens.txt
      - name: List device tokens
        if: steps.decide.outputs.do_send == 'true'
        id: list_tokens
        env:
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          UID: ${{ secrets.FIREBASE_UID }}
        run: |
          set -euo pipefail
          ACCESS_TOKEN="$(gcloud auth application-default print-access-token)"
          BASE="https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents"
          PARENT="${BASE}/daily/${UID}/tokens"
          PAGE_TOKEN=""
          : > tokens_raw.txt

          while :; do
            URL="${PARENT}"
            if [ -n "$PAGE_TOKEN" ]; then URL="${URL}?pageToken=${PAGE_TOKEN}"; fi

            HTTP_STATUS=$(curl -sS -o tokens.json -w "%{http_code}" \
              -H "Authorization: Bearer ${ACCESS_TOKEN}" \
              -H "Content-Type: application/json; charset=UTF-8" \
              "$URL")
            echo "LIST TOKENS http=${HTTP_STATUS}"

            if [ "$HTTP_STATUS" != "200" ] || [ ! -s tokens.json ]; then
              echo "No tokens or list failed."
              break
            fi
            if ! head -c1 tokens.json | grep -q '{'; then echo '{}' > tokens.json; fi

            # 取文件 id（= token 字串），追加到 tokens_raw.txt
            jq -r 'try .documents[]?.name | capture("(?<id>[^/]+)$").id // empty' tokens.json >> tokens_raw.txt
            PAGE_TOKEN=$(jq -r 'try .nextPageToken // empty' tokens.json)
            [ -z "$PAGE_TOKEN" ] && break
          done

          # 去重，產出 tokens.txt
          if [ -s tokens_raw.txt ]; then
            sort -u tokens_raw.txt > tokens.txt
          fi

          echo "---- tokens ----"
          cat tokens.txt || true

      # 逐顆發送（data-only），UNREGISTERED → 刪除該 token 文件
      - name: Send FCM to each token
        if: steps.decide.outputs.do_send == 'true'
        env:
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          UID: ${{ secrets.FIREBASE_UID }}
        run: |
          set -euo pipefail
          ACCESS_TOKEN="$(gcloud auth application-default print-access-token)"
          TS="${{ steps.decide.outputs.ts }}"
          BASE="https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents"

          if [ ! -s tokens.txt ]; then
            echo "No tokens to send."
            exit 0
          fi

          while IFS= read -r TOK; do
            [ -z "$TOK" ] && continue

            # 用 jq 組 payload，確保字元被正確 JSON escape
            jq -n \
              --arg tok "$TOK" \
              --arg ts  "$TS" \
              '{
                 message:{
                   token: $tok,
                   webpush:{
                     headers:{Urgency:"high", TTL:"1800"},
                     fcm_options:{link:"https://eyvind95.github.io/hello/apps/ledger/daily.html"}
                   },
                   data:{
                     title:"每日任務提醒",
                     body:"你還有未完成的每日任務喔！",
                     ts:$ts
                   }
                 }
               }' > payload.json

            HTTP_STATUS=$(curl -sS -o response.json -w "%{http_code}" \
              -H "Authorization: Bearer ${ACCESS_TOKEN}" \
              -H "Content-Type: application/json; charset=UTF-8" \
              "https://fcm.googleapis.com/v1/projects/${PROJECT_ID}/messages:send" \
              -d @payload.json)

            echo "[${TOK}] HTTP_STATUS=${HTTP_STATUS}"
            if [ ! -s response.json ] || ! head -c1 response.json | grep -q '{'; then echo '{}' > response.json; fi
            jq -r 'try .name // .error.message // empty' response.json || true

            # 回傳 UNREGISTERED → 刪 /daily/<uid>/tokens/<tokenId>
            if jq -e 'try .error.details[]? | select(.errorCode=="UNREGISTERED") | true catch false' response.json >/dev/null 2>&1; then
              ENCODED="$(printf '%s' "$TOK" | jq -sRr @uri)"
              echo "⚠️  Token 無效，刪除：$TOK"
              curl -sS -X DELETE -o /dev/null -w "%{http_code}" \
                -H "Authorization: Bearer ${ACCESS_TOKEN}" \
                -H "Content-Type: application/json; charset=UTF-8" \
                "${BASE}/daily/${UID}/tokens/${ENCODED}" || true
            fi
          done < tokens.txt

      - name: Skip push (no need)
        if: steps.decide.outputs.do_send != 'true'
        run: echo "Skip push：非今日或 pending==0 或缺資料"
