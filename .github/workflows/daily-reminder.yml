name: Daily reminder push

on:
  schedule:
    - cron: "0 12 * * *"   # 台北 20:00（UTC+8）
    - cron: "0 14 * * *"   # 台北 22:00（UTC+8）
  workflow_dispatch: {}

jobs:
  push:
    runs-on: ubuntu-latest

    steps:
      # 1) 以服務帳戶登入（建立 ADC 憑證檔供 gcloud / curl 使用）
      - name: Auth to Google
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      # 2) 安裝 gcloud 並設定專案
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.FIREBASE_PROJECT_ID }}

      # 3) 安裝 jq（解析 JSON 用）
      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      # 4) 讀取 Firestore：meta.pendingCount / meta.dayToken / meta.fcmToken
      - name: Read pendingCount & token from Firestore (REST)
        id: read_pending
        shell: bash
        run: |
          set -euo pipefail
          PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
          UID="${{ secrets.FIREBASE_UID }}"
          DOC_URL="https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/daily/${UID}"

          # 取 access token（ADC）
          ACCESS_TOKEN="$(gcloud auth application-default print-access-token)"

          # 讀文件（可能 404）
          HTTP_STATUS=$(curl -sS -o doc.json -w "%{http_code}" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json; charset=UTF-8" \
            "${DOC_URL}")

          echo "Firestore GET status=${HTTP_STATUS}"

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "pending="   >> $GITHUB_OUTPUT
            echo "dayToken="  >> $GITHUB_OUTPUT
            echo "fcm_token=" >> $GITHUB_OUTPUT
            exit 0
          fi

          PENDING="$(jq -r '.fields.meta.mapValue.fields.pendingCount.integerValue // empty' doc.json)"
          DAYTOKEN="$(jq -r '.fields.meta.mapValue.fields.dayToken.stringValue // empty'        doc.json)"
          FCM_TOKEN_DB="$(jq -r '.fields.meta.mapValue.fields.fcmToken.stringValue // empty'    doc.json)"

          echo "parsed pending='${PENDING}', dayToken='${DAYTOKEN}', fcmToken='${FCM_TOKEN_DB:0:16}...'"
          echo "pending=${PENDING}"   >> $GITHUB_OUTPUT
          echo "dayToken=${DAYTOKEN}" >> $GITHUB_OUTPUT
          echo "fcm_token=${FCM_TOKEN_DB}" >> $GITHUB_OUTPUT

      # 5) 決策：只有「今天」且「>0」才推
      - name: Decide to push?
        id: decide
        shell: bash
        run: |
          set -euo pipefail
          P="${{ steps.read_pending.outputs.pending }}"
          DT="${{ steps.read_pending.outputs.dayToken }}"
          TODAY="$(TZ=Asia/Taipei date +%Y-%m-%d)"

          # 預設不推
          DO=""

          if [ -n "$P" ] && [ -n "$DT" ]; then
            # 僅當 P 是數字且 >0，且 dayToken 是今天
            if [[ "$P" =~ ^[0-9]+$ ]] && [ "$P" -gt 0 ] && [ "$DT" = "$TODAY" ]; then
              DO="1"
            fi
          fi

          echo "do=${DO}" >> $GITHUB_OUTPUT
          echo "Decision: ${DO:+'PUSH'}${DO:='SKIP'} (pending='${P}', dayToken='${DT}', today='${TODAY}')"

      # 6) 組裝 FCM payload（只有要推時才做）
      - name: Build FCM payload
        if: ${{ steps.decide.outputs.do == '1' }}
        shell: bash
        run: |
          set -euo pipefail
          cat > payload.json <<'JSON'
          {
            "message": {
              "token": "${{ steps.read_pending.outputs.fcm_token || secrets.FCM_TOKEN }}",
              "notification": {
                "title": "每日任務提醒",
                "body": "你還有未完成的每日任務喔！"
              },
              "webpush": {
                "headers": {
                  "Urgency": "high",
                  "TTL": "300"
                },
                "fcm_options": {
                  "link": "https://eyvind95.github.io/hello/apps/ledger/daily.html"
                },
                "notification": {
                  "icon": "https://eyvind95.github.io/hello/apps/ledger/6.png?v=4",
                  "badge": "https://eyvind95.github.io/hello/apps/ledger/8.png?v=4",
                  "tag": "daily-reminder"
                }
              }
            }
          }
          JSON
          echo "Payload built:"
          cat payload.json

      # 7) 送出 FCM（只有要推時才做）
      - name: Send FCM HTTP v1
        if: ${{ steps.decide.outputs.do == '1' }}
        shell: bash
        run: |
          set -euo pipefail
          ACCESS_TOKEN="$(gcloud auth application-default print-access-token)"

          HTTP_STATUS=$(curl -sS -o response.json -w "%{http_code}" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json; charset=UTF-8" \
            "https://fcm.googleapis.com/v1/projects/${{ secrets.FIREBASE_PROJECT_ID }}/messages:send" \
            -d @payload.json)

          echo "HTTP_STATUS=${HTTP_STATUS}"
          echo "RESPONSE:"
          cat response.json

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "FCM send failed."
            exit 1
          fi

      # 8) 不需要推送時，給個清楚的記錄
      - name: Skip push (no need)
        if: ${{ steps.decide.outputs.do != '1' }}
        run: |
          echo "Skip push: pending='${{ steps.read_pending.outputs.pending }}'  dayToken='${{ steps.read_pending.outputs.dayToken }}'  today='$(TZ=Asia/Taipei date +%Y-%m-%d)'"
