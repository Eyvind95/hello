<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FCM 推播測試（每分鐘一次）</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
  <style>
    body{font-family:system-ui, "PingFang TC", "Noto Sans TC", sans-serif; padding:20px; background:#0b0b0b; color:#fff}
    button{padding:8px 12px; border-radius:10px; border:1px solid #2a2a2a; background:#1b1b1b; color:#fff; cursor:pointer; margin-right:8px}
    .ok{background:rgba(34,197,94,.14); border-color:#22c55e; color:#86efac}
    .danger{background:rgba(239,68,68,.14); border-color:#ef4444; color:#fda4af}
    code{word-break:break-all; display:block; background:#111; padding:10px; border-radius:8px; border:1px solid #2a2a2a}
  </style>
</head>
<body>
  <h1>FCM 推播測試</h1>
  <p>這頁會測三件事：<strong>(1) 通知授權</strong>、<strong>(2) 拿到 FCM Token</strong>、<strong>(3) 每分鐘本地通知</strong>。</p>

  <div style="margin:12px 0">
    <button id="btnEnable" class="ok">啟用推播 & 取得 Token</button>
    <button id="btnCopy">複製 Token</button>
    <button id="btnMin" class="ok">開始/停止 每分鐘本地通知</button>
  </div>

  <div>
    <div>目前 Token：</div>
    <code id="tokenBox">(尚未取得)</code>
  </div>

<script>
/** ---- 你的 Firebase 專案設定（與 daily.html 一樣） ---- */
const firebaseConfig = {
  apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
  authDomain: "eyvind95-182f0.firebaseapp.com",
  projectId: "eyvind95-182f0",
  storageBucket: "eyvind95-182f0.firebasestorage.app",
  messagingSenderId: "105770576221",
  appId: "1:105770576221:web:dd3a57ce4e051bda91a0b4"
};
firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();

/** ---- 你的 VAPID Public Key（你提供的這串） ---- */
const VAPID_KEY = "BHwAITz4c7tcvzHApW6ZzMU9DOIZ0ZpiKbufVx1Uq46io--d2mvbcVmve9_wsxFzaQrOapYpMOi0oNRsxmbgVPY";

const tokenBox = document.getElementById('tokenBox');
let localTimer = null;

/** 1) 註冊 SW（注意：檔名要正確 & 與本頁同層） */
let swReg = null;
async function ensureSW(){
  if (!('serviceWorker' in navigator)) throw new Error('此瀏覽器不支援 Service Worker');
  if (swReg) return swReg;
  // 檔名務必叫 firebase-messaging-sw.js
  swReg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
  return swReg;
}

/** 2) 啟用通知 + 拿 token */
async function enableAndGetToken(){
  await ensureSW();
  const perm = await Notification.requestPermission();
  if (perm !== 'granted') throw new Error('使用者未允許通知');

  // v8：把我們註冊的 SW 指給 messaging
  messaging.useServiceWorker(swReg);

  const token = await messaging.getToken({ vapidKey: VAPID_KEY });
  if (!token) throw new Error('無法取得 FCM Token');
  tokenBox.textContent = token;
  console.log('FCM Token:', token);
  alert('啟用成功！Token 已顯示。你可以到 Firebase Console > Cloud Messaging 用這個 Token 發測試訊息。');
}

/** 3) 每分鐘本地通知（不經過雲端，純測 UI/權限/SW） */
function toggleLocalMinute(){
  if (localTimer){
    clearInterval(localTimer); localTimer = null;
    alert('已停止每分鐘本地通知');
    return;
  }
  alert('開始每分鐘本地通知');
  localTimer = setInterval(async ()=>{
    const reg = await ensureSW();
    reg.showNotification('本地測試通知', {
      body: '每分鐘一次 ' + new Date().toLocaleTimeString(),
      icon: '../6.png',
      tag: 'local-minute-test'
    });
  }, 60*1000);
}

/** FCM 前景訊息（頁面開著時會觸發） */
messaging.onMessage((payload)=>{
  const title = payload.notification?.title || '前景通知';
  const body  = payload.notification?.body  || JSON.stringify(payload);
  new Notification(title, { body, icon:'../6.png' });
  console.log('onMessage:', payload);
});

/** 綁定按鈕 */
document.getElementById('btnEnable').onclick = ()=>enableAndGetToken().catch(e=>alert('失敗：' + e.message));
document.getElementById('btnCopy').onclick = ()=>{
  const t = tokenBox.textContent.trim();
  if(!t || t === '(尚未取得)'){ alert('還沒有 Token'); return; }
  navigator.clipboard.writeText(t).then(()=>alert('已複製 Token'));
};
document.getElementById('btnMin').onclick = toggleLocalMinute;
</script>
</body>
</html>
