<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>皮卡的每日任務</title>

<link rel="manifest" href="daily.webmanifest" />

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
:root{
  --bg:#0b0f17;
  --panel:#0e1726cc;
  --panel-strong:#0e1726;
  --border:#263041;
  --muted:#aab8d5;
  --ok:#71ffa5;
  --danger:#ff7b7b;
  --accent:#6ee7ff;
  --yellow:#ffd93b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:#fff;
  background:
    linear-gradient(rgba(0,0,0,.45), rgba(0,0,0,.45)),
    url("https://i.pinimg.com/736x/9e/79/c3/9e79c358e0914cd144e90a39f102e1cc.jpg") center/cover no-repeat fixed,
    var(--bg);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", "Helvetica Neue", Arial, sans-serif;
}
@media (max-width:768px){ body{ background-attachment:scroll; } }

.container{ max-width:1120px; margin:24px auto; padding:0 14px; }
header{
  display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  margin-bottom:12px;
}
.h1{
  font-size:22px; font-weight:800; letter-spacing:.06em;
  background:var(--panel); border:1px solid var(--border); padding:10px 12px; border-radius:14px;
}
.controls{
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  background:var(--panel); border:1px solid var(--border); padding:8px 10px; border-radius:14px;
}
.controls button{
  background:#172033; color:#fff; border:1px solid var(--border);
  padding:8px 10px; border-radius:10px; cursor:pointer;
}
.controls .muted{ color:var(--muted); font-size:14px; }
.controls .spacer{ flex:1 }

.grid{
  display:grid; gap:14px;
  grid-template-columns: 1fr 1fr;
}
@media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

.card{
  background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:14px; min-width:0;
}
.card .title{
  display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;
}
.title .left{ display:flex; align-items:center; gap:10px; }
.title img.icon{ width:28px; height:28px; border-radius:8px; object-fit:cover; }
.title .name{ font-weight:700; }
.badge{ font-size:12px; color:#000; background:var(--accent); padding:2px 8px; border-radius:999px; }

.row{ display:flex; align-items:center; gap:10px; margin:8px 0; }
.row .label{ color:var(--muted); min-width:112px; }
.row .val{ font-variant-numeric:tabular-nums; }
.row .next{ color:var(--yellow); }
.row .subtle{ color:var(--muted); font-size:13px; }

.kit{
  display:flex; align-items:center; gap:6px; flex-wrap:wrap;
}
.kit button{
  background:#18243c; border:1px solid var(--border); color:#fff;
  padding:6px 10px; border-radius:10px; cursor:pointer;
}
.kit .plus{ color:#10d17d; }   /* 綠色 + */
.kit .minus{ color:#ff6b6b; }  /* 紅色 - / 重置 */

.resinBox{
  background:#0b1220; border:1px solid var(--border); border-radius:12px; padding:8px 10px;
  display:inline-flex; align-items:center; gap:8px;
}
.resinBox .n{ font-weight:800; font-size:16px; color:#e6f2ff; } /* 永遠可讀色 */
.resinBox small{ color:var(--muted) }

hr.sep{ border:none; height:1px; background:var(--border); margin:10px 0; }

.checkbox{ display:flex; align-items:center; gap:8px; margin:6px 0; }
.checkbox input{ transform: translateY(1px); }

.footer-note{ color:var(--muted); font-size:13px; margin-top:8px; }
.warn{ color:#ffb7b7 }
.ok{ color:#98ffb7 }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="h1">皮卡的每日任務</div>
    <div class="controls" style="flex:1">
      <span class="muted" id="todayInfo">今天（05:00 作為換日點）</span>
      <div class="spacer"></div>
      <button id="loginBtn">登入 Google</button>
      <button id="logoutBtn" style="display:none;">登出</button>
      <span class="muted" id="who">(未登入：僅本機)</span>
    </div>
  </header>

  <div class="controls">
    <span>尚未完成每日：<b id="pendingCount">0</b> 個</span>
    <div class="spacer"></div>
    <span class="muted">版本更新前兩天會顯示 ⚠️ 提醒</span>
  </div>

  <div class="grid" id="cards"><!-- 動態卡片 --></div>

  <p class="footer-note">
    ※ 週六、週日才顯示《貓咪大戰爭》的「週末關卡」，每天 05:00 重置。<br>
    ※ 絕區零電池：按「+80」增加，滿 960 會自動回到 240（綠＝增加、紅＝重置）。<br>
    ※ 原神樹脂：每 8 分鐘 +1；數字永遠可讀色。<br>
  </p>
</div>

<script>
/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
  authDomain: "eyvind95-182f0.firebaseapp.com",
  projectId: "eyvind95-182f0",
  storageBucket: "eyvind95-182f0.firebasestorage.app",
  messagingSenderId: "105770576221",
  appId: "1:105770576221:web:dd3a57ce4e051bda91a0b4"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
const db = firebase.firestore();
let CURRENT_UID = null;
function userDoc(){ return db.collection('users').doc(CURRENT_UID); }

/* ---------------- helpers ---------------- */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));

const STATE_KEY = "daily_state_v1";

const ICONS = {
  gj:  "../data/a.jpg", // 原神
  sr:  "../data/b.jpg", // 星穹
  zzz: "../data/c.png",
  hoyo:"../data/d.png",
  cat: "../data/e.jpg",
  pogo:"../data/f.jpg",
  noted:"../data/g.jpg",
  nsr: "../data/h.jpg"
};

function ymd(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function today5(){
  const now = new Date();
  const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 5, 0, 0);
  return { now, base };
}
function isWeekend(d=new Date()){ const w=d.getDay(); return w===0||w===6; }

/* 每月 1 與 1/16 */
function nextAbyss(ref){ const d=new Date(ref); const day=d.getDate(); if(day<=1){d.setDate(1);} else if(day<=16){d.setDate(16);} else {d.setMonth(d.getMonth()+1); d.setDate(1);} return ymd(d); }
function nextMonth1(ref){ const d=new Date(ref); if(d.getDate()<=1)d.setDate(1); else{ d.setMonth(d.getMonth()+1); d.setDate(1);} return ymd(d); }

/* ---------------- default state ---------------- */
function defaultState(){
  return {
    updatedAt: Date.now(),
    genshin_asia:{ resin:200, max:200, daily:false, abyssNext:nextAbyss(new Date()), chronicleNext:nextMonth1(new Date()), versionNext:"2025-10-22", round:{abyss:false,chronicle:false,version:false}},
    genshin_tw:  { resin:200, max:200, daily:false, abyssNext:nextAbyss(new Date()), chronicleNext:nextMonth1(new Date()), versionNext:"2025-10-22", round:{abyss:false,chronicle:false,version:false}},
    starrail:{
      daily:false,
      memoNext:"2025-10-27", ficNext:"2025-11-24", doomNext:"2025-11-10", arbNext:"2025-11-05", verNext:"2025-11-05",
      round:{memo:false, fic:false, doom:false, arb:false, ver:false}
    },
    zzz:{ daily:false, power:480, min:240, max:960 },
    hoyolab:{ daily:false },
    cat:{ weekend:false, lastReset:null },
    pogo:{ spin:false, catch:false },
    noted:{ daily:false },
    nsr:{ daily:false, coinRoll:0 }
  };
}

/* ---------------- storage ---------------- */
function loadLocal(){ try{ return JSON.parse(localStorage.getItem(STATE_KEY)||"{}"); }catch{ return {}; } }
function saveLocal(s){ localStorage.setItem(STATE_KEY, JSON.stringify(s)); }

async function cloudLoad(){ if(!CURRENT_UID) return null; const snap = await userDoc().collection('daily').doc('state').get(); return snap.exists ? snap.data() : null; }
async function cloudSave(s){ if(!CURRENT_UID) return; await userDoc().collection('daily').doc('state').set({...s,_updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}); }

async function loadUnified(){
  try{
    if(CURRENT_UID){
      const cloud = await cloudLoad();
      if(cloud){ saveLocal(cloud); return cloud; }
    }
  }catch(e){ console.warn("雲端讀取失敗，用本機", e); }
  const local = loadLocal();
  return Object.keys(local).length ? local : defaultState();
}
async function saveUnified(s){ saveLocal(s); try{ if(CURRENT_UID) await cloudSave(s); }catch(e){ console.warn("雲端儲存失敗，先留本機", e); } }

/* ---------------- daily reset 05:00 ---------------- */
function checkDailyReset(){
  const { now, base } = today5();
  const last = new Date(state.updatedAt||0);
  if(last < base){
    ["genshin_asia","genshin_tw"].forEach(k=> state[k].daily=false);
    state.starrail.daily=false; state.zzz.daily=false; state.hoyolab.daily=false;
    state.pogo.spin=false; state.pogo.catch=false; state.noted.daily=false; state.nsr.daily=false;
    state.cat.weekend=false; state.cat.lastReset=ymd(now);
  }
  state.updatedAt = Date.now();
}

/* ---------------- version warn ---------------- */
function versionWarningHtml(nextStr){
  try{
    const next = new Date(nextStr+"T00:00:00");
    const diff = Math.ceil((next - new Date())/86400000);
    if(diff<=2) return ` <span class="warn">⚠️ ${diff} 天後版本更新</span>`;
  }catch{}
  return "";
}

/* ---------------- resin timer ---------------- */
let resinTimer=null;
function startResinTimer(){
  if(resinTimer) clearInterval(resinTimer);
  resinTimer = setInterval(()=>{
    ["genshin_asia","genshin_tw"].forEach(key=>{
      const o = state[key];
      if(o.resin < o.max) o.resin += 1;
    });
    state.updatedAt = Date.now();
    saveUnified(state);
    render();
  }, 8*60*1000);
}

/* ---------------- ZZZ/NSR 行為 ---------------- */
function zzzAdd80(){
  const z=state.zzz; z.power = Math.min(z.max, z.power+80);
  if(z.power>=z.max) z.power=z.min; // 滿就回 240
}
function nsrCoinTick(){ state.nsr.coinRoll = (state.nsr.coinRoll+1)%3; }

/* ---------------- small utils ---------------- */
function getByPath(p){ return p.split(".").reduce((o,k)=>o&&o[k], state); }
function setByPath(p,fn){
  const seg=p.split("."); let o=state;
  for(let i=0;i<seg.length-1;i++) o=o[seg[i]];
  o[seg.at(-1)] = fn(o[seg.at(-1)]);
}

/* ---------------- render ---------------- */
let state = defaultState();

function checkbox(label, path){
  return `<label class="checkbox"><input type="checkbox" data-path="${path}"><span>${label}</span></label>`;
}
function cardHeader(name, icon, rightHtml=""){
  return `<div class="title"><div class="left"><img class="icon" src="${icon}" alt=""><div class="name">${name}</div></div><div>${rightHtml}</div></div>`;
}

function cardGenshin(name, icon, obj, baseKey){
  const warn = versionWarningHtml(obj.versionNext);
  return `<section class="card">
    ${cardHeader(name, icon, `<span class="badge">每日＋排程</span>`)}
    <div class="row">
      <div class="label">體力（樹脂）</div>
      <div class="resinBox"><span class="n">${obj.resin}</span><small>/ ${obj.max}</small></div>
      <div class="kit">
        <button class="minus" data-path="${baseKey}.resin-10">-10</button>
        <button class="minus" data-path="${baseKey}.resin-1">-1</button>
        <button class="plus"  data-path="${baseKey}.resin+1">+1</button>
        <button class="plus"  data-path="${baseKey}.resin+10">+10</button>
        <span class="subtle">（每 8 分鐘 +1）</span>
      </div>
    </div>
    ${checkbox("每日", `${baseKey}.daily`)}
    <hr class="sep">
    <div class="row"><div class="label">淵月螺旋（每月 1 & 16）</div>
      <div class="val next">${obj.abyssNext}</div>
      <div class="kit">
        ${checkbox("本輪狀態", `${baseKey}.round.abyss`)}
        <button class="plus" data-path="${baseKey}.abyssNext.step">推到下一次</button>
      </div>
    </div>
    <div class="row"><div class="label">劇詩（每月 1）</div>
      <div class="val next">${obj.chronicleNext}</div>
      <div class="kit">
        ${checkbox("本輪狀態", `${baseKey}.round.chronicle`)}
        <button class="plus" data-path="${baseKey}.chronicleNext.step">推到下一次</button>
      </div>
    </div>
    <div class="row"><div class="label">版本更新（42 天）</div>
      <div class="val next">${obj.versionNext}${warn}</div>
      <div class="kit">
        ${checkbox("本輪狀態", `${baseKey}.round.version`)}
        <button class="plus" data-path="${baseKey}.versionNext.step">推到下一次</button>
      </div>
    </div>
  </section>`;
}

function cardStarRail(){
  const s=state.starrail;
  const warn=versionWarningHtml(s.verNext);
  const row=(label,key,next)=>`
    <div class="row">
      <div class="label">${label}（42 天）</div>
      <div class="val next">${next}</div>
      <div class="kit">
        ${checkbox("本輪已完成", `starrail.round.${key}`)}
        <button class="plus" data-path="starrail.${key}Next.step">推到下一次</button>
      </div>
    </div>`;
  return `<section class="card">
    ${cardHeader("崩壞：星穹鐵道", ICONS.sr, `<span class="badge">每日＋42天排程</span>`)}
    ${checkbox("每日", "starrail.daily")}
    <hr class="sep">
    ${row("混沌回憶","memo", s.memoNext)}
    ${row("虛構敘事","fic", s.ficNext)}
    ${row("末日幻影","doom", s.doomNext)}
    ${row("異相仲裁","arb", s.arbNext)}
    <div class="row">
      <div class="label">版本更新（42 天）</div>
      <div class="val next">${s.verNext}${warn}</div>
      <div class="kit">
        ${checkbox("本輪已完成", "starrail.round.ver")}
        <button class="plus" data-path="starrail.verNext.step">推到下一次</button>
      </div>
    </div>
  </section>`;
}

function cardZZZ(){
  const z=state.zzz; const willReset=(z.power+80)>=z.max;
  return `<section class="card">
    ${cardHeader("絕區零", ICONS.zzz, `<span class="badge">每日＋電池</span>`)}
    ${checkbox("每日", "zzz.daily")}
    <div class="row">
      <div class="label">電力（懶人版）</div>
      <div class="val">${z.power} / ${z.max}（底 ${z.min}）</div>
      <div class="kit">
        <button class="${willReset?'minus':'plus'}" data-path="zzz.plus">${willReset?'滿 → 回到 240':'+80'}</button>
      </div>
      <div class="subtle">滿 960 會自動回到 240</div>
    </div>
  </section>`;
}

function cardCat(){
  return `<section class="card">
    ${cardHeader("貓咪大戰爭", ICONS.cat, `<span class="badge">週末關卡</span>`)}
    ${checkbox("週末關卡（僅週六/週日顯示）", "cat.weekend")}
    <div class="subtle">每天 05:00 重置</div>
  </section>`;
}

function cardNSR(){
  const n=state.nsr;
  return `<section class="card">
    ${cardHeader("新世界狂歡", ICONS.nsr, `<span class="badge">每日＋金幣卷</span>`)}
    ${checkbox("每日", "nsr.daily")}
    <div class="row">
      <div class="label">金幣卷（3 天一輪）</div>
      <div class="val">${n.coinRoll} / 3</div>
      <div class="kit"><button class="plus" data-path="nsr.coin">+1（滿即歸 0）</button></div>
    </div>
  </section>`;
}

function cardSimple(name, icon, rows){ return `<section class="card">${cardHeader(name,icon)}${rows.join("")}</section>`; }

function render(){
  checkDailyReset();
  $("#todayInfo").textContent = `今天（05:00 作為換日點）`;

  let pending=0;
  function need(b){ if(!b) pending++; }

  const out=[];

  out.push(cardGenshin("原神（亞服）", ICONS.gj, state.genshin_asia, "genshin_asia"));
  need(state.genshin_asia.daily);
  out.push(cardGenshin("原神（台服）", ICONS.gj, state.genshin_tw, "genshin_tw"));
  need(state.genshin_tw.daily);

  out.push(cardStarRail());  need(state.starrail.daily);
  out.push(cardZZZ());       need(state.zzz.daily);
  out.push(cardSimple("HoYoLAB", ICONS.hoyo, [checkbox("每日","hoyolab.daily")]));
  out.push(cardSimple("Pokémon GO", ICONS.pogo, [checkbox("轉一個補給站","pogo.spin"), checkbox("捉一隻寶可夢","pogo.catch")]));
  out.push(cardSimple("諾提里森", ICONS.noted, [checkbox("每日","noted.daily")]));
  out.push(cardNSR());
  if(isWeekend()) out.push(cardCat());

  $("#cards").innerHTML = out.join("");

  // 綁定勾選
  $$("#cards input[data-path]").forEach(el=>{
    const v = getByPath(el.dataset.path)===true;
    el.checked = v;
    el.addEventListener("change", ()=>{
      setByPath(el.dataset.path, old=>!old);
      state.updatedAt=Date.now(); saveUnified(state); render();
    });
  });

  // 綁定按鈕
  $$("#cards button[data-path]").forEach(btn=>{
    const p=btn.dataset.path;
    btn.addEventListener("click", ()=>{
      if(p==="zzz.plus"){ zzzAdd80(); }
      else if(p.endsWith(".resin+1"))  setByPath(p.split(".").slice(0,-1).join("."), o=>{o.resin=Math.min(o.max,o.resin+1); return o;});
      else if(p.endsWith(".resin+10")) setByPath(p.split(".").slice(0,-1).join("."), o=>{o.resin=Math.min(o.max,o.resin+10); return o;});
      else if(p.endsWith(".resin-1"))  setByPath(p.split(".").slice(0,-1).join("."), o=>{o.resin=Math.max(0,o.resin-1); return o;});
      else if(p.endsWith(".resin-10")) setByPath(p.split(".").slice(0,-1).join("."), o=>{o.resin=Math.max(0,o.resin-10); return o;});
      else if(p.endsWith(".step")){
        const path=p.replace(".step","");
        const base=path.split(".")[0];
        // 推下一次
        const cur=getByPath(path); const dt=new Date(cur+"T00:00:00");
        if(path.includes("abyss"))       setByPath(path, _=> nextAbyss(addDays(dt,1)));
        else if(path.includes("chroni")) setByPath(path, _=> nextMonth1(addDays(dt,1)));
        else                             setByPath(path, _=> ymd(addDays(dt,42)));
        // 把「本輪已完成」/「本輪狀態」清掉
        if(base==="genshin_asia"||base==="genshin_tw"){
          if(path.includes("abyss")) setByPath(base+".round.abyss", _=>false);
          else if(path.includes("chroni")) setByPath(base+".round.chronicle", _=>false);
          else setByPath(base+".round.version", _=>false);
        }else if(base==="starrail"){
          if(path.includes("memo")) setByPath("starrail.round.memo", _=>false);
          else if(path.includes("fic")) setByPath("starrail.round.fic", _=>false);
          else if(path.includes("doom")) setByPath("starrail.round.doom", _=>false);
          else if(path.includes("arb")) setByPath("starrail.round.arb", _=>false);
          else setByPath("starrail.round.ver", _=>false);
        }
      }
      state.updatedAt=Date.now(); saveUnified(state); render();
    });
  });

  $("#pendingCount").textContent = String(pending);
}

/* ---------------- auth ---------------- */
async function googleLogin(){
  try{
    await firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
  }catch(e){
    if(["auth/operation-not-supported-in-this-environment","auth/popup-blocked","auth/popup-closed-by-user"].includes(e.code||"")){
      await firebase.auth().signInWithRedirect(new firebase.auth.GoogleAuthProvider());
    }else{
      alert("Google 登入失敗：" + e.message);
    }
  }
}
async function googleLogout(){ await firebase.auth().signOut(); }

$("#loginBtn").addEventListener("click", googleLogin);
$("#logoutBtn").addEventListener("click", googleLogout);

firebase.auth().onAuthStateChanged(async (user)=>{
  if(user){
    CURRENT_UID=user.uid;
    $("#who").textContent = `已登入：${user.email||"Google 帳號"}`;
    $("#loginBtn").style.display="none"; $("#logoutBtn").style.display="";
    const cloud=await cloudLoad(); const local=loadLocal();
    state = cloud || local || defaultState();
    if(!cloud && local) await cloudSave(state);
  }else{
    CURRENT_UID=null;
    $("#who").textContent="(未登入：僅本機)";
    $("#loginBtn").style.display=""; $("#logoutBtn").style.display="none";
    state = loadLocal(); if(!Object.keys(state).length) state=defaultState();
  }
  render();
});

/* ---------------- boot ---------------- */
(async()=>{
  state = await loadUnified();
  render();
  startResinTimer();
})();

/* ---------------- SW ---------------- */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
}
</script>
</body>
</html>
