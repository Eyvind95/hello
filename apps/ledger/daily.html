<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ¯æ—¥ä»»å‹™</title>

<!-- Firebase v8ï¼ˆç©©å®šï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
  :root{
    --bg:#0b0b0b;
    --panel:#151515cc;
    --muted:#bbbbbb;
    --accent:#6ee7ff;
    --danger:#ff7b7b;
    --ok:#8cff9c;
    --border:#2a2a2a;
    --tile:#101010;
  }
  *{box-sizing:border-box}
  html,body{height:100%;}
  body{
    margin:0; color:#fff;
    background:
      linear-gradient(rgba(0,0,0,0.38),rgba(0,0,0,0.38)),
      url("./6.png") center/cover no-repeat fixed,
      var(--bg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC","Noto Sans TC","Microsoft JhengHei","Helvetica Neue", Arial, sans-serif;
  }
  @media (max-width:768px){ body{ background-attachment:scroll; } }

  .container{ max-width:1100px; margin:32px auto; padding:0 16px; }
  header{
    display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px;
  }
  h1{font-size:28px; margin:0;}
  .controls{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    background:var(--panel); padding:10px 12px; border:1px solid var(--border); border-radius:14px;
  }
  .controls button{
    background:#202020; color:#fff; border:1px solid var(--border); padding:8px 10px; border-radius:10px; outline:none; cursor:pointer;
  }
  .controls button:hover{filter:brightness(1.12);}
  .muted{color:var(--muted)}
  .spacer{flex:1}

  .row{
    display:grid; gap:16px;
    grid-template-columns: 1.11fr 1.35fr; /* æ‰‹æ©Ÿæœƒè®Š 1 æ¬„ */
  }
  .row > *{ min-width:0; }
  @media (max-width:900px){ .row{ grid-template-columns:1fr; } }

  .card{ background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:16px; min-width:0; }
  .card h2{margin:0 0 10px 0; font-size:20px;}

  .game { padding:0; overflow:hidden; }
  .game-hd{ display:flex; gap:12px; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border); background:rgba(0,0,0,0.2);}
  .icon{ width:44px; height:44px; border-radius:10px; object-fit:cover; border:1px solid var(--border);}
  .title .name{ font-weight:700; }
  .title .sub{ color:var(--muted); font-size:13px; }

  .game-body{ padding:14px 16px; display:flex; flex-direction:column; gap:8px; }
  .g-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 0; }
  .g-left{ font-weight:600;}
  .g-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .sep{ border:none; border-top:1px solid var(--border); margin:6px 0; }

  .ck{ display:inline-flex; align-items:center; gap:6px; }
  .ck input[type="checkbox"]{ width:18px; height:18px; }

  .pill{
    background:var(--tile); border:1px solid var(--border); border-radius:12px; padding:6px 10px; font-size:13px; color:#fff;
  }
  .hint{ font-size:12px; color:var(--muted); }

  .num{
    display:inline-flex; align-items:center; gap:6px;
    background:var(--tile); border:1px solid var(--border); border-radius:10px; padding:4px 8px;
  }
  .num input{ width:72px; background:transparent; border:none; color:#fff; font-weight:700; text-align:right; outline:none; }
  .num button{ background:#2a2a2a; border:1px solid var(--border); color:#fff; padding:4px 8px; border-radius:8px; cursor:pointer; }
  .num button:hover{filter:brightness(1.12);}

  .grid2{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
  @media (max-width:600px){ .grid2{ grid-template-columns:1fr; } }

  .tile{ background:#101010; border:1px solid var(--border); border-radius:14px; padding:14px; }
  .tile h3{ margin:0 0 8px; font-size:16px; color:var(--muted) }

  /* æœªå®Œæˆæ‘˜è¦æ¢ */
  .summary{
    display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    margin: 10px 0 4px 0;
  }
  .tag-ok{ color:var(--ok); }
  .tag-ng{ color:var(--danger); }

  .footer-note{ margin-top:12px; font-size:12px; color:var(--muted); }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>æ¯æ—¥ä»»å‹™</h1>
    <div class="controls">
      <button id="btnNotify">é–‹å•Ÿæé†’ï¼ˆ20:00 / 22:00ï¼‰</button>
      <div class="spacer"></div>
      <button id="btnLogin">Google ç™»å…¥</button>
      <button id="btnLogout" style="display:none">ç™»å‡º</button>
      <span id="who" class="muted">(æœªç™»å…¥ï¼šåƒ…æœ¬æ©Ÿ)</span>
    </div>
  </header>

  <div class="summary">
    <div class="tile"><h3>æœªå®Œæˆæ¯æ—¥</h3><div id="pendingDaily" class="pill">â€”</div></div>
    <div class="tile"><h3>æœ€è¿‘ç‰ˆæœ¬æé†’</h3><div id="upcomingVer" class="pill">â€”</div></div>
  </div>

  <div class="row">
    <!-- å·¦æ¬„ï¼šå››æ¬¾ -->
    <div class="col">

      <!-- åŸç¥ -->
      <section id="gs" class="game card">
        <div class="game-hd">
          <img src="./a.jpg" class="icon" alt="Genshin">
          <div class="title">
            <div class="name">åŸç¥</div>
            <div class="sub">å…©å¸³ï¼ˆäºæœï¼å°æœï¼‰ã€é«”åŠ› 8 åˆ†é˜ +1ï¼ˆMax 200ï¼‰</div>
          </div>
        </div>
        <div class="game-body">
          <!-- Resin å…±ç”¨æ§åˆ¶ -->
          <div class="g-row">
            <div class="g-left">é«”åŠ›ï¼ˆæ¨¹è„‚ï¼‰</div>
            <div class="g-right">
              <div class="num">
                <button data-act="gsResinDec10">-10</button>
                <button data-act="gsResinDec1">-1</button>
                <input id="gs_resin" type="number" step="1" min="0" max="200">
                <span>/ 200</span>
                <button data-act="gsResinInc1">+1</button>
                <button data-act="gsResinInc10">+10</button>
              </div>
              <span class="hint" id="gs_resin_hint">â€”</span>
            </div>
          </div>
          <hr class="sep">

          <!-- äºæœ -->
          <div class="tile">
            <h3>äºæœ</h3>
            <div class="g-row">
              <div class="g-left ck"><input id="gs_asia_daily" type="checkbox"><span>æ¯æ—¥ä»»å‹™</span></div>
              <div class="g-right hint" id="gs_asia_daily_hint">â€”</div>
            </div>
            <div class="g-row">
              <div class="g-left ck"><input id="gs_asia_abyss" type="checkbox"><span>æ·µæœˆèºæ—‹ï¼ˆæ¯æœˆ 1 & 16ï¼‰</span></div>
              <div class="g-right"><span>æœ¬è¼ªç‹€æ…‹</span></div>
            </div>
            <div class="g-row">
              <div class="g-left ck"><input id="gs_asia_theater" type="checkbox"><span>åŠ‡è©©ï¼ˆæ¯æœˆ 1ï¼‰</span></div>
              <div class="g-right"><span>æœ¬è¼ªç‹€æ…‹</span></div>
            </div>
          </div>

          <!-- å°æœ -->
          <div class="tile">
            <h3>å°æœ</h3>
            <div class="g-row">
              <div class="g-left ck"><input id="gs_tw_daily" type="checkbox"><span>æ¯æ—¥ä»»å‹™</span></div>
              <div class="g-right hint" id="gs_tw_daily_hint">â€”</div>
            </div>
            <div class="g-row">
              <div class="g-left ck"><input id="gs_tw_abyss" type="checkbox"><span>æ·µæœˆèºæ—‹ï¼ˆæ¯æœˆ 1 & 16ï¼‰</span></div>
              <div class="g-right"><span>æœ¬è¼ªç‹€æ…‹</span></div>
            </div>
            <div class="g-row">
              <div class="g-left ck"><input id="gs_tw_theater" type="checkbox"><span>åŠ‡è©©ï¼ˆæ¯æœˆ 1ï¼‰</span></div>
              <div class="g-right"><span>æœ¬è¼ªç‹€æ…‹</span></div>
            </div>
          </div>

          <div class="g-row">
            <div class="g-left">ç‰ˆæœ¬æ›´æ–°ï¼ˆ42 å¤©ï¼‰</div>
            <div class="g-right">
              <span>ä¸‹æ¬¡ï¼š</span><span id="gs_ver_next" class="pill">â€”</span>
              <span class="hint">å°‡åœ¨å…©å¤©å‰æé†’</span>
            </div>
          </div>
        </div>
      </section>

      <!-- çµ•å€é›¶ -->
      <section id="zzz" class="game card">
        <div class="game-hd">
          <img src="./c.png" class="icon" alt="ZZZ">
          <div class="title"><div class="name">çµ•å€é›¶</div><div class="sub">æ¯æ—¥ã€é«”åŠ›ï¼ˆæ”¶å– +80ï¼›æ»¿ 960 å›åˆ° 240ï¼‰</div></div>
        </div>
        <div class="game-body">
          <div class="g-row">
            <div class="g-left ck"><input id="zzz_daily" type="checkbox"><span>æ¯æ—¥</span></div>
            <div class="g-right hint" id="zzz_daily_hint">â€”</div>
          </div>
          <div class="g-row">
            <div class="g-left">é«”åŠ›</div>
            <div class="g-right">
              <div class="num">
                <button id="zzz_claim" class="pill">æ”¶å– +80</button>
                <input id="zzz_energy" type="number" step="10">
                <span>(240~960)</span>
                <button id="zzz_reset" class="pill">æ»¿äº†é‡ç½®åˆ° 240</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Hoyolab -->
      <section id="hoyo" class="game card">
        <div class="game-hd">
          <img src="./d.png" class="icon" alt="HoYoLAB">
          <div class="title"><div class="name">HoYoLAB</div><div class="sub">æ¯æ—¥</div></div>
        </div>
        <div class="game-body">
          <div class="g-row">
            <div class="g-left ck"><input id="hoyo_daily" type="checkbox"><span>æ¯æ—¥</span></div>
            <div class="g-right hint" id="hoyo_daily_hint">â€”</div>
          </div>
        </div>
      </section>

      <!-- è²“å’ªå¤§æˆ°çˆ­ -->
      <section id="cats" class="game card">
        <div class="game-hd">
          <img src="./e.jpg" class="icon" alt="è²“å’ªå¤§æˆ°çˆ­">
          <div class="title"><div class="name">è²“å’ªå¤§æˆ°çˆ­</div><div class="sub">æ¯æ—¥ã€é€±æœ«é—œå¡ï¼ˆå…­/æ—¥ï¼‰</div></div>
        </div>
        <div class="game-body">
          <div class="g-row">
            <div class="g-left ck"><input id="cats_daily" type="checkbox"><span>æ¯æ—¥</span></div>
            <div class="g-right hint" id="cats_daily_hint">â€”</div>
          </div>
          <div class="g-row">
            <div class="g-left ck"><input id="cats_weekend" type="checkbox"><span>é€±æœ«é—œå¡</span></div>
            <div class="g-right hint">æ¯é€¢å…­/æ—¥æ‰é¡¯ç¤ºæé†’ï¼Œä¸¦æ¯å¤©é‡ç½®ä¸€æ¬¡</div>
          </div>
        </div>
      </section>

    </div>

    <!-- å³æ¬„ï¼šå››æ¬¾ -->
    <div class="col">

      <!-- å´©å£ï¼šæ˜Ÿç©¹éµé“ -->
      <section id="hsr" class="game card">
        <div class="game-hd">
          <img src="./b.jpg" class="icon" alt="HSR">
          <div class="title"><div class="name">å´©å£ï¼šæ˜Ÿç©¹éµé“</div><div class="sub">æ¯æ—¥ + 42 å¤©å¾ªç’°ï¼ˆæ··æ²Œ/è™›æ§‹/æœ«æ—¥/ä»²è£/ç‰ˆæœ¬ï¼‰</div></div>
        </div>
        <div class="game-body">
          <div class="g-row">
            <div class="g-left ck"><input id="hsr_daily" type="checkbox"><span>æ¯æ—¥</span></div>
            <div class="g-right hint" id="hsr_daily_hint">â€”</div>
          </div>
          <hr class="sep">
          <div class="g-row">
            <div class="g-left">æ··æ²Œå›æ†¶ï¼ˆ42 å¤©ï¼‰</div>
            <div class="g-right">
              <span>ä¸‹æ¬¡ï¼š</span><span id="hsr_chaos_next" class="pill">â€”</span>
              <label class="ck"><input id="hsr_chaos_done" type="checkbox"><span>æœ¬è¼ªå·²å®Œæˆ</span></label>
            </div>
          </div>
          <div class="g-row">
            <div class="g-left">è™›æ§‹æ•˜äº‹ï¼ˆ42 å¤©ï¼‰</div>
            <div class="g-right">
              <span>ä¸‹æ¬¡ï¼š</span><span id="hsr_fiction_next" class="pill">â€”</span>
              <label class="ck"><input id="hsr_fiction_done" type="checkbox"><span>æœ¬è¼ªå·²å®Œæˆ</span></label>
            </div>
          </div>
          <div class="g-row">
            <div class="g-left">æœ«æ—¥å¹»å½±ï¼ˆ42 å¤©ï¼‰</div>
            <div class="g-right">
              <span>ä¸‹æ¬¡ï¼š</span><span id="hsr_apoc_next" class="pill">â€”</span>
              <label class="ck"><input id="hsr_apoc_done" type="checkbox"><span>æœ¬è¼ªå·²å®Œæˆ</span></label>
            </div>
          </div>
          <div class="g-row">
            <div class="g-left">ç•°ç›¸ä»²è£ï¼ˆ42 å¤©ï¼‰</div>
            <div class="g-right">
              <span>ä¸‹æ¬¡ï¼š</span><span id="hsr_arbi_next" class="pill">â€”</span>
              <label class="ck"><input id="hsr_arbi_done" type="checkbox"><span>æœ¬è¼ªå·²å®Œæˆ</span></label>
            </div>
          </div>
          <div class="g-row">
            <div class="g-left">ç‰ˆæœ¬æ›´æ–°ï¼ˆ42 å¤©ï¼‰</div>
            <div class="g-right">
              <span>ä¸‹æ¬¡ï¼š</span><span id="hsr_ver_next" class="pill">â€”</span>
              <span class="hint">æœƒæ–¼å…©å¤©å‰æé†’</span>
            </div>
          </div>
        </div>
      </section>

      <!-- PokÃ©mon GO -->
      <section id="pogo" class="game card">
        <div class="game-hd">
          <img src="./f.jpg" class="icon" alt="PokÃ©mon GO">
          <div class="title"><div class="name">PokÃ©mon GO</div><div class="sub">å…©é …æ¯æ—¥</div></div>
        </div>
        <div class="game-body">
          <div class="g-row"><div class="g-left ck"><input id="pogo_spin" type="checkbox"><span>è½‰ä¸€å€‹è£œçµ¦ç«™</span></div><div class="g-right hint" id="pogo_spin_hint">â€”</div></div>
          <div class="g-row"><div class="g-left ck"><input id="pogo_catch" type="checkbox"><span>æ‰ä¸€éš»å¯¶å¯å¤¢</span></div><div class="g-right hint" id="pogo_catch_hint">â€”</div></div>
        </div>
      </section>

      <!-- è«¾æé‡Œæ£® -->
      <section id="noti" class="game card">
        <div class="game-hd">
          <img src="./g.jpg" class="icon" alt="è«¾æé‡Œæ£®">
          <div class="title"><div class="name">è«¾æé‡Œæ£®</div><div class="sub">æ¯æ—¥</div></div>
        </div>
        <div class="game-body">
          <div class="g-row">
            <div class="g-left ck"><input id="noti_daily" type="checkbox"><span>æ¯æ—¥</span></div>
            <div class="g-right hint" id="noti_daily_hint">â€”</div>
          </div>
        </div>
      </section>

      <!-- æ–°ä¸–ç•Œç‹‚æ­¡ -->
      <section id="nsfw" class="game card">
        <div class="game-hd">
          <img src="./h.jpg" class="icon" alt="æ–°ä¸–ç•Œç‹‚æ­¡">
          <div class="title"><div class="name">æ–°ä¸–ç•Œç‹‚æ­¡</div><div class="sub">æ¯æ—¥ã€é‡‘å¹£å·ï¼ˆ3 å¤©ä¸€è¼ªï¼‰</div></div>
        </div>
        <div class="game-body">
          <div class="g-row">
            <div class="g-left ck"><input id="nsfw_daily" type="checkbox"><span>æ¯æ—¥</span></div>
            <div class="g-right hint" id="nsfw_daily_hint">â€”</div>
          </div>
          <div class="g-row">
            <div class="g-left">é‡‘å¹£å·ï¼ˆ3 å¤©ï¼‰</div>
            <div class="g-right">
              <span class="pill" id="nsfw_ticket_ctr">0 / 3</span>
              <button id="nsfw_ticket_inc" class="pill">å®Œæˆ +1</button>
              <button id="nsfw_ticket_reset" class="pill">æ­¸ 0</button>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <p class="footer-note">æ¯æ—¥é‡ç½®æ™‚é–“ï¼š<b>05:00</b>ï¼ˆæœ¬åœ°æ™‚å€ï¼‰ã€‚æ¨æ’­å°‡æ–¼ <b>20:00</b> èˆ‡ <b>22:00</b> æé†’å°šæœªå®Œæˆçš„æ¯æ—¥ï¼›ç‰ˆæœ¬æ›´æ–°é …ç›®åœ¨ <b>å‰å…©å¤©</b> æé†’ã€‚</p>
</div>

<script>
/* ================= Firebaseï¼ˆè«‹æ›¿æ›ç‚ºä½ çš„ daily å°ˆæ¡ˆï¼‰ ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
  authDomain: "eyvind95-182f0.firebaseapp.com",
  projectId: "eyvind95-182f0",
  storageBucket: "eyvind95-182f0.firebasestorage.app",
  messagingSenderId: "105770576221",
  appId: "1:105770576221:web:dd3a57ce4e051bda91a0b4"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= å·¥å…· ================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function ymd(d){ return d.toISOString().slice(0,10); }
/* éŠæˆ²æ—¥éµï¼š05:00 å‰ç®—å‰ä¸€å¤©ï¼Œé¿å…è·¨æ—¥å‰å¾Œåˆ¤æ–·éŒ¯äº‚ */
function dayKey(dt=new Date()){
  const d = new Date(dt);
  if (d.getHours() < 5){ d.setDate(d.getDate()-1); }
  return ymd(d);
}
function inWeekend(d=new Date()){
  const w = d.getDay(); // 0 Sun ... 6 Sat
  return w === 0 || w === 6;
}
function addDays(yyyy_mm_dd, n){
  const d = new Date(yyyy_mm_dd + "T00:00:00");
  d.setDate(d.getDate()+n);
  return ymd(d);
}
function diffDays(a,b){ // b-a
  const A = new Date(a+"T00:00:00"), B = new Date(b+"T00:00:00");
  return Math.round((B-A)/86400000);
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

/* ================= ç‹€æ…‹ï¼ˆæœ¬æ©Ÿ or é›²ç«¯ï¼‰ ================= */
const LS_KEY = "daily_state_v1";

function defaultState(){
  const today = dayKey();
  return {
    lastKey: today,                 // ä¸Šæ¬¡åˆ·æ–°æ—¥
    gs: {
      resin: 160, resinStamp: Date.now(), // ç•¶å‰æ¨¹è„‚ã€æœ€å¾Œæ‰‹å‹•/è‡ªå‹•æ›´æ–°æ™‚é–“æˆ³
      verNext: "2025-10-22",
      asia:  { daily:{last:null}, abyss:{done:false}, theater:{done:false} },
      tw:    { daily:{last:null}, abyss:{done:false}, theater:{done:false} }
    },
    hsr: { // é è¨­ä¸‹ä¸€æ¬¡æŒ‰ä½ æä¾›
      daily:{last:null},
      chaos:{ next:"2025-10-27", done:false },
      fiction:{ next:"2025-11-24", done:false },
      apoc:{ next:"2025-11-10", done:false },
      arbi:{ next:"2025-11-05", done:false },
      ver:{ next:"2025-11-05" }
    },
    zzz: { daily:{last:null}, energy:480 }, // 240~960ï¼›å®Œæˆ +80ï¼Œæ»¿ 960 æ­¸ 240
    hoyo:{ daily:{last:null} },
    cats:{ daily:{last:null}, weekend:{last:null} },
    pogo:{ spin:{last:null}, catch:{last:null} },
    noti:{ daily:{last:null} },
    nsfw:{ daily:{last:null}, ticket:2 }, // 0~3ï¼Œé è¨­ 2/3ï¼ˆä½ èªªç¾åœ¨ 2/3ï¼‰
    notify:{ enabled:false }
  };
}

let STATE = null;
let CURRENT_UID = null;
let LOADING_CLOUD = false;

function loadLocal(){
  try{ const v = localStorage.getItem(LS_KEY); return v ? JSON.parse(v) : null; }catch{ return null; }
}
function saveLocal(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(STATE)); }catch{}
}
async function loadCloud(){
  const doc = await db.collection("users").doc(CURRENT_UID).collection("daily").doc("state").get();
  return doc.exists ? doc.data() : null;
}
async function saveCloud(){
  if(!CURRENT_UID) return;
  await db.collection("users").doc(CURRENT_UID).collection("daily").doc("state").set(STATE, {merge:false});
}
async function persist(){
  if(CURRENT_UID){ await saveCloud(); }
  else{ saveLocal(); }
}

/* ================= è‡ªå‹•é‡ç½®ï¼ˆæ¯æ—¥ 05:00ï¼‰ ================= */
function ensureDailyReset(){
  const cur = dayKey();
  if(STATE.lastKey === cur) return;

  // æ—¥å¸¸é¡å‹é€šé€šæ¸…æ‰ todayï¼ˆåªé‡ç½® lastï¼‰
  function resetDaily(obj){ if(obj && obj.last) obj.last = null; }

  resetDaily(STATE.gs.asia.daily);
  resetDaily(STATE.gs.tw.daily);
  resetDaily(STATE.hsr.daily);
  resetDaily(STATE.zzz.daily);
  resetDaily(STATE.hoyo.daily);
  resetDaily(STATE.cats.daily);
  STATE.cats.weekend.last = null;
  resetDaily(STATE.pogo.spin);
  resetDaily(STATE.pogo.catch);
  resetDaily(STATE.noti.daily);
  resetDaily(STATE.nsfw.daily);
  // ç‰ˆæœ¬ï¼å¾ªç’°é¡ä¸æ¸…

  STATE.lastKey = cur;
}

/* ================= åŸç¥æ¨¹è„‚è‡ªå‹•å›å¾©ï¼ˆ8 åˆ†é˜ +1ï¼Œä¸Šé™ 200ï¼‰ ================= */
function tickResinAuto(){
  const now = Date.now();
  const elapsed = Math.floor((now - STATE.gs.resinStamp)/60000); // åˆ†
  if(elapsed <= 0) return;
  const inc = Math.floor(elapsed / 8);
  if(inc>0){
    STATE.gs.resin = clamp(STATE.gs.resin + inc, 0, 200);
    STATE.gs.resinStamp = STATE.gs.resinStamp + inc*8*60000;
  }
}

/* ================= å´©éµï¼åŸç¥ï¼šå¾ªç’°èˆ‡æœˆæ›´è¦å‰‡ ================= */
function isAbyssResetToday(date = new Date()){ // æ¯æœˆ 1 & 16
  const d = new Date(date);
  const mday = d.getDate();
  return mday === 1 || mday === 16;
}
function isTheaterResetToday(date = new Date()){ // æ¯æœˆ 1
  return (new Date(date)).getDate() === 1;
}

/* ================= æ¨æ’­èˆ‡æé†’ ================= */
function scheduleNotificationAt(hour, minute, tag, title, body){
  if(!("Notification" in window)) return;
  if(Notification.permission !== "granted") return;

  const now = new Date();
  const t = new Date();
  t.setHours(hour, minute, 0, 0);
  if(t < now) t.setDate(t.getDate()+1);
  const ms = t.getTime() - now.getTime();
  setTimeout(()=> {
    new Notification(title, { body, tag });
  }, ms);
}

function refreshPending(){
  // è¨ˆç®—ã€Œæœªå®Œæˆæ¯æ—¥ã€æ•¸
  const today = dayKey();
  let cnt = 0;
  function notDone(obj){ return !(obj && obj.last === today); }

  if(notDone(STATE.gs.asia.daily)) cnt++;
  if(notDone(STATE.gs.tw.daily)) cnt++;
  if(notDone(STATE.hsr.daily)) cnt++;
  if(notDone(STATE.zzz.daily)) cnt++;
  if(notDone(STATE.hoyo.daily)) cnt++;
  if(notDone(STATE.cats.daily)) cnt++;
  if(inWeekend() && notDone(STATE.cats.weekend)) cnt++;
  if(notDone(STATE.pogo.spin)) cnt++;
  if(notDone(STATE.pogo.catch)) cnt++;
  if(notDone(STATE.noti.daily)) cnt++;
  if(notDone(STATE.nsfw.daily)) cnt++;

  $("#pendingDaily").textContent = cnt === 0 ? "å…¨éƒ¨å®Œæˆ ğŸ‰" : `${cnt} é …æœªå®Œæˆ`;
}

/* ç‰ˆæœ¬æ›´æ–°å…©å¤©å‰æé†’ï¼ˆGS/HSRï¼‰ */
function refreshVersionRemind(){
  const today = ymd(new Date());
  const list = [];

  if(STATE.gs.verNext){
    const d = diffDays(today, STATE.gs.verNext);
    if(d === 2) list.push(`åŸç¥ç‰ˆæœ¬å°‡æ–¼ ${STATE.gs.verNext} æ›´æ–°`);
  }
  if(STATE.hsr.ver && STATE.hsr.ver.next){
    const d = diffDays(today, STATE.hsr.ver.next);
    if(d === 2) list.push(`å´©éµç‰ˆæœ¬å°‡æ–¼ ${STATE.hsr.ver.next} æ›´æ–°`);
  }
  $("#upcomingVer").textContent = list.length ? list.join("ã€") : "â€”";
}

/* ================= ç¶å®šï¼šUI <-> STATE ================= */
function bindDailyCheckbox(elId, obj){
  const el = document.getElementById(elId);
  const hint = document.getElementById(elId + "_hint");
  const today = dayKey();
  el.checked = obj.last === today;
  if(hint) hint.textContent = el.checked ? "ä»Šå¤©å·²å®Œæˆ" : "ä»Šå¤©æœªå®Œæˆ";
  el.onchange = async () => {
    obj.last = el.checked ? today : null;
    await persist();
    refreshPending();
    if(hint) hint.textContent = el.checked ? "ä»Šå¤©å·²å®Œæˆ" : "ä»Šå¤©æœªå®Œæˆ";
  };
}
function bindFlag(elId, objKeyPath){ // 42å¤©æœ¬è¼ªå®Œæˆå‹¾å‹¾
  const el = document.getElementById(elId);
  const node = objKeyPath.reduce((acc,k)=>acc[k], STATE);
  el.checked = !!node.done;
  el.onchange = async ()=>{ node.done = el.checked; await persist(); };
}
function setText(id, txt){ const el = document.getElementById(id); if(el) el.textContent = txt; }

/* åŸç¥æ¨¹è„‚ UI ç¶å®š */
function bindGsResin(){
  tickResinAuto();
  const input = $("#gs_resin");
  const hint = $("#gs_resin_hint");
  input.value = STATE.gs.resin;
  function write(val){
    STATE.gs.resin = clamp(Math.round(val), 0, 200);
    STATE.gs.resinStamp = Date.now();
    input.value = STATE.gs.resin;
    const remain = 200 - STATE.gs.resin;
    if(remain<=0){ hint.textContent = "å·²æ»¿"; }
    else{
      const mins = remain * 8;
      const h = Math.floor(mins/60), m = mins%60;
      hint.textContent = `è·æ»¿ç´„ ${h}å°æ™‚${m}åˆ†`;
    }
  }
  input.onchange = ()=> write(Number(input.value));
  $("[data-act='gsResinDec10']").onclick = ()=> write(STATE.gs.resin - 10);
  $("[data-act='gsResinDec1']").onclick  = ()=> write(STATE.gs.resin - 1);
  $("[data-act='gsResinInc1']").onclick  = ()=> write(STATE.gs.resin + 1);
  $("[data-act='gsResinInc10']").onclick = ()=> write(STATE.gs.resin + 10);
}

/* ZZZ é«”åŠ› */
function bindZZZ(){
  bindDailyCheckbox("zzz_daily", STATE.zzz.daily);
  const input = $("#zzz_energy");
  input.value = STATE.zzz.energy;
  input.onchange = async ()=>{ STATE.zzz.energy = clamp(Number(input.value)||240, 240, 960); await persist(); };
  $("#zzz_claim").onclick = async ()=>{
    STATE.zzz.energy = clamp(STATE.zzz.energy + 80, 240, 960);
    if(STATE.zzz.energy>=960) STATE.zzz.energy = 240;
    input.value = STATE.zzz.energy;
    await persist();
  };
  $("#zzz_reset").onclick = async ()=>{ STATE.zzz.energy = 240; input.value = 240; await persist(); };
}

/* HSR ç¶å®šèˆ‡é¡¯ç¤º */
function bindHSR(){
  bindDailyCheckbox("hsr_daily", STATE.hsr.daily);
  setText("hsr_chaos_next", STATE.hsr.chaos.next || "â€”");
  setText("hsr_fiction_next", STATE.hsr.fiction.next || "â€”");
  setText("hsr_apoc_next", STATE.hsr.apoc.next || "â€”");
  setText("hsr_arbi_next", STATE.hsr.arbi.next || "â€”");
  setText("hsr_ver_next", (STATE.hsr.ver && STATE.hsr.ver.next) ? STATE.hsr.ver.next : "â€”");
  bindFlag("hsr_chaos_done", ["hsr","chaos"]);
  bindFlag("hsr_fiction_done", ["hsr","fiction"]);
  bindFlag("hsr_apoc_done", ["hsr","apoc"]);
  bindFlag("hsr_arbi_done", ["hsr","arbi"]);
}

/* GS å…©å¸³ Daily + èºæ—‹/åŠ‡è©© */
function bindGS(){
  bindGsResin();
  bindDailyCheckbox("gs_asia_daily", STATE.gs.asia.daily);
  bindDailyCheckbox("gs_tw_daily", STATE.gs.tw.daily);
  // ç‰ˆæœ¬
  setText("gs_ver_next", STATE.gs.verNext || "â€”");

  const asiaAby = $("#gs_asia_abyss"), asiaThe = $("#gs_asia_theater");
  const twAby   = $("#gs_tw_abyss"),   twThe   = $("#gs_tw_theater");

  asiaAby.checked = !!STATE.gs.asia.abyss.done;
  asiaThe.checked = !!STATE.gs.asia.theater.done;
  twAby.checked   = !!STATE.gs.tw.abyss.done;
  twThe.checked   = !!STATE.gs.tw.theater.done;

  asiaAby.onchange = async ()=>{ STATE.gs.asia.abyss.done = asiaAby.checked; await persist(); };
  asiaThe.onchange = async ()=>{ STATE.gs.asia.theater.done = asiaThe.checked; await persist(); };
  twAby.onchange   = async ()=>{ STATE.gs.tw.abyss.done = twAby.checked; await persist(); };
  twThe.onchange   = async ()=>{ STATE.gs.tw.theater.done = twThe.checked; await persist(); };
}

/* å…¶ä»–éŠæˆ² */
function bindOthers(){
  bindDailyCheckbox("hoyo_daily", STATE.hoyo.daily);

  bindDailyCheckbox("cats_daily", STATE.cats.daily);
  const cw = $("#cats_weekend");
  cw.checked = (STATE.cats.weekend.last === dayKey());
  cw.onchange = async ()=>{ STATE.cats.weekend.last = cw.checked ? dayKey() : null; await persist(); };

  bindDailyCheckbox("pogo_spin", STATE.pogo.spin);
  bindDailyCheckbox("pogo_catch", STATE.pogo.catch);
  bindDailyCheckbox("noti_daily", STATE.noti.daily);

  bindDailyCheckbox("nsfw_daily", STATE.nsfw.daily);
  const ctr = $("#nsfw_ticket_ctr");
  const inc = $("#nsfw_ticket_inc");
  const rst = $("#nsfw_ticket_reset");
  function paintTicket(){ ctr.textContent = `${STATE.nsfw.ticket} / 3`; }
  paintTicket();
  inc.onclick = async ()=>{ STATE.nsfw.ticket = (STATE.nsfw.ticket+1)%4; if(STATE.nsfw.ticket===0) STATE.nsfw.ticket=0; paintTicket(); await persist(); };
  rst.onclick = async ()=>{ STATE.nsfw.ticket = 0; paintTicket(); await persist(); };
}

/* ================= æ¸²æŸ“ & å•Ÿå‹• ================= */
async function applyAuthUI(user){
  if(user){
    CURRENT_UID = user.uid;
    $("#btnLogin").style.display="none";
    $("#btnLogout").style.display="";
    $("#who").textContent = `å·²ç™»å…¥ï¼š${user.email||"Google å¸³è™Ÿ"}`;
    // å„ªå…ˆè®€é›²ç«¯
    LOADING_CLOUD = true;
    const cloud = await loadCloud();
    LOADING_CLOUD = false;
    if(cloud){ STATE = cloud; }
    else if(!STATE){ STATE = defaultState(); }
  }else{
    CURRENT_UID = null;
    $("#btnLogin").style.display="";
    $("#btnLogout").style.display="none";
    $("#who").textContent = `(æœªç™»å…¥ï¼šåƒ…æœ¬æ©Ÿ)`;
    if(!STATE){ STATE = loadLocal() || defaultState(); }
  }

  ensureDailyReset();
  tickResinAuto();

  // æœˆæ›´è¦å‰‡ï¼šæ¯æœˆ 1/16 å°‡æ·µæœˆ done æ¸…ç©ºï¼›æ¯æœˆ 1 å°‡åŠ‡è©© done æ¸…ç©ºï¼ˆå…©å¸³å„è‡ªï¼‰
  const now = new Date();
  if(isAbyssResetToday(now)){ STATE.gs.asia.abyss.done = false; STATE.gs.tw.abyss.done = false; }
  if(isTheaterResetToday(now)){ STATE.gs.asia.theater.done = false; STATE.gs.tw.theater.done = false; }

  await persist();
  render();
}

function render(){
  bindGS();
  bindHSR();
  bindZZZ();
  bindOthers();
  refreshPending();
  refreshVersionRemind();
}

$("#btnLogin").onclick = async ()=>{
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt:'select_account' });
    await auth.signInWithPopup(provider);
  }catch(e){
    if((e.code||"").includes("popup")){ await auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider()); }
    else alert("ç™»å…¥å¤±æ•—ï¼š" + e.message);
  }
};
$("#btnLogout").onclick = async ()=>{ await auth.signOut(); };

auth.onAuthStateChanged(async user => { await applyAuthUI(user); });

/* é¦–æ¬¡è¼‰å…¥ï¼ˆæœªè§¸ç™¼ onAuthStateChanged å‰ä¹Ÿæœ‰æœ¬æ©Ÿç‹€æ…‹ï¼‰ */
(function firstLoad(){
  STATE = loadLocal() || defaultState();
  ensureDailyReset();
  saveLocal();
})();

/* æ¯åˆ†é˜è‡ªå‹•åˆ·æ–°æ¨¹è„‚é¡¯ç¤º */
setInterval(()=>{ tickResinAuto(); bindGsResin(); }, 60*1000);

/* ================= æ¨æ’­ ================= */
$("#btnNotify").onclick = async ()=>{
  if(!("Notification" in window)){ alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥"); return; }
  if(Notification.permission === "default"){
    await Notification.requestPermission();
  }
  if(Notification.permission !== "granted"){ alert("é€šçŸ¥æœªå…è¨±"); return; }
  STATE.notify.enabled = true;
  await persist();
  // æ¯æ™š 20:00 & 22:00 å®‰æ’æç¤º
  scheduleNotificationAt(20,0,"daily-20","æ¯æ—¥æé†’","é‚„æœ‰æ¯æ—¥æœªå®Œæˆï¼Œè¨˜å¾—è™•ç†å–”ï¼");
  scheduleNotificationAt(22,0,"daily-22","æ¯æ—¥æé†’","ç¡å‰å†ç¢ºèªä¸€ä¸‹æ¯æ—¥ï½");
  alert("å·²å•Ÿç”¨é€šçŸ¥ï¼ˆ20:00 / 22:00ï¼‰ã€‚");
};

/* ================= åˆå§‹æ¸²æŸ“ ================= */
render();
</script>
</body>
</html>
