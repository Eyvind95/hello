<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>皮卡每日任務</title>

<!-- PWA / Icons -->
<link rel="manifest" href="daily.webmanifest">
<link rel="icon" href="6.png">
<meta name="theme-color" content="#0b0b0b" />

<!-- Firebase v8 compat -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
:root{
  --bg:#0b0b0b;
  --panel:#151515cc;
  --tile:#101010cc;
  --muted:#bbbbbb;
  --accent:#6ee7ff;
  --ok:#8cff9c;
  --danger:#ff7b7b;
  --border:#2a2a2a;
}
*{box-sizing:border-box}
html,body{height:100%;}
body{
  margin:0; color:#fff;
  background:
    linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.25)),
    url("7.jpg") center/cover no-repeat fixed,
    var(--bg);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", "Helvetica Neue", Arial, sans-serif;
}
@media (max-width:768px){ body{ background-attachment:scroll; } }

.container{max-width:1080px; margin:20px auto; padding:0 12px;}
.header{
  display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
  background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:10px 12px; margin-bottom:12px;
}
h1{font-size:22px; margin:0;}
.header .right{display:flex; gap:8px; align-items:center;}
.btn{
  background:#202020; color:#fff; border:1px solid var(--border); border-radius:10px;
  padding:8px 10px; cursor:pointer;
}
.btn:hover{filter:brightness(1.08)}
.muted{color:var(--muted)}

.grid{
  display:grid; gap:12px;
  grid-template-columns: repeat(2, 1fr);
}
@media (max-width:900px){ .grid{grid-template-columns:1fr} }

.card{
  background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:12px;
}
.card h2{margin:0 0 8px 0; font-size:18px}
.card .sub{font-size:12px; color:var(--muted); margin-top:-4px; margin-bottom:8px}

.game{
  background:var(--tile); border:1px solid var(--border); border-radius:14px; padding:10px; margin-top:10px;
}
.game .top{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
.game .title{display:flex; align-items:center; gap:8px}
.game img.icon{width:28px; height:28px; border-radius:6px; object-fit:cover; background:#333}
.badge{font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); color:#ddd}

.g-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:7px 8px; border-top:1px dashed #2a2a2a; }
.g-left{ color:#ddd; }
.g-right{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.ck{ display:inline-flex; align-items:center; gap:6px; }
.ck input{ width:18px; height:18px; }
.pill{ background:#202020; border:1px solid var(--border); border-radius:999px; padding:4px 8px; font-size:12px; }
.pill.ok{ color:var(--ok) }
.pill.bad{ color:var(--danger) }
.small{ font-size:12px; color:#aaa; }
.val{ font-variant-numeric:tabular-nums; }

.sep{ height:8px }

.footer-note{ color:#aaa; font-size:12px; margin-top:12px; text-align:center; }
.counter .val,
.pill-val,
.resin .val,
.stamina .val,
.gs-resin-val {
  background:#0d0d0d !important;
  color:#fff !important;
  border:1px solid var(--border, #2a2a2a);
  border-radius:999px;
  padding:6px 12px;
  font-weight:700;
  min-width:64px; text-align:center;
}

/* ---- + / - 按鈕基礎樣式 ---- */
.counter .btn,
.btn-inc, .btn-dec {
  background:#1b1b1b;
  border:1px solid var(--border, #2a2a2a);
  color:#fff;
  width:28px; height:28px;
  border-radius:999px;
  display:grid; place-items:center;
  cursor:pointer; user-select:none;
}

/* 加號（綠色） */
.btn-plus, .btn-inc {
  background:rgba(34,197,94,.14);
  border-color:#22c55e;
  color:#86efac;
}

/* 減號（紅色） */
.btn-minus, .btn-dec {
  background:rgba(239,68,68,.14);
  border-color:#ef4444;
  color:#fda4af;
}

/* 數字輸入框如果有用到也強制白字 */
input[type="number"].val,
.resin input[type="number"],
.stamina input[type="number"]{
  color:#fff !important;
}
/* === 絕區零體力按鈕顏色設定 === */

/* +80 → 綠色 */
#zzz_claim {
  background: rgba(34,197,94,.15);
  border: 1px solid #22c55e;
  color: #86efac;
}

/* 滿了重置到240 → 紅色 */
#zzz_reset {
  background: rgba(239,68,68,.15);
  border: 1px solid #ef4444;
  color: #fda4af;
}

</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1>皮卡每日任務</h1>
      <div class="muted small">今天（<span id="todayStr"></span>）05:00 作為換日點｜未完成每日：<span id="pendingCount" class="val">0</span> 個</div>
    </div>
    <div class="right">
      <span id="who" class="muted">(未登入：僅本機)</span>
      <button class="btn" id="btnLogin">Google 登入</button>
      <button class="btn" id="btnLogout" style="display:none">登出</button>
    </div>
  </div>

  <div class="grid">
    <!-- 左欄 -->
    <section class="card">
      <h2>米家三兄弟</h2><div class="sub">原神（台/亞）、崩壞：星穹鐵道、HoyoLAB</div>

      <!-- 原神（台服） -->
      <div class="game" id="gs-tw">
        <div class="top">
          <div class="title">
            <img class="icon" src="a.jpg" onerror="this.src='6.png'">
            <strong>原神・台服</strong>
          </div>
          <span class="badge">每日＋月更</span>
        </div>

        <div class="g-row">
          <div class="g-left">樹脂（8 分鐘 +1 ／ Max 200）</div>
          <div class="g-right">
            <button class="pill" id="gsTw_resin_minus10">-10</button>
            <button class="pill" id="gsTw_resin_minus1">-1</button>
            <span class="pill val" id="gsTw_resin_view">160</span>
            <button class="pill" id="gsTw_resin_plus1">+1</button>
            <button class="pill" id="gsTw_resin_plus10">+10</button>
            <span class="small">（距離滿：<span id="gsTw_resin_eta" class="val">--</span>）</span>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">每日委託</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="gsTw_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">淵月螺旋（每月 1 ＆ 16）</div>
          <div class="g-right">
            <span class="small">下次：<span id="gsTw_abyss_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsTw_abyss_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">劇詩（每月 1）</div>
          <div class="g-right">
            <span class="small">下次：<span id="gsTw_poem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsTw_poem_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">版本更新（42 天）</div>
          <div class="g-right">
            <span class="small">下次：<span id="gsTw_ver_next" class="val">--</span></span>
          </div>
        </div>
      </div>

      <!-- 原神（亞服） -->
      <div class="game" id="gs-as">
        <div class="top">
          <div class="title">
            <img class="icon" src="a.jpg" onerror="this.src='6.png'">
            <strong>原神・亞服</strong>
          </div>
          <span class="badge">每日＋月更</span>
        </div>

        <div class="g-row">
          <div class="g-left">樹脂（8 分鐘 +1 ／ Max 200）</div>
          <div class="g-right">
            <button class="pill" id="gsAs_resin_minus10">-10</button>
            <button class="pill" id="gsAs_resin_minus1">-1</button>
            <span class="pill val" id="gsAs_resin_view">160</span>
            <button class="pill" id="gsAs_resin_plus1">+1</button>
            <button class="pill" id="gsAs_resin_plus10">+10</button>
            <span class="small">（距離滿：<span id="gsAs_resin_eta" class="val">--</span>）</span>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">每日委託</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="gsAs_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">淵月螺旋（每月 1 ＆ 16）</div>
          <div class="g-right">
            <span class="small">下次：<span id="gsAs_abyss_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsAs_abyss_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">劇詩（每月 1）</div>
          <div class="g-right">
            <span class="small">下次：<span id="gsAs_poem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsAs_poem_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">版本更新（42 天）</div>
          <div class="g-right">
            <span class="small">下次：<span id="gsAs_ver_next" class="val">--</span></span>
          </div>
        </div>
      </div>

      <!-- 崩壞：星穹鐵道 -->
      <div class="game" id="hsr">
        <div class="top">
          <div class="title">
            <img class="icon" src="b.jpg" onerror="this.src='6.png'">
            <strong>崩壞：星穹鐵道</strong>
          </div>
          <span class="badge">每日＋多個 42 天檔期</span>
        </div>

        <div class="g-row">
          <div class="g-left">每日</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="hsr_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">混沌回憶（42 天）</div>
          <div class="g-right">
            <span class="small">下次：<span id="hsr_mem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_mem_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">虛構敘事（42 天）</div>
          <div class="g-right">
            <span class="small">下次：<span id="hsr_pure_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_pure_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">末日幻影（42 天）</div>
          <div class="g-right">
            <span class="small">下次：<span id="hsr_ape_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_ape_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">異相仲裁（42 天）</div>
          <div class="g-right">
            <span class="small">下次：<span id="hsr_arbi_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_arbi_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">版本更新（42 天）</div>
          <div class="g-right"><span class="small">下次：<span id="hsr_ver_next" class="val">--</span></span></div>
        </div>
      </div>

      <!-- HoyoLAB -->
      <div class="game" id="hoyo">
        <div class="top">
          <div class="title">
            <img class="icon" src="d.png" onerror="this.src='6.png'">
            <strong>HoyoLAB</strong>
          </div>
          <span class="badge">每日</span>
        </div>
        <div class="g-row">
          <div class="g-left">每日簽到</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="hoyo_daily"></label></div>
        </div>
      </div>
    </section>

    <!-- 右欄 -->
    <section class="card">
      <h2>其他</h2><div class="sub">絕區零、貓咪大戰爭、Pokémon GO、諾提里森、新世界狂歡</div>

      <!-- 絕區零（懶人版能量） -->
      <div class="game" id="zzz">
        <div class="top">
          <div class="title">
            <img class="icon" src="c.png" onerror="this.src='6.png'">
            <strong>絕區零</strong>
          </div>
          <span class="badge">每日＋能量</span>
        </div>

        <div class="g-row">
          <div class="g-left">每日</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="zzz_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">體力（懶人版）</div>
          <div class="g-right">
            <span class="pill val" id="zzz_energy_view">240</span>
            <button class="pill" id="zzz_claim">收取 +80</button>
            <button class="pill" id="zzz_reset">滿了重置到 240</button>
            <span class="small">區間 240~960，滿後自動回 240</span>
          </div>
        </div>
      </div>

      <!-- 貓咪大戰爭 -->
      <div class="game" id="cats">
        <div class="top">
          <div class="title">
            <img class="icon" src="e.jpg" onerror="this.src='6.png'">
            <strong>貓咪大戰爭</strong>
          </div>
          <span class="badge">週末限定</span>
        </div>

        <div class="g-row">
          <div class="g-left">每日</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="cats_daily"></label></div>
        </div>

        <div class="g-row" id="cats_weekend_row">
          <div class="g-left">週末關卡（六、日）</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="cats_weekend"></label><span class="small">週末 05:00 重置</span></div>
        </div>
      </div>

      <!-- Pokémon GO -->
      <div class="game" id="pogo">
        <div class="top">
          <div class="title">
            <img class="icon" src="f.jpg" onerror="this.src='6.png'">
            <strong>Pokémon GO</strong>
          </div>
          <span class="badge">每日</span>
        </div>
        <div class="g-row">
          <div class="g-left">轉一個補給站</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="pogo_spin"></label></div>
        </div>
        <div class="g-row">
          <div class="g-left">捉一隻寶可夢</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="pogo_catch"></label></div>
        </div>
      </div>

      <!-- 諾提里森 -->
      <div class="game" id="noti">
        <div class="top">
          <div class="title">
            <img class="icon" src="g.jpg" onerror="this.src='6.png'">
            <strong>諾提里森</strong>
          </div>
          <span class="badge">每日</span>
        </div>
        <div class="g-row">
          <div class="g-left">每日</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="noti_daily"></label></div>
        </div>
      </div>

      <!-- 新世界狂歡 -->
      <div class="game" id="nsfw">
        <div class="top">
          <div class="title">
            <img class="icon" src="h.jpg" onerror="this.src='6.png'">
            <strong>新世界狂歡</strong>
          </div>
          <span class="badge">每日＋金幣卷</span>
        </div>

        <div class="g-row">
          <div class="g-left">每日</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="nsfw_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">金幣卷（3 天一次，循環 0→1→2→0）</div>
          <div class="g-right">
            <span class="pill val" id="nsfw_ticket_ctr">0 / 3</span>
            <button class="pill" id="nsfw_ticket_inc">完成 +1</button>
            <button class="pill" id="nsfw_ticket_reset">歸 0</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer-note">※ 晚上 20:00 與 22:00 若尚有「每日」未打勾，會在前端提醒（需在網頁前景開著）。</div>
</div>

<script>
/* ------------ 小工具 ------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const toLocal5AM = (d=new Date()) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 5, 0, 0, 0);
function isTodayAfter5(now=new Date()){
  return now >= toLocal5AM(now);
}
function inWeekend(d=new Date()){
  const w = d.getDay(); // 0 Sun
  return (w === 0 || w === 6);
}
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function fmtDate(d){
  const x = asDate(d);
  if (!x) return '--';
  return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`;
}
function nextAbyssBase(from){ // 每月 1 & 16
  const d = new Date(from);
  const day = d.getDate();
  const m = d.getMonth();
  const y = d.getFullYear();
  if(day < 1){ return new Date(y, m, 1); }
  if(day < 16){ return new Date(y, m, 16); }
  return new Date(y, m+1, 1);
}
function nextMonth1(from){
  const d = new Date(from);
  return new Date(d.getFullYear(), d.getMonth()+1, 1);
}
function next42(from){
  const d = new Date(from);
  d.setDate(d.getDate()+42);
  return d;
}
// 讓任何 Date / Firestore Timestamp / number / string 都能轉回 Date
function asDate(x){
  if (!x) return null;
  if (x instanceof Date) return x;
  if (typeof x === 'number' || typeof x === 'string') return new Date(x);
  if (x && typeof x.toDate === 'function') return x.toDate(); // Firestore Timestamp
  return null;
}
// 轉成儲存用的毫秒數（保證雲端是 number，而不是 Date / Timestamp）
function toMillis(x){
  const d = asDate(x);
  return d ? d.getTime() : null;
}
// 深走訪，把所有 { last:*, next:* } 或是 Date/Timestamp 欄位轉成 number
function normalizeForSave(obj){
  if (obj == null || typeof obj !== 'object') return obj;
  if (obj instanceof Date) return obj.getTime();
  if (typeof obj.toDate === 'function') return obj.toDate().getTime(); // Timestamp
  const out = Array.isArray(obj) ? [] : {};
  for (const k in obj){
    const v = obj[k];
    // 這些欄位慣例上是時間
    if (k === 'last' || k === 'next'){
      out[k] = toMillis(v);
    }else{
      out[k] = normalizeForSave(v);
    }
  }
  return out;
}
// 深走訪，把 number（毫秒）或 Timestamp 轉回 Date 物件給前端使用
function reviveFromCloud(obj){
  if (obj == null || typeof obj !== 'object') return obj;
  if (typeof obj.toDate === 'function') return obj.toDate();       // Timestamp
  if (typeof obj === 'number') return new Date(obj);               // 毫秒
  const out = Array.isArray(obj) ? [] : {};
  for (const k in obj){
    const v = obj[k];
    if (k === 'last' || k === 'next' || v instanceof Date || typeof v === 'number' || (v && typeof v.toDate === 'function')){
      out[k] = asDate(v);
    }else{
      out[k] = reviveFromCloud(v);
    }
  }
  return out;
}
/* ------------ 預設狀態 ------------- */
function defaultState(){
  const today = new Date();
  const baseAbyss = nextAbyssBase(today);
  const basePoem  = nextMonth1(today);

  return {
    // 原神：台、亞
    gsTw:{
      resin:{ val:160, last: Date.now() }, // 8 分鐘 +1，max 200
      daily:{ last:null },
      abyss:{ next: baseAbyss, done:false },
      poem: { next: basePoem , done:false },
      ver:  { next: next42(today) }
    },
    gsAs:{
      resin:{ val:160, last: Date.now() },
      daily:{ last:null },
      abyss:{ next: baseAbyss, done:false },
      poem: { next: basePoem , done:false },
      ver:  { next: next42(today) }
    },
    // 星穹鐵道
    hsr:{
      daily:{ last:null },
      mem: { next: new Date('2025-10-27'), done:false },
      pure:{ next: new Date('2025-11-24'), done:false },
      ape: { next: new Date('2025-11-10'), done:false },
      arbi:{ next: new Date('2025-11-05'), done:false },
      ver: { next: new Date('2025-11-05') }
    },
    // HoyoLAB
    hoyo:{ daily:{ last:null } },
    // ZZZ
    zzz:{ daily:{ last:null }, energy:240 },
    // 貓咪
    cats:{ daily:{ last:null }, weekend:{ last:null } },
    // POGO
    pogo:{ spin:{ last:null }, catch:{ last:null } },
    // 諾提
    noti:{ daily:{ last:null } },
    // 新世界狂歡
    nsfw:{ daily:{ last:null }, ticket:0 },

    // 元資訊：重置點與今天字串
    meta:{
      lastReset: null // 儲存「上一次 05:00 換日後的日期(yyyy-mm-dd)」
    }
  };
}

/* 深度合併（用 default 補缺，不覆蓋現有值） */
function deepMergeDefaults(def, cur){
  if (cur === undefined || cur === null) return def;
  if (Array.isArray(def) || Array.isArray(cur)) return cur ?? def;
  if (typeof def !== 'object' || typeof cur !== 'object') return (cur === undefined || cur === null) ? def : cur;
  const out = {...cur};
  for (const k of Object.keys(def)){
    out[k] = deepMergeDefaults(def[k], cur[k]);
  }
  return out;
}

/* ------------ 本機儲存 ------------- */
const LS_KEY = "daily_state_v1";
function loadLocal(){
  try{ const raw=localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; }
}
function saveLocal(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

/* ------------ Firebase ------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
  authDomain: "eyvind95-182f0.firebaseapp.com",
  projectId: "eyvind95-182f0",
  storageBucket: "eyvind95-182f0.firebasestorage.app",
  messagingSenderId: "105770576221",
  appId: "1:105770576221:web:dd3a57ce4e051bda91a0b4"
};
if(!firebase.apps.length){ firebase.initializeApp(firebaseConfig); }
const db = firebase.firestore();
let CURRENT_UID = null;
const provider = new firebase.auth.GoogleAuthProvider();
provider.setCustomParameters({ prompt:'select_account' });

function userDoc(){ return db.collection('daily').doc(CURRENT_UID); }

async function cloudLoad(){
  if(!CURRENT_UID) return null;
  const snap = await userDoc().get();
  return snap.exists ? snap.data() : null;
}
async function cloudSave(state){
  if(!CURRENT_UID) return;
  await userDoc().set(state);
}

/* ------------ 全域狀態 ------------- */
let STATE = null;

/* ------------ 換日邏輯（05:00） ------------- */
function ensureDailyReset(){
  const now = new Date();
  const dayToken = ymd(isTodayAfter5(now) ? now : addDays(now,-1)); // 當天 05:00 之後算今天；否則算昨天
  if(STATE.meta.lastReset === dayToken) return;

  // 通用的「每日」欄位：把 last 清掉（表示可勾）
  function resetDaily(obj){
    if(!obj) return;
    Object.keys(obj).forEach(k=>{
      const v = obj[k];
      if(v && typeof v === 'object' && 'last' in v){
        v.last = null;
      }
    });
  }

  // 重置各區塊
  resetDaily(STATE.gsTw);
  resetDaily(STATE.gsAs);
  resetDaily(STATE.hsr);
  resetDaily(STATE.hoyo);
  resetDaily(STATE.zzz);
  resetDaily(STATE.cats);
  resetDaily(STATE.pogo);
  resetDaily(STATE.noti);
  resetDaily(STATE.nsfw);

  // 週末關卡：只要在週末（六日），每天重置一次
  if(inWeekend(now)){
    STATE.cats.weekend.last = null;
  }

  STATE.meta.lastReset = dayToken;
}

/* ------------ 原神樹脂自動回復 ------------- */
function tickResinAutoOne(node){
  const now = Date.now();
  let last = toMillis(node.last) ?? now;   // 安全轉換
  let val  = Number(node.val) || 0;

  if (val >= 200){ node.val = 200; node.last = now; return; }

  const mins = Math.floor((now - last)/60000);
  if (mins <= 0) return;

  const add = Math.floor(mins/8);
  if (add > 0){
    node.val  = Math.min(200, val + add);
    node.last = last + add*8*60000;        // 儲存回毫秒
  }
}

/* ------------ UI 綁定 ------------- */
// 通用「每日 checkbox」
function bindDailyCheckbox(idPath, model){
  const el = document.getElementById(idPath);
  if(!el) return;
  el.checked = !!model.last;
  el.onchange = async ()=>{
    model.last = el.checked ? Date.now() : null;
    await persist();
    renderPending();
  }
}
function bindSpin(id, model){ // POGO
  const el = document.getElementById(id);
  el.checked = !!model.last;
  el.onchange = async ()=>{ model.last = el.checked ? Date.now() : null; await persist(); renderPending(); }
}
function bindPoGo(idCatch, idSpin){
  bindSpin(idSpin, STATE.pogo.spin);
  bindSpin(idCatch, STATE.pogo.catch);
}

function setText(id, txt){ const el=$(id.startsWith('#')?id:('#'+id)); if(el) el.textContent=txt; }

function etaTo200(resin){
  if(resin.val>=200) return '滿';
  const remain = 200 - resin.val;
  const mins = remain*8; // 分鐘
  const h = Math.floor(mins/60);
  const m = mins % 60;
  return `${h}小時 ${m}分`;
}

/* 原神區：台/亞 綁定 */
function bindGenshinOne(prefix, node){
  const v = id => document.getElementById(prefix + '_' + id);

  // 樹脂
  const view = v('resin_view'), eta = v('resin_eta');
  function paintResin(){
    view.textContent = node.resin.val;
    eta.textContent = etaTo200(node.resin);
  }
  v('resin_minus10').onclick = async ()=>{ node.resin.val = Math.max(0, node.resin.val-10); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_minus1').onclick  = async ()=>{ node.resin.val = Math.max(0, node.resin.val-1 ); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_plus1').onclick   = async ()=>{ node.resin.val = Math.min(200, node.resin.val+1 ); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_plus10').onclick  = async ()=>{ node.resin.val = Math.min(200, node.resin.val+10); node.resin.last=Date.now(); paintResin(); await persist(); };
  paintResin();

  // 每日
  bindDailyCheckbox(prefix+"_daily", node.daily);

  // 螺旋
  setText(prefix+"_abyss_next", fmtDate(node.abyss.next));
  const ckA = v('abyss_done'); ckA.checked = !!node.abyss.done;
  ckA.onchange = async ()=>{ node.abyss.done = ckA.checked; await persist(); };

  // 劇詩
  setText(prefix+"_poem_next", fmtDate(node.poem.next));
  const ckP = v('poem_done'); ckP.checked = !!node.poem.done;
  ckP.onchange = async ()=>{ node.poem.done = ckP.checked; await persist(); };

  // 版本
  setText(prefix+"_ver_next", fmtDate(node.ver.next));
}

/* 星穹鐵道 */
function bindHSR(){
  bindDailyCheckbox("hsr_daily", STATE.hsr.daily);

  function one(key, labelId, ckId){
    setText(labelId, fmtDate(STATE.hsr[key].next));
    const ck = document.getElementById(ckId);
    ck.checked = !!STATE.hsr[key].done;
    ck.onchange = async ()=>{ STATE.hsr[key].done = ck.checked; await persist(); };
  }
  one('mem', "hsr_mem_next", "hsr_mem_done");
  one('pure',"hsr_pure_next","hsr_pure_done");
  one('ape',"hsr_ape_next","hsr_ape_done");
  one('arbi',"hsr_arbi_next","hsr_arbi_done");
  setText("hsr_ver_next", fmtDate(STATE.hsr.ver.next));
}

/* HoyoLAB */
function bindHoyo(){ bindDailyCheckbox("hoyo_daily", STATE.hoyo.daily); }

/* ZZZ（懶人版） */
function bindZZZ(){
  bindDailyCheckbox("zzz_daily", STATE.zzz.daily);

  const view = $("#zzz_energy_view");
  function paint(){ view.textContent = STATE.zzz.energy; }
  paint();

  $("#zzz_claim").onclick = async ()=>{
    STATE.zzz.energy = Math.min(STATE.zzz.energy + 80, 960);
    if (STATE.zzz.energy >= 960) STATE.zzz.energy = 240;
    paint(); await persist();
  };
  $("#zzz_reset").onclick = async ()=>{ STATE.zzz.energy = 240; paint(); await persist(); };
}

/* 貓咪：週末行顯示控管 */
function toggleWeekendRow(){
  const row = $("#cats_weekend_row");
  if(!row) return;
  row.style.display = inWeekend() ? "" : "none";
}
function bindCats(){
  bindDailyCheckbox("cats_daily", STATE.cats.daily);
  toggleWeekendRow();
  const ck = $("#cats_weekend");
  if(ck){
    ck.checked = !!STATE.cats.weekend.last;
    ck.onchange = async ()=>{ STATE.cats.weekend.last = ck.checked ? Date.now() : null; await persist(); };
  }
}

/* POGO */
function bindPoGoAll(){ bindPoGo("pogo_catch", "pogo_spin"); }

/* 諾提里森 */
function bindNoti(){ bindDailyCheckbox("noti_daily", STATE.noti.daily); }

/* 新世界狂歡（自動循環 0→1→2→0） */
function bindNSFW(){
  bindDailyCheckbox("nsfw_daily", STATE.nsfw.daily);
  const ctr=$("#nsfw_ticket_ctr"), inc=$("#nsfw_ticket_inc"), rst=$("#nsfw_ticket_reset");
  function paint(){ ctr.textContent = `${STATE.nsfw.ticket} / 3`; }
  paint();
  inc.onclick = async ()=>{ STATE.nsfw.ticket = (STATE.nsfw.ticket + 1) % 3; paint(); await persist(); };
  rst.onclick = async ()=>{ STATE.nsfw.ticket = 0; paint(); await persist(); };
}

/* ------------ Pending 統計 & 提醒 ------------- */
function renderPending(){
  // 統計所有「每日」還沒打勾的
  const arr = [
    STATE.gsTw.daily, STATE.gsAs.daily, STATE.hsr.daily, STATE.hoyo.daily, STATE.zzz.daily,
    STATE.cats.daily, STATE.pogo.spin, STATE.pogo.catch, STATE.noti.daily, STATE.nsfw.daily
  ];
  const cnt = arr.filter(x => !x.last).length;
  $("#pendingCount").textContent = cnt;
}
function scheduleLocalReminders(){
  // 前端簡單信息：20:00 / 22:00 若 pending>0 就 alert（頁面開著才會觸發）
  function plan(hour){
    const now = new Date(), t = new Date();
    t.setHours(hour,0,0,0);
    if(t <= now) t.setDate(t.getDate()+1);
    const ms = t - now;
    setTimeout(()=>{ renderPending(); const n=parseInt($("#pendingCount").textContent||"0",10);
      if(n>0) alert(`提醒：你還有 ${n} 個每日尚未完成喔！`);
      plan(hour); // 續約
    }, ms);
  }
  plan(20); plan(22);
}

/* ------------ 渲染 ------------- */
function render(){
  // 日期條
  const now = new Date();
  $("#todayStr").textContent = ymd(now);

  // 流程：自動回復樹脂 → 渲染各塊
  tickResinAuto();

  // Genshin
  bindGenshinOne("gsTw", STATE.gsTw);
  bindGenshinOne("gsAs", STATE.gsAs);

  // HSR / Hoyo / ZZZ / Cats / PoGo / Noti / NSFW
  bindHSR(); bindHoyo(); bindZZZ(); bindCats(); bindPoGoAll(); bindNoti(); bindNSFW();

  renderPending();
}

/* ------------ 永久化（雲端優先） ------------- */
async function persist(){
  // 先本機
  saveLocal(STATE);

  if (CURRENT_UID){
    try{
      // 轉成純 number/原始型別再寫雲
      const clean = normalizeForSave(STATE);
      await cloudSave(clean);
    }catch(e){ console.error(e); }
  }
}
/* ------------ 登入 UI ------------- */
function updateLoginUI(user){
  if(user){
    $("#who").textContent = `已登入：${user.email||'Google'}`;
    $("#btnLogin").style.display="none";
    $("#btnLogout").style.display="";
  }else{
    $("#who").textContent = "(未登入：僅本機)";
    $("#btnLogin").style.display="";
    $("#btnLogout").style.display="none";
  }
}
/* 自動替按鈕加上顏色 class（依照文字內容 + / -） */
function colorizePlusMinus(){
  document.querySelectorAll('.counter .btn, .btn-inc, .btn-dec, button').forEach(b=>{
    const t = (b.textContent || '').trim();
    // 先清掉舊標記
    b.classList.remove('btn-plus','btn-minus');
    // 判斷字面上是否是 + 或 -
    if (t.startsWith('+')) b.classList.add('btn-plus');
    if (t.startsWith('-')) b.classList.add('btn-minus');
  });
}
/* 如果你有 render() 或初始化，結尾呼叫一下 */
window.addEventListener('load', colorizePlusMinus);
/* 若你的頁面有重新渲染 UI 的流程，記得在 render() 結尾也加上 colorizePlusMinus(); */

/* ------------ 啟動 ------------- */
(async function bootstrap(){
  // Service Worker（若檔案存在就會註冊成功）
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }

  // 載入狀態（雲端或本機）→ 合併預設 → 05:00 換日 → 自動回復 → 存 → 渲染
  let local = loadLocal();
  STATE = deepMergeDefaults(defaultState(), local||{});

  ensureDailyReset();
  tickResinAuto();
  await persist();
  render();

  // Google Auth 監聽
  firebase.auth().onAuthStateChanged(async (user)=>{
    CURRENT_UID = user ? user.uid : null;
    updateLoginUI(user);
    try{
      if(user){
const cloud = await cloudLoad();
const revived = cloud ? reviveFromCloud(cloud) : null;
STATE = deepMergeDefaults(defaultState(), revived || STATE || {});
        ensureDailyReset(); tickResinAuto(); await persist(); render();
      }else{
        // 登出回本機
        const loc = loadLocal();
        STATE = deepMergeDefaults(defaultState(), loc || {});
        ensureDailyReset(); tickResinAuto(); await persist(); render();
      }
    }catch(e){ console.error(e); }
  });

  // Login/Logout
  $("#btnLogin").onclick = async ()=>{
    try{ await firebase.auth().signInWithPopup(provider); }
    catch(e){
      const fallback = ["auth/operation-not-supported-in-this-environment","auth/popup-blocked","auth/popup-closed-by-user"];
      if(fallback.includes(e.code||"")) await firebase.auth().signInWithRedirect(provider);
      else alert("登入失敗：" + e.message);
    }
  };
  $("#btnLogout").onclick = async ()=>{ await firebase.auth().signOut(); };

  // 前端提醒排程
  scheduleLocalReminders();

  // 每分鐘 tick 樹脂一次 & 檢查週末行顯示
  setInterval(()=>{ tickResinAuto(); toggleWeekendRow(); renderPending(); }, 60000);
})();
</script>
</body>
</html>
