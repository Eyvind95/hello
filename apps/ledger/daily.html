<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>每日任務 | Daily</title>

<!-- Firebase v8 compat -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<!-- PWA：這份是「每日」的清單 -->
<link rel="manifest" href="daily.webmanifest">
<meta name="theme-color" content="#101010" />

<style>
  :root{
    --bg:#0b0b0b;
    --panel:#151515cc;
    --muted:#bbbbbb;
    --accent:#6ee7ff;
    --danger:#ff7b7b;
    --ok:#8cff9c;
    --border:#2a2a2a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;}
  body{
    margin:0; color:#fff;
    background:
      linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)),
      url("https://i.pinimg.com/736x/9e/79/c3/9e79c358e0914cd144e90a39f102e1cc.jpg") center / cover no-repeat fixed,
      var(--bg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
  }
  @media (max-width:768px){ body{ background-attachment:scroll; } }

  .container{ max-width:1100px; margin:32px auto; padding:0 16px; }
  header{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px; }
  h1{font-size:28px; margin:0;}
  .controls{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    background:var(--panel); padding:10px 12px; border:1px solid var(--border); border-radius:14px;
  }
  .controls button, .controls select, .controls input{
    background:#202020; color:#fff; border:1px solid var(--border);
    padding:8px 10px; border-radius:10px; outline:none;
  }
  .controls button:hover{filter:brightness(1.12); cursor:pointer}
  .spacer{flex:1}
  .muted{color:var(--muted)}

  /* 兩欄 */
  .row{
    display:grid; gap:16px;
    grid-template-columns: 1.11fr 1.35fr; /* 手機日期不會被吃字，右邊較寬 */
  }
  .row > *{ min-width:0; }
  @media (max-width:900px){ .row{ grid-template-columns:1fr; } }

  .card{ background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:16px; }
  .card h2{margin:0 0 10px 0; font-size:20px;}

  /* 遊戲清單卡 */
  .game{
    background:#101010; border:1px solid var(--border); border-radius:14px; padding:14px; margin-bottom:12px;
  }
  .game .head{
    display:flex; align-items:center; gap:10px; margin-bottom:10px;
  }
  .game .head img{
    width:36px; height:36px; object-fit:cover; border-radius:8px; border:1px solid #00000055;
  }
  .game .head h3{ margin:0; font-size:18px; }

  .grid{
    display:grid; gap:10px;
    grid-template-columns: repeat(6, 1fr);
  }
  .grid > *{ min-width:0; }
  @media (max-width:900px){
    .grid{ grid-template-columns:1fr 1fr; }
    .grid > *{ grid-column: span 2; }
  }

  .rowbar{
    display:flex; align-items:center; gap:10px;
    padding:10px; border:1px solid var(--border); border-radius:12px; background:#161616;
  }
  .rowbar label{ display:flex; align-items:center; gap:8px; }
  .rowbar .title{ font-weight:600; }
  .rowbar .tag{ font-size:12px; color:var(--muted); }
  .rowbar .pill{ padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:#1d1d1d; font-size:12px; color:#ddd; }

  .btn{ background:#2a2a2a; color:#fff; border:1px solid var(--border); padding:6px 10px; border-radius:8px; cursor:pointer; }
  .btn:hover{ filter:brightness(1.12); }

  .key{
    display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--muted);
    margin-left:auto;
  }
  .key .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }

  .kpi{
    display:grid; gap:12px;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    margin-top:8px;
  }
  .tile{ background:#101010; border:1px solid var(--border); border-radius:14px; padding:14px; }
  .tile h4{ margin:0 0 6px 0; font-size:14px; color:var(--muted); }
  .tile .val{ font-size:22px; font-variant-numeric: tabular-nums; }
  .tile.ok .val{ color:var(--ok); }
  .tile.danger .val{ color:var(--danger); }
  .tile.accent .val{ color:var(--accent); }

  /* 樹脂數值高亮 */
  .flash-green{ color:#00e676 !important; transition:color .3s ease; }
  .flash-red  { color:#ff5252 !important; transition:color .3s ease; }

  /* 表頭 info 條 */
  .infobar{
    display:flex; align-items:center; gap:10px;
    background:#101010; border:1px solid var(--border); border-radius:14px; padding:10px 12px; margin-bottom:12px;
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <h1>每日任務</h1>
    <div class="controls">
      <span id="todayStr" class="muted"></span>
      <div class="spacer"></div>
      <span class="muted">未完成：<strong id="pendingCount">0</strong></span>
      <span id="who" class="muted">(未登入：僅本機)</span>
      <button id="btnLogin" class="btn">Google 登入</button>
      <button id="btnLogout" class="btn" style="display:none">登出</button>
    </div>
  </header>

  <!-- 上：當天摘要 -->
  <div class="infobar">
    <span class="pill">05:00 換日</span>
    <span class="pill">20:00 / 22:00 提醒</span>
    <span class="pill">支援離線（PWA）</span>
    <div class="spacer"></div>
    <span class="key"><span class="dot" style="background:#00e676"></span>＋綠色</span>
    <span class="key"><span class="dot" style="background:#ff5252"></span>－紅色/重置</span>
  </div>

  <div class="row">
    <!-- 左側：原神 / HSR / ZZZ / Hoyo -->
    <section class="card">

      <!-- 原神（台服） -->
      <div class="game">
        <div class="head"><img src="a.jpg" alt="Genshin" /><h3>原神（台服）</h3></div>
        <div class="grid">
          <!-- 樹脂 -->
          <div class="rowbar" style="grid-column: span 3;">
            <div class="title">樹脂</div>
            <div>目前：<strong id="gsTw_resin_view">160</strong> / 200</div>
            <div class="pill">滿：<span id="gsTw_resin_eta">—</span></div>
            <div class="spacer"></div>
            <button class="btn" id="gsTw_resin_minus10">-10</button>
            <button class="btn" id="gsTw_resin_minus1">-1</button>
            <button class="btn" id="gsTw_resin_plus1">+1</button>
            <button class="btn" id="gsTw_resin_plus10">+10</button>
          </div>
          <!-- 每日 -->
          <div class="rowbar" style="grid-column: span 3;">
            <label><input type="checkbox" id="gsTw_daily"> 每日任務</label>
            <div class="spacer"></div>
            <span class="muted">未勾視為未完成</span>
          </div>
          <!-- 淵月螺旋 -->
          <div class="rowbar" style="grid-column: span 3;">
            <div class="title">淵月螺旋</div>
            <div>下次：<strong id="gsTw_abyss_next">--</strong></div>
            <div class="spacer"></div>
            <label><input type="checkbox" id="gsTw_abyss_done"> 本期已完成</label>
          </div>
          <!-- 劇詩 -->
          <div class="rowbar" style="grid-column: span 3;">
            <div class="title">劇詩</div>
            <div>下次：<strong id="gsTw_poem_next">--</strong></div>
            <div class="spacer"></div>
            <label><input type="checkbox" id="gsTw_poem_done"> 本期已完成</label>
          </div>
          <!-- 版本 -->
          <div class="rowbar" style="grid-column: span 6;">
            <div class="title">版本更新（42 天）</div>
            <div>下次：<strong id="gsTw_ver_next">--</strong></div>
          </div>
        </div>
      </div>

      <!-- 原神（亞服） -->
      <div class="game">
        <div class="head"><img src="a.jpg" alt="Genshin" /><h3>原神（亞服）</h3></div>
        <div class="grid">
          <!-- 樹脂 -->
          <div class="rowbar" style="grid-column: span 3;">
            <div class="title">樹脂</div>
            <div>目前：<strong id="gsAs_resin_view">160</strong> / 200</div>
            <div class="pill">滿：<span id="gsAs_resin_eta">—</span></div>
            <div class="spacer"></div>
            <button class="btn" id="gsAs_resin_minus10">-10</button>
            <button class="btn" id="gsAs_resin_minus1">-1</button>
            <button class="btn" id="gsAs_resin_plus1">+1</button>
            <button class="btn" id="gsAs_resin_plus10">+10</button>
          </div>
          <!-- 每日 -->
          <div class="rowbar" style="grid-column: span 3;">
            <label><input type="checkbox" id="gsAs_daily"> 每日任務</label>
            <div class="spacer"></div>
            <span class="muted">未勾視為未完成</span>
          </div>
          <!-- 淵月螺旋 -->
          <div class="rowbar" style="grid-column: span 3;">
            <div class="title">淵月螺旋</div>
            <div>下次：<strong id="gsAs_abyss_next">--</strong></div>
            <div class="spacer"></div>
            <label><input type="checkbox" id="gsAs_abyss_done"> 本期已完成</label>
          </div>
          <!-- 劇詩 -->
          <div class="rowbar" style="grid-column: span 3;">
            <div class="title">劇詩</div>
            <div>下次：<strong id="gsAs_poem_next">--</strong></div>
            <div class="spacer"></div>
            <label><input type="checkbox" id="gsAs_poem_done"> 本期已完成</label>
          </div>
          <!-- 版本 -->
          <div class="rowbar" style="grid-column: span 6;">
            <div class="title">版本更新（42 天）</div>
            <div>下次：<strong id="gsAs_ver_next">--</strong></div>
          </div>
        </div>
      </div>

      <!-- 崩壞：星穹鐵道 -->
      <div class="game">
        <div class="head"><img src="b.jpg" alt="HSR" /><h3>崩壞：星穹鐵道</h3></div>
        <div class="grid">
          <div class="rowbar" style="grid-column: span 6;">
            <label><input type="checkbox" id="hsr_daily"> 每日</label>
            <div class="spacer"></div>
            <span class="muted">42 天制的活動如下：</span>
          </div>
          <div class="rowbar" style="grid-column: span 3;">
            <div class="title">混沌回憶</div>
            <div>下次：<strong id="hsr_mem_next">--</strong></div>
            <div class="spacer"></div>
            <label><input type="checkbox" id="hsr_mem_done"> 本期已完成</label>
          </div>
          <div class="rowbar" style="grid-column: span 3;">
            <div class="title">虛構敘事</div>
            <div>下次：<strong id="hsr_pure_next">--</strong></div>
            <div class="spacer"></div>
            <label><input type="checkbox" id="hsr_pure_done"> 本期已完成</label>
          </div>
          <div class="rowbar" style="grid-column: span 3;">
            <div class="title">末日幻影</div>
            <div>下次：<strong id="hsr_ape_next">--</strong></div>
            <div class="spacer"></div>
            <label><input type="checkbox" id="hsr_ape_done"> 本期已完成</label>
          </div>
          <div class="rowbar" style="grid-column: span 3;">
            <div class="title">異相仲裁</div>
            <div>下次：<strong id="hsr_arbi_next">--</strong></div>
            <div class="spacer"></div>
            <label><input type="checkbox" id="hsr_arbi_done"> 本期已完成</label>
          </div>
          <div class="rowbar" style="grid-column: span 6;">
            <div class="title">版本更新（42 天）</div>
            <div>下次：<strong id="hsr_ver_next">--</strong></div>
          </div>
        </div>
      </div>

      <!-- 絕區零 -->
      <div class="game">
        <div class="head"><img src="c.png" alt="ZZZ" /><h3>絕區零</h3></div>
        <div class="grid">
          <div class="rowbar" style="grid-column: span 4;">
            <label><input type="checkbox" id="zzz_daily"> 每日</label>
          </div>
          <div class="rowbar" style="grid-column: span 2;">
            <div class="title">電力</div>
            <div>目前：<strong id="zzz_energy_view">240</strong>（滿 960）</div>
            <div class="spacer"></div>
            <button class="btn" id="zzz_claim">＋80</button>
            <button class="btn" id="zzz_reset">重置 240</button>
          </div>
        </div>
      </div>

      <!-- HoyoLAB -->
      <div class="game">
        <div class="head"><img src="d.png" alt="HoyoLAB" /><h3>HoyoLAB</h3></div>
        <div class="grid">
          <div class="rowbar" style="grid-column: span 6;">
            <label><input type="checkbox" id="hoyo_daily"> 每日</label>
          </div>
        </div>
      </div>
    </section>

    <!-- 右側：貓咪 / POGO / 諾提 / 新世界狂歡 -->
    <section class="card">
      <!-- 貓咪大戰爭 -->
      <div class="game">
        <div class="head"><img src="e.jpg" alt="Cats" /><h3>貓咪大戰爭</h3></div>
        <div class="grid">
          <div class="rowbar" style="grid-column: span 6;">
            <label><input type="checkbox" id="cats_daily"> 每日</label>
          </div>
          <div id="cats_weekend_row" class="rowbar" style="grid-column: span 6;">
            <label><input type="checkbox" id="cats_weekend"> 週末關卡（六/日顯示；當天 05:00 重置）</label>
          </div>
        </div>
      </div>

      <!-- Pokémon GO -->
      <div class="game">
        <div class="head"><img src="f.jpg" alt="Pokémon GO" /><h3>Pokémon GO</h3></div>
        <div class="grid">
          <div class="rowbar" style="grid-column: span 3;">
            <label><input type="checkbox" id="pogo_spin"> 轉一次補給站</label>
          </div>
          <div class="rowbar" style="grid-column: span 3;">
            <label><input type="checkbox" id="pogo_catch"> 捉一隻寶可夢</label>
          </div>
        </div>
      </div>

      <!-- 諾提里森 -->
      <div class="game">
        <div class="head"><img src="g.jpg" alt="Noti" /><h3>諾提里森</h3></div>
        <div class="grid">
          <div class="rowbar" style="grid-column: span 6;">
            <label><input type="checkbox" id="noti_daily"> 每日</label>
          </div>
        </div>
      </div>

      <!-- 新世界狂歡 -->
      <div class="game">
        <div class="head"><img src="h.jpg" alt="NSFW" /><h3>新世界狂歡</h3></div>
        <div class="grid">
          <div class="rowbar" style="grid-column: span 4;">
            <label><input type="checkbox" id="nsfw_daily"> 每日</label>
          </div>
          <div class="rowbar" style="grid-column: span 2;">
            <div class="title">金幣卷</div>
            <div>進度：<strong id="nsfw_ticket_ctr">0 / 3</strong></div>
            <div class="spacer"></div>
            <button class="btn" id="nsfw_ticket_inc">+1</button>
            <button class="btn" id="nsfw_ticket_reset">歸 0</button>
          </div>
        </div>
      </div>

      <!-- KPI 小總結 -->
      <div class="kpi">
        <div class="tile accent"><h4>今日</h4><div class="val" id="kpiDate">--</div></div>
        <div class="tile"><h4>未完成</h4><div class="val" id="kpiPending">0</div></div>
        <div class="tile ok"><h4>登入狀態</h4><div class="val" id="kpiAuth">本機</div></div>
      </div>
    </section>
  </div>
</div>

<!-- 下面開始：完整 script 區（雲端同步、提醒、邏輯全在這） -->
<script>
/* ============== 小工具 ============== */
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const toLocal5AM = (d=new Date()) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 5, 0, 0, 0);
function isTodayAfter5(now=new Date()){ return now >= toLocal5AM(now); }
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function inWeekend(d=new Date()){ const w=d.getDay(); return (w===0 || w===6); }
function fmtDate(d){ if(!d) return '--'; const x=new Date(d); return ymd(x); }
function nextAbyssBase(from){ const d=new Date(from), day=d.getDate(), m=d.getMonth(), y=d.getFullYear(); if(day<1)return new Date(y,m,1); if(day<16)return new Date(y,m,16); return new Date(y,m+1,1); }
function nextMonth1(from){ const d=new Date(from); return new Date(d.getFullYear(), d.getMonth()+1, 1); }
function next42(from){ const d=new Date(from); d.setDate(d.getDate()+42); return d; }

/* ============== 高亮動畫 ============== */
function flash(el, cls){
  if(!el) return;
  el.classList.remove('flash-green','flash-red');
  requestAnimationFrame(()=>{ el.classList.add(cls); setTimeout(()=>el.classList.remove('flash-green','flash-red'), 350); });
}

/* ============== 預設狀態 ============== */
function defaultState(){
  const today = new Date();
  const baseAbyss = nextAbyssBase(today);
  const basePoem  = nextMonth1(today);
  return {
    gsTw:{ resin:{val:160,last:Date.now()}, daily:{last:null}, abyss:{next:baseAbyss,done:false}, poem:{next:basePoem,done:false}, ver:{next:next42(today)} },
    gsAs:{ resin:{val:160,last:Date.now()}, daily:{last:null}, abyss:{next:baseAbyss,done:false}, poem:{next:basePoem,done:false}, ver:{next:next42(today)} },
    hsr :{
      daily:{last:null},
      mem:{next:new Date('2025-10-27'),done:false},
      pure:{next:new Date('2025-11-24'),done:false},
      ape:{next:new Date('2025-11-10'),done:false},
      arbi:{next:new Date('2025-11-05'),done:false},
      ver:{next:new Date('2025-11-05')}
    },
    hoyo:{ daily:{last:null} },
    zzz :{ daily:{last:null}, energy:240 },
    cats:{ daily:{last:null}, weekend:{last:null} },
    pogo:{ spin:{last:null}, catch:{last:null} },
    noti:{ daily:{last:null} },
    nsfw:{ daily:{last:null}, ticket:0 },
    meta:{ lastReset:null }
  };
}

/* 深度合併（以 default 補缺） */
function deepMergeDefaults(def, cur){
  if(cur===undefined || cur===null) return def;
  if(Array.isArray(def) || Array.isArray(cur)) return (cur ?? def);
  if(typeof def!=='object' || typeof cur!=='object') return (cur ?? def);
  const out = {...cur}; for(const k of Object.keys(def)) out[k] = deepMergeDefaults(def[k], cur[k]); return out;
}

/* ============== 本機儲存 ============== */
const LS_KEY = 'daily_state_v1';
function loadLocal(){ try{ const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):null; }catch(e){ return null; } }
function saveLocal(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

/* ============== Firebase ============== */
const firebaseConfig = {
  apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
  authDomain: "eyvind95-182f0.firebaseapp.com",
  projectId: "eyvind95-182f0",
  storageBucket: "eyvind95-182f0.firebasestorage.app",
  messagingSenderId: "105770576221",
  appId: "1:105770576221:web:dd3a57ce4e051bda91a0b4"
};
if(!firebase.apps.length){ firebase.initializeApp(firebaseConfig); }
const db = firebase.firestore();
let CURRENT_UID = null;
const provider = new firebase.auth.GoogleAuthProvider();
provider.setCustomParameters({ prompt:'select_account' });

function userDoc(){ return db.collection('daily').doc(CURRENT_UID); }
async function cloudLoad(){ if(!CURRENT_UID) return null; const s=await userDoc().get(); return s.exists ? s.data() : null; }
async function cloudSave(state){ if(!CURRENT_UID) return; await userDoc().set(state); }

/* ============== 全域狀態 ============== */
let STATE = null;

/* ============== 換日（05:00） ============== */
function ensureDailyReset(){
  const now = new Date();
  const dayToken = ymd(isTodayAfter5(now)?now:addDays(now,-1));
  if(STATE.meta.lastReset === dayToken) return;

  function resetDaily(obj){
    if(!obj) return;
    for(const k of Object.keys(obj)){
      const v = obj[k];
      if(v && typeof v==='object' && 'last' in v) v.last = null;
    }
  }
  resetDaily(STATE.gsTw); resetDaily(STATE.gsAs); resetDaily(STATE.hsr); resetDaily(STATE.hoyo);
  resetDaily(STATE.zzz); resetDaily(STATE.cats); resetDaily(STATE.pogo); resetDaily(STATE.noti); resetDaily(STATE.nsfw);

  if(inWeekend(now)) STATE.cats.weekend.last = null;

  STATE.meta.lastReset = dayToken;
}

/* ============== 原神樹脂自動回復（8 分 +1） ============== */
function tickResinAutoOne(node){
  const now=Date.now(); let {val,last}=node;
  if(val>=200){ node.val=200; node.last=now; return; }
  const mins=Math.floor((now-last)/60000); if(mins<=0) return;
  const add=Math.floor(mins/8);
  if(add>0){ node.val=Math.min(200, val+add); node.last=last+add*8*60000; }
}
function tickResinAuto(){ tickResinAutoOne(STATE.gsTw.resin); tickResinAutoOne(STATE.gsAs.resin); }
function etaTo200(resin){
  if(resin.val>=200) return '滿';
  const remain=200-resin.val, mins=remain*8, h=Math.floor(mins/60), m=mins%60;
  return `${h}小時 ${m}分`;
}

/* ============== 綁定：通用每日 ============== */
function bindDailyCheckbox(id, model){
  const el = document.getElementById(id);
  if(!el) return;
  el.checked = !!model.last;
  el.onchange = async ()=>{ model.last = el.checked ? Date.now() : null; await persist(); renderPending(); };
}
function setText(id, txt){ const el = (id[0]==='#') ? $(id) : document.getElementById(id); if(el) el.textContent = txt; }

/* ============== 原神（台/亞） ============== */
function bindGenshinOne(prefix, node){
  const v = id => document.getElementById(`${prefix}_${id}`);
  const view = v('resin_view'), eta=v('resin_eta');

  function paint(){ view.textContent=node.resin.val; eta.textContent = etaTo200(node.resin); }
  paint();
  v('resin_minus10').onclick = async ()=>{ node.resin.val=Math.max(0,node.resin.val-10); node.resin.last=Date.now(); paint(); flash(view,'flash-red'); await persist(); };
  v('resin_minus1').onclick  = async ()=>{ node.resin.val=Math.max(0,node.resin.val-1 ); node.resin.last=Date.now(); paint(); flash(view,'flash-red'); await persist(); };
  v('resin_plus1').onclick   = async ()=>{ node.resin.val=Math.min(200,node.resin.val+1 ); node.resin.last=Date.now(); paint(); flash(view,'flash-green'); await persist(); };
  v('resin_plus10').onclick  = async ()=>{ node.resin.val=Math.min(200,node.resin.val+10); node.resin.last=Date.now(); paint(); flash(view,'flash-green'); await persist(); };

  bindDailyCheckbox(`${prefix}_daily`, node.daily);

  setText(`${prefix}_abyss_next`, fmtDate(node.abyss.next));
  const ckA = v('abyss_done'); if(ckA){ ckA.checked=!!node.abyss.done; ckA.onchange=async()=>{ node.abyss.done=ckA.checked; await persist(); }; }

  setText(`${prefix}_poem_next`, fmtDate(node.poem.next));
  const ckP = v('poem_done'); if(ckP){ ckP.checked=!!node.poem.done; ckP.onchange=async()=>{ node.poem.done=ckP.checked; await persist(); }; }

  setText(`${prefix}_ver_next`, fmtDate(node.ver.next));
}

/* ============== 星穹鐵道 ============== */
function bindHSR(){
  bindDailyCheckbox('hsr_daily', STATE.hsr.daily);
  function one(key, labelId, ckId){
    setText(labelId, fmtDate(STATE.hsr[key].next));
    const ck = document.getElementById(ckId);
    if(ck){ ck.checked=!!STATE.hsr[key].done; ck.onchange=async()=>{ STATE.hsr[key].done=ck.checked; await persist(); }; }
  }
  one('mem','hsr_mem_next','hsr_mem_done');
  one('pure','hsr_pure_next','hsr_pure_done');
  one('ape','hsr_ape_next','hsr_ape_done');
  one('arbi','hsr_arbi_next','hsr_arbi_done');
  setText('hsr_ver_next', fmtDate(STATE.hsr.ver.next));
}

/* ============== HoyoLAB ============== */
function bindHoyo(){ bindDailyCheckbox('hoyo_daily', STATE.hoyo.daily); }

/* ============== 絕區零 ============== */
function bindZZZ(){
  bindDailyCheckbox('zzz_daily', STATE.zzz.daily);
  const view = $('#zzz_energy_view'); const paint=()=>{ view.textContent=STATE.zzz.energy; }; paint();
  $('#zzz_claim').onclick = async ()=>{
    STATE.zzz.energy = Math.min(STATE.zzz.energy+80, 960);
    if(STATE.zzz.energy>=960){ STATE.zzz.energy=240; flash(view,'flash-red'); }
    else flash(view,'flash-green');
    paint(); await persist();
  };
  $('#zzz_reset').onclick = async ()=>{ STATE.zzz.energy=240; paint(); flash(view,'flash-red'); await persist(); };
}

/* ============== 貓咪大戰爭 ============== */
function toggleWeekendRow(){ const row=$('#cats_weekend_row'); if(row) row.style.display = inWeekend() ? '' : 'none'; }
function bindCats(){
  bindDailyCheckbox('cats_daily', STATE.cats.daily);
  toggleWeekendRow();
  const ck = $('#cats_weekend');
  if(ck){ ck.checked = !!STATE.cats.weekend.last; ck.onchange = async ()=>{ STATE.cats.weekend.last = ck.checked ? Date.now() : null; await persist(); }; }
}

/* ============== Pokémon GO ============== */
function bindPoGo(){ bindDailyCheckbox('pogo_spin', STATE.pogo.spin); bindDailyCheckbox('pogo_catch', STATE.pogo.catch); }

/* ============== 諾提里森 ============== */
function bindNoti(){ bindDailyCheckbox('noti_daily', STATE.noti.daily); }

/* ============== 新世界狂歡 ============== */
function bindNSFW(){
  bindDailyCheckbox('nsfw_daily', STATE.nsfw.daily);
  const ctr=$('#nsfw_ticket_ctr'), inc=$('#nsfw_ticket_inc'), rst=$('#nsfw_ticket_reset');
  const paint=()=>{ ctr.textContent = `${STATE.nsfw.ticket} / 3`; }; paint();
  inc.onclick = async ()=>{ STATE.nsfw.ticket=(STATE.nsfw.ticket+1)%3; paint(); await persist(); };
  rst.onclick = async ()=>{ STATE.nsfw.ticket=0; paint(); await persist(); };
}

/* ============== 未完成數 & 提醒 ============== */
function renderPending(){
  const arr = [
    STATE.gsTw.daily, STATE.gsAs.daily, STATE.hsr.daily, STATE.hoyo.daily, STATE.zzz.daily,
    STATE.cats.daily, STATE.pogo.spin, STATE.pogo.catch, STATE.noti.daily, STATE.nsfw.daily
  ];
  const cnt = arr.filter(x => !x.last).length;
  setText('pendingCount', String(cnt));
  setText('kpiPending', String(cnt));
}
function scheduleLocalReminders(){
  function plan(hour){
    const now=new Date(), t=new Date(); t.setHours(hour,0,0,0);
    if(t<=now) t.setDate(t.getDate()+1);
    setTimeout(()=>{ renderPending(); const n=parseInt($('#pendingCount')?.textContent||'0',10); if(n>0) alert(`提醒：你還有 ${n} 個每日尚未完成喔！`); plan(hour); }, t-now);
  }
  plan(20); plan(22);
}

/* ============== 永久化 ============== */
async function persist(){ saveLocal(STATE); if(CURRENT_UID){ try{ await cloudSave(STATE); }catch(e){ console.error(e); } } }

/* ============== 登入 UI ============== */
function updateLoginUI(user){
  if(user){
    setText('who', `已登入：${user.email||'Google'}`);
    $('#btnLogin').style.display='none';
    $('#btnLogout').style.display='';
    setText('kpiAuth','雲端');
  }else{
    setText('who', '(未登入：僅本機)');
    $('#btnLogin').style.display='';
    $('#btnLogout').style.display='none';
    setText('kpiAuth','本機');
  }
}

/* ============== 渲染入口 ============== */
function renderAll(){
  setText('todayStr', ymd(new Date()));
  setText('kpiDate', ymd(new Date()));
  tickResinAuto();
  bindGenshinOne('gsTw', STATE.gsTw);
  bindGenshinOne('gsAs', STATE.gsAs);
  bindHSR(); bindHoyo(); bindZZZ(); bindCats(); bindPoGo(); bindNoti(); bindNSFW();
  renderPending();
}

/* ============== 啟動流程 ============== */
(async function bootstrap(){
  // SW：若 sw.js 存在就會成功
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }

  // 載入本機 → 補預設 → 換日 → 自動回復 → 存 → 渲染
  STATE = deepMergeDefaults(defaultState(), loadLocal() || {});
  ensureDailyReset(); tickResinAuto(); await persist(); renderAll();

  // Auth 監聽
  firebase.auth().onAuthStateChanged(async (user)=>{
    CURRENT_UID = user ? user.uid : null;
    updateLoginUI(user);
    try{
      if(user){
        const cloud = await cloudLoad();
        STATE = deepMergeDefaults(defaultState(), cloud || STATE || {});
      }else{
        STATE = deepMergeDefaults(defaultState(), loadLocal() || {});
      }
      ensureDailyReset(); tickResinAuto(); await persist(); renderAll();
    }catch(e){ console.error(e); }
  });

  // Login / Logout
  $('#btnLogin').onclick = async ()=>{
    try{ await firebase.auth().signInWithPopup(provider); }
    catch(e){
      const fb = ['auth/operation-not-supported-in-this-environment','auth/popup-blocked','auth/popup-closed-by-user'];
      if(fb.includes(e.code||'')) await firebase.auth().signInWithRedirect(provider);
      else alert('登入失敗：' + e.message);
    }
  };
  $('#btnLogout').onclick = async ()=>{ await firebase.auth().signOut(); };

  // 本地提醒＆每分鐘刷新
  scheduleLocalReminders();
  setInterval(()=>{ tickResinAuto(); toggleWeekendRow(); renderPending(); }, 60000);
})();
</script>
</body>
</html>
