<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>皮卡的每日任務</title>

  <!-- PWA -->
  <link rel="manifest" href="./daily.webmanifest" />
  <link rel="icon" href="./6.png" type="image/png" />
  <meta name="theme-color" content="#0b0b0b" />

  <style>
    :root{
      --bg:#0b0b0b;
      --panel:#101010cc;
      --border:#2a2a2a;
      --accent:#6ee7ff;
      --ok:#8cff9c;
      --muted:#bbb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:#fff;
      background:
        linear-gradient(rgba(0,0,0,.35),rgba(0,0,0,.35)),
        url("./6.png") center/cover no-repeat fixed,
        var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
    }
    @media (max-width:768px){ body{ background-attachment:scroll; } }
    .container{max-width:1000px; margin:24px auto; padding:0 12px;}
    header{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    h1{margin:0;font-size:22px}
    .who{color:var(--muted)}
    .btn{background:#1e293b;color:#fff;border:1px solid var(--border);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px}
    .card h2{margin:0 0 8px 0;font-size:18px;display:flex;align-items:center;gap:8px}
    .muted{color:var(--muted)}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:#111}
    input[type="number"]{width:90px;background:#0f172a;color:#fff;border:1px solid var(--border);border-radius:8px;padding:6px}
    .chk{display:flex;align-items:center;gap:6px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>皮卡的每日任務</h1>
      <span id="who" class="who">(未登入：本機紀錄)</span>
      <div style="flex:1"></div>
      <button id="fbLoginBtn" class="btn">登入 Google</button>
      <button id="fbLogoutBtn" class="btn" style="display:none;">登出</button>
    </header>

    <div class="card" style="margin-bottom:12px">
      <div class="row">
        <span class="muted">今天（05:00 作為跨日點）未完成每日：</span>
        <span id="pendingBadge" class="pill">0 個</span>
      </div>
    </div>

    <div id="content" class="grid"></div>
  </div>

  <!-- Firebase v8 compat -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
  /* ================= Firebase ================= */
  const firebaseConfig = {
    apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
    authDomain: "eyvind95-182f0.firebaseapp.com",
    projectId: "eyvind95-182f0",
    storageBucket: "eyvind95-182f0.firebasestorage.app",
    messagingSenderId: "105770576221",
    appId: "1:105770576221:web:dd3a57ce4e051bda91a0b4"
  };
  if(!firebase.apps.length){ firebase.initializeApp(firebaseConfig); }
  const db = firebase.firestore();
  const googleProvider = new firebase.auth.GoogleAuthProvider();
  googleProvider.setCustomParameters({ prompt: 'select_account' });

  /* =============== 工具 =============== */
  const CLIENT_ID = Math.random().toString(36).slice(2);
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const ymd = d => d.toISOString().slice(0,10);

  function load(key, fallback){ try{return JSON.parse(localStorage.getItem(key))||fallback;}catch(e){return fallback;} }
  function save(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

  function defaultState(){
    const today = new Date();
    return {
      // 勾選（每日、週末等）
      checks: {},

      // 原神體力（兩個帳號）
      gsAsia_resin: 160,      // 0~200
      gsTw_resin: 160,

      // 原神體力計時器（8分鐘 +1），null 表示未啟動
      resinTimerStart: null,

      // ZZZ 體力（滿 960，底 240）
      zzz_power: 480,

      // 新世界狂歡 金幣券
      ns_ticket: 2,
      ns_ticket_date: ymd(today),

      // 星穹鐵道 / 版本等固定日期
      genshin_ver_base: '2025-10-22',
      hsr_c_next: '2025-10-27',
      hsr_s_next: '2025-11-24',
      hsr_d_next: '2025-11-10',
      hsr_a_next: '2025-11-05',
      hsr_v_next: '2025-11-05',

      // 最近一次 05:00 重置過的日期（若不同就清每日）
      lastReset: ymd(today),

      // 雲端同步欄位
      _clientUpdatedAt: 0
    };
  }

  /* =============== 狀態/儲存（本機＋雲端） =============== */
  let CURRENT_UID = null;
  let STATE_KEY = 'daily_state_v1_anon';
  let state = load(STATE_KEY, defaultState());
  let cloudUnsub = null;
  let saveTimer = null;

  function persistLocal(){
    state._clientUpdatedAt = Date.now();
    save(STATE_KEY, state);
  }

  function userDailyDoc(){
    return db.collection('users').doc(CURRENT_UID)
             .collection('daily').doc('state');
  }

  async function cloudLoad(){
    const snap = await userDailyDoc().get();
    return snap.exists ? snap.data() : null;
  }

  async function cloudSaveDebounced(){
    persistLocal();
    if(!CURRENT_UID) return;               // 未登入只存本機
    if(saveTimer) clearTimeout(saveTimer); // 簡單去抖動
    saveTimer = setTimeout(async ()=>{
      try{
        await userDailyDoc().set({
          state,
          clientId: CLIENT_ID,
          clientUpdatedAt: state._clientUpdatedAt,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }catch(e){ console.warn('cloud save failed', e); }
    }, 400);
  }

  // 啟用雲端即時同步（避免循環：忽略自己 clientId）
  function startCloudWatch(){
    if(!CURRENT_UID){ if(cloudUnsub) cloudUnsub(); cloudUnsub=null; return; }
    if(cloudUnsub) cloudUnsub();

    cloudUnsub = userDailyDoc().onSnapshot(snap=>{
      const data = snap.data();
      if(!data) return;
      if(data.clientId === CLIENT_ID) return; // 自己剛寫入，忽略
      const remote = data.state || {};
      const rUpdated = Number(data.clientUpdatedAt||0);
      if(rUpdated > (state._clientUpdatedAt||0)){
        state = remote;
        STATE_KEY = 'daily_state_v1_' + (CURRENT_UID || 'anon');
        save(STATE_KEY, state);
        render();
      }
    });
  }

  // 登入/登出
  async function googleLogin(){
    try{
      await firebase.auth().signInWithPopup(googleProvider);
    }catch(e){
      if((e.code||'').includes('popup')) await firebase.auth().signInWithRedirect(googleProvider);
      else alert('登入失敗：' + e.message);
    }
  }
  async function googleLogout(){ await firebase.auth().signOut(); }

  document.addEventListener('click', ev=>{
    if(ev.target.id==='fbLoginBtn') googleLogin();
    if(ev.target.id==='fbLogoutBtn') googleLogout();
  });

  firebase.auth().onAuthStateChanged(async user=>{
    CURRENT_UID = user ? user.uid : null;
    STATE_KEY   = 'daily_state_v1_' + (CURRENT_UID || 'anon');

    // 取本機、雲端，選較新
    const local = load(STATE_KEY, defaultState());
    let newer = local;
    if(CURRENT_UID){
      try{
        const remote = await cloudLoad();
        if(remote){
          const r = remote.state || {};
          const rUpdated = Number(remote.clientUpdatedAt||0);
          if(rUpdated > (local._clientUpdatedAt||0)) newer = r;
        }
      }catch(e){ console.warn('cloud load failed', e); }
    }
    state = newer;
    persistLocal();     // 以選定的較新版本覆寫本機
    startCloudWatch();  // 啟動/關閉即時同步
    updateLoginUI(user);
    render();
  });

  function updateLoginUI(user){
    $('#who').textContent = user ? `已登入：${user.email}` : '(未登入：本機紀錄)';
    $('#fbLoginBtn').style.display = user ? 'none':'';
    $('#fbLogoutBtn').style.display = user ? '':'none';
  }

  /* ================= 功能區 ================= */

  // 05:00 為跨日：若過日就清「每日」勾選
  function ensureDailyReset(){
    const now = new Date();
    const cutoff = new Date(); cutoff.setHours(5,0,0,0);
    const last = state.lastReset ? new Date(state.lastReset) : new Date(0);
    if(now >= cutoff && ymd(last) !== ymd(now)){
      // 清「每日」前綴的項目
      for(const k of Object.keys(state.checks||{})){
        if(k.startsWith('daily:')) delete state.checks[k];
      }
      state.lastReset = ymd(now);
      cloudSaveDebounced();
    }
  }

  // 原神體力：8 分鐘 +1，滿 200；可手動調整
  function startResinTick(){
    if(state.resinTimerStart) return;
    state.resinTimerStart = Date.now();
    setInterval(()=>{
      const deltaMin = Math.floor((Date.now() - state.resinTimerStart)/60000);
      if(deltaMin <= 0) return;
      const inc = Math.floor(deltaMin/8);
      if(inc > 0){
        state.resinTimerStart = Date.now();
        state.gsAsia_resin = Math.min(200, state.gsAsia_resin + inc);
        state.gsTw_resin   = Math.min(200, state.gsTw_resin + inc);
        render();
        cloudSaveDebounced();
      }
    }, 60000);
  }

  // 計算未完成每日（label 以 daily: 前綴簡單辨識）
  function computePending(){
    const keys = Object.keys(state.checks||{});
    let n = 0;
    for(const k of keys){
      if(k.startsWith('daily:') && !state.checks[k]) n++;
    }
    return n;
  }

  /* ================= 渲染 ================= */

  function chk(id, label){
    const v = !!state.checks[id];
    return `
      <label class="chk">
        <input type="checkbox" ${v?'checked':''} data-chk="${id}" />
        <span>${label}</span>
      </label>
    `;
  }

  function render(){
    ensureDailyReset();
    $('#pendingBadge').textContent = computePending() + ' 個';

    $('#content').innerHTML = `
      <!-- 原神（亞服） -->
      <section class="card">
        <h2>原神（亞服）</h2>
        <div class="row">
          <span class="muted">體力</span>
          <input type="number" id="gsAsia" min="0" max="200" step="1" value="${state.gsAsia_resin}" />
          <span>/ 200</span>
          <button class="btn" id="gsAsiaPlus">+1</button>
          <button class="btn" id="gsAsiaMinus">-1</button>
          <button class="btn" id="resinTick">啟動+計時（每 8 分鐘 +1）</button>
        </div>
        <div class="row" style="margin-top:6px">
          ${chk('daily:gsAsia:commission','每日委託')}
          ${chk('gsAsia:abyss:1','淵月螺旋（每月1/16重置）')}
          ${chk('gsAsia:chronicle:1','劇詩（每月1號重置）')}
        </div>
      </section>

      <!-- 原神（台服） -->
      <section class="card">
        <h2>原神（台服）</h2>
        <div class="row">
          <span class="muted">體力</span>
          <input type="number" id="gsTw" min="0" max="200" step="1" value="${state.gsTw_resin}" />
          <span>/ 200</span>
          <button class="btn" id="gsTwPlus">+1</button>
          <button class="btn" id="gsTwMinus">-1</button>
        </div>
        <div class="row" style="margin-top:6px">
          ${chk('daily:gsTw:commission','每日委託')}
          ${chk('gsTw:abyss:1','淵月螺旋（每月1/16重置）')}
          ${chk('gsTw:chronicle:1','劇詩（每月1號重置）')}
        </div>
      </section>

      <!-- 絕區零 -->
      <section class="card">
        <h2>絕區零</h2>
        <div class="row">
          <span class="muted">體力</span>
          <input type="number" id="zzz" min="240" max="960" step="1" value="${state.zzz_power}" />
          <span>/ 960（底 240，滿則重置回 240）</span>
          <button class="btn" id="zzzDone">使用 +80</button>
        </div>
        <div class="row" style="margin-top:6px">
          ${chk('daily:zzz','每日')}
        </div>
      </section>

      <!-- HoYoLAB -->
      <section class="card">
        <h2>HoYoLAB</h2>
        <div class="row">
          ${chk('daily:hoyolab','每日')}
        </div>
      </section>

      <!-- 貓咪大戰爭 -->
      <section class="card">
        <h2>貓咪大戰爭</h2>
        <div class="row">
          ${chk('daily:bc','每日')}
          ${chk('weekend:bc','週末關卡（六/日）')}
        </div>
      </section>

      <!-- Pokémon GO -->
      <section class="card">
        <h2>Pokémon GO</h2>
        <div class="row">
          ${chk('daily:pogo:spin','轉一個補給站')}
          ${chk('daily:pogo:caught','捉一隻寶可夢')}
        </div>
      </section>

      <!-- 諾提里森 -->
      <section class="card">
        <h2>諾提里森</h2>
        <div class="row">
          ${chk('daily:note','每日')}
        </div>
      </section>

      <!-- 新世界狂歡 -->
      <section class="card">
        <h2>新世界狂歡</h2>
        <div class="row">
          ${chk('daily:nsc','每日')}
        </div>
        <div class="row" style="margin-top:6px">
          <span class="muted">金幣卷：</span>
          <span class="pill"><strong>${state.ns_ticket}</strong> / 3</span>
          <span class="muted">（每 3 天一次，現況日期：${state.ns_ticket_date}）</span>
          <button class="btn" id="nscUse">使用 1 張</button>
        </div>
      </section>

      <!-- 星穹鐵道：每日 + 排程 -->
      <section class="card">
        <h2>崩壞：星穹鐵道</h2>

        <!-- 每日 -->
        <div class="row" style="margin-bottom:8px">
          ${chk('daily:hsr','每日')}
        </div>

        <!-- 排程 -->
        <div class="row">
          <span class="muted">混沌回憶：</span><span class="pill">${state.hsr_c_next}</span>
          <span class="muted">虛構敘事：</span><span class="pill">${state.hsr_s_next}</span>
          <span class="muted">末日幻影：</span><span class="pill">${state.hsr_d_next}</span>
          <span class="muted">異相仲裁：</span><span class="pill">${state.hsr_a_next}</span>
          <span class="muted">版本更新：</span><span class="pill">${state.hsr_v_next}</span>
        </div>
      </section>
    `;

    // 綁定事件
    // 勾選
    $$('input[type="checkbox"][data-chk]').forEach(el=>{
      el.addEventListener('change', ()=>{
        state.checks[el.dataset.chk] = el.checked;
        cloudSaveDebounced();
        $('#pendingBadge').textContent = computePending() + ' 個';
      });
    });

    // 原神（亞）
    $('#gsAsia').addEventListener('change', e=>{
      state.gsAsia_resin = Math.max(0, Math.min(200, Number(e.target.value)||0));
      cloudSaveDebounced();
    });
    $('#gsAsiaPlus').addEventListener('click', ()=>{
      state.gsAsia_resin = Math.min(200, (state.gsAsia_resin||0)+1);
      $('#gsAsia').value = state.gsAsia_resin;
      cloudSaveDebounced();
    });
    $('#gsAsiaMinus').addEventListener('click', ()=>{
      state.gsAsia_resin = Math.max(0, (state.gsAsia_resin||0)-1);
      $('#gsAsia').value = state.gsAsia_resin;
      cloudSaveDebounced();
    });

    // 原神（台）
    $('#gsTw').addEventListener('change', e=>{
      state.gsTw_resin = Math.max(0, Math.min(200, Number(e.target.value)||0));
      cloudSaveDebounced();
    });
    $('#gsTwPlus').addEventListener('click', ()=>{
      state.gsTw_resin = Math.min(200, (state.gsTw_resin||0)+1);
      $('#gsTw').value = state.gsTw_resin;
      cloudSaveDebounced();
    });
    $('#gsTwMinus').addEventListener('click', ()=>{
      state.gsTw_resin = Math.max(0, (state.gsTw_resin||0)-1);
      $('#gsTw').value = state.gsTw_resin;
      cloudSaveDebounced();
    });

    // 啟動原神體力自動 +1
    $('#resinTick').addEventListener('click', ()=>{
      startResinTick();
      alert('已啟動：每 8 分鐘 +1（兩個帳號都會加）。');
    });

    // ZZZ
    $('#zzz').addEventListener('change', e=>{
      let v = Number(e.target.value)||240;
      v = Math.max(240, Math.min(960, v));
      state.zzz_power = v;
      cloudSaveDebounced();
    });
    $('#zzzDone').addEventListener('click', ()=>{
      let v = (state.zzz_power||240) + 80;
      if(v >= 960) v = 240;
      state.zzz_power = v;
      $('#zzz').value = v;
      cloudSaveDebounced();
    });

    // 新世界狂歡 金幣卷
    $('#nscUse').addEventListener('click', ()=>{
      if(state.ns_ticket > 0) state.ns_ticket -= 1;
      else state.ns_ticket = 0;
      $('#content').querySelector('.pill strong').textContent = state.ns_ticket;
      cloudSaveDebounced();
    });
  }

  /* =============== Service Worker 註冊 =============== */
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw-daily.js')
      .then(()=>console.log('SW registered'))
      .catch(e=>console.warn('SW failed',e));
  }

  // 初渲染
  render();
  </script>
</body>
</html>

