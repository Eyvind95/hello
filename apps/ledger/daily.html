<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>çš®å¡æ¯æ—¥ä»»å‹™</title>

<!-- PWA / Icons -->
<link rel="manifest" href="daily.webmanifest">
<link rel="icon" href="6.png">
<meta name="theme-color" content="#0b0b0b" />

<!-- Firebase v8 compat -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
  
<style>
:root{
  --bg:#0b0b0b;
  --panel:#151515cc;
  --tile:#101010cc;
  --muted:#bbbbbb;
  --accent:#6ee7ff;
  --ok:#8cff9c;
  --danger:#ff7b7b;
  --border:#2a2a2a;
}
*{box-sizing:border-box}
html,body{height:100%;}
body{
  margin:0; color:#fff;
  background:
    linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.25)),
    url("7.jpg") center/cover no-repeat fixed,
    var(--bg);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", "Helvetica Neue", Arial, sans-serif;
}
@media (max-width:768px){ body{ background-attachment:scroll; } }

.container{max-width:1080px; margin:20px auto; padding:0 12px;}
.header{
  display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
  background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:10px 12px; margin-bottom:12px;
}
h1{font-size:22px; margin:0;}
.header .right{display:flex; gap:8px; align-items:center;}
.btn{
  background:#202020; color:#fff; border:1px solid var(--border); border-radius:10px;
  padding:8px 10px; cursor:pointer;
}
.btn:hover{filter:brightness(1.08)}
.muted{color:var(--muted)}

.grid{
  display:grid; gap:12px;
  grid-template-columns: repeat(2, 1fr);
}
@media (max-width:900px){ .grid{grid-template-columns:1fr} }

.card{
  background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:12px;
}
.card h2{margin:0 0 8px 0; font-size:18px}
.card .sub{font-size:12px; color:var(--muted); margin-top:-4px; margin-bottom:8px}

.game{
  background:var(--tile); border:1px solid var(--border); border-radius:14px; padding:10px; margin-top:10px;
}
.game .top{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
.game .title{display:flex; align-items:center; gap:8px}
.game img.icon{width:28px; height:28px; border-radius:6px; object-fit:cover; background:#333}
.badge{font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); color:#ddd}

.g-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:7px 8px; border-top:1px dashed #2a2a2a; }
.g-left{ color:#ddd; }
.g-right{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.ck{ display:inline-flex; align-items:center; gap:6px; }
.ck input{ width:18px; height:18px; }
.pill{ background:#202020; border:1px solid var(--border); border-radius:999px; padding:4px 8px; font-size:12px; }
.pill.ok{ color:var(--ok) }
.pill.bad{ color:var(--danger) }
.small{ font-size:12px; color:#aaa; }
.val{ font-variant-numeric:tabular-nums; }

.sep{ height:8px }

.footer-note{ color:#aaa; font-size:12px; margin-top:12px; text-align:center; }
.counter .val,
.pill-val,
.resin .val,
.stamina .val,
.gs-resin-val {
  background:#0d0d0d !important;
  color:#fff !important;
  border:1px solid var(--border, #2a2a2a);
  border-radius:999px;
  padding:6px 12px;
  font-weight:700;
  min-width:64px; text-align:center;
}

/* ---- + / - æŒ‰éˆ•åŸºç¤æ¨£å¼ ---- */
.counter .btn,
.btn-inc, .btn-dec {
  background:#1b1b1b;
  border:1px solid var(--border, #2a2a2a);
  color:#fff;
  width:28px; height:28px;
  border-radius:999px;
  display:grid; place-items:center;
  cursor:pointer; user-select:none;
}

/* åŠ è™Ÿï¼ˆç¶ è‰²ï¼‰ */
.btn-plus, .btn-inc {
  background:rgba(34,197,94,.14);
  border-color:#22c55e;
  color:#86efac;
}

/* æ¸›è™Ÿï¼ˆç´…è‰²ï¼‰ */
.btn-minus, .btn-dec {
  background:rgba(239,68,68,.14);
  border-color:#ef4444;
  color:#fda4af;
}

/* æ•¸å­—è¼¸å…¥æ¡†å¦‚æœæœ‰ç”¨åˆ°ä¹Ÿå¼·åˆ¶ç™½å­— */
input[type="number"].val,
.resin input[type="number"],
.stamina input[type="number"]{
  color:#fff !important;
}
/* === çµ•å€é›¶é«”åŠ›æŒ‰éˆ•é¡è‰²è¨­å®š === */

/* +80 â†’ ç¶ è‰² */
#zzz_claim {
  background: rgba(34,197,94,.15);
  border: 1px solid #22c55e;
  color: #86efac;
}

/* æ»¿äº†é‡ç½®åˆ°240 â†’ ç´…è‰² */
#zzz_reset {
  background: rgba(239,68,68,.15);
  border: 1px solid #ef4444;
  color: #fda4af;
}

</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1>çš®å¡æ¯æ—¥ä»»å‹™</h1>
      <div class="muted small">ä»Šå¤©ï¼ˆ<span id="todayStr"></span>ï¼‰05:00 ä½œç‚ºæ›æ—¥é»ï½œæœªå®Œæˆæ¯æ—¥ï¼š<span id="pendingCount" class="val">0</span> å€‹</div>
    </div>
    <div class="right">
      <span id="who" class="muted">(æœªç™»å…¥ï¼šåƒ…æœ¬æ©Ÿ)</span>
      <button class="btn" id="btnLogin">Google ç™»å…¥</button>
      <button class="btn" id="btnLogout" style="display:none">ç™»å‡º</button>
    </div>
  </div>

  <div class="grid">
    <!-- å·¦æ¬„ -->
    <section class="card">
      <h2>ç±³å®¶ä¸‰å…„å¼Ÿ</h2><div class="sub">åŸç¥ï¼ˆå°/äºï¼‰ã€å´©å£ï¼šæ˜Ÿç©¹éµé“ã€HoyoLAB</div>

      <!-- åŸç¥ï¼ˆå°æœï¼‰ -->
      <div class="game" id="gs-tw">
        <div class="top">
          <div class="title">
            <img class="icon" src="a.jpg" onerror="this.src='6.png'">
            <strong>åŸç¥ãƒ»å°æœ</strong>
          </div>
          <span class="badge">æ¯æ—¥ï¼‹æœˆæ›´</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¨¹è„‚ï¼ˆ8 åˆ†é˜ +1 ï¼ Max 200ï¼‰</div>
          <div class="g-right">
            <button class="pill" id="gsTw_resin_minus10">-10</button>
            <button class="pill" id="gsTw_resin_minus1">-1</button>
            <span class="pill val" id="gsTw_resin_view">160</span>
            <button class="pill" id="gsTw_resin_plus1">+1</button>
            <button class="pill" id="gsTw_resin_plus10">+10</button>
            <span class="small">ï¼ˆè·é›¢æ»¿ï¼š<span id="gsTw_resin_eta" class="val">--</span>ï¼‰</span>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥å§”è¨—</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="gsTw_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">æ·µæœˆèºæ—‹ï¼ˆæ¯æœˆ 1 ï¼† 16ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="gsTw_abyss_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsTw_abyss_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">åŠ‡è©©ï¼ˆæ¯æœˆ 1ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="gsTw_poem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsTw_poem_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">ç‰ˆæœ¬æ›´æ–°ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="gsTw_ver_next" class="val">--</span></span>
          </div>
        </div>
      </div>

      <!-- åŸç¥ï¼ˆäºæœï¼‰ -->
      <div class="game" id="gs-as">
        <div class="top">
          <div class="title">
            <img class="icon" src="a.jpg" onerror="this.src='6.png'">
            <strong>åŸç¥ãƒ»äºæœ</strong>
          </div>
          <span class="badge">æ¯æ—¥ï¼‹æœˆæ›´</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¨¹è„‚ï¼ˆ8 åˆ†é˜ +1 ï¼ Max 200ï¼‰</div>
          <div class="g-right">
            <button class="pill" id="gsAs_resin_minus10">-10</button>
            <button class="pill" id="gsAs_resin_minus1">-1</button>
            <span class="pill val" id="gsAs_resin_view">160</span>
            <button class="pill" id="gsAs_resin_plus1">+1</button>
            <button class="pill" id="gsAs_resin_plus10">+10</button>
            <span class="small">ï¼ˆè·é›¢æ»¿ï¼š<span id="gsAs_resin_eta" class="val">--</span>ï¼‰</span>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥å§”è¨—</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="gsAs_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">æ·µæœˆèºæ—‹ï¼ˆæ¯æœˆ 1 ï¼† 16ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="gsAs_abyss_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsAs_abyss_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">åŠ‡è©©ï¼ˆæ¯æœˆ 1ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="gsAs_poem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsAs_poem_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">ç‰ˆæœ¬æ›´æ–°ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="gsAs_ver_next" class="val">--</span></span>
          </div>
        </div>
      </div>

      <!-- å´©å£ï¼šæ˜Ÿç©¹éµé“ -->
      <div class="game" id="hsr">
        <div class="top">
          <div class="title">
            <img class="icon" src="b.jpg" onerror="this.src='6.png'">
            <strong>å´©å£ï¼šæ˜Ÿç©¹éµé“</strong>
          </div>
          <span class="badge">æ¯æ—¥ï¼‹å¤šå€‹ 42 å¤©æª”æœŸ</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="hsr_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">æ··æ²Œå›æ†¶ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="hsr_mem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_mem_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">è™›æ§‹æ•˜äº‹ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="hsr_pure_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_pure_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">æœ«æ—¥å¹»å½±ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="hsr_ape_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_ape_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">ç•°ç›¸ä»²è£ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="hsr_arbi_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_arbi_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">ç‰ˆæœ¬æ›´æ–°ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right"><span class="small">ä¸‹æ¬¡ï¼š<span id="hsr_ver_next" class="val">--</span></span></div>
        </div>
      </div>

      <!-- HoyoLAB -->
      <div class="game" id="hoyo">
        <div class="top">
          <div class="title">
            <img class="icon" src="d.png" onerror="this.src='6.png'">
            <strong>HoyoLAB</strong>
          </div>
          <span class="badge">æ¯æ—¥</span>
        </div>
        <div class="g-row">
          <div class="g-left">æ¯æ—¥ç°½åˆ°</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="hoyo_daily"></label></div>
        </div>
      </div>
    </section>

    <!-- å³æ¬„ -->
    <section class="card">
      <h2>å…¶ä»–</h2><div class="sub">çµ•å€é›¶ã€è²“å’ªå¤§æˆ°çˆ­ã€PokÃ©mon GOã€è«¾æé‡Œæ£®ã€æ–°ä¸–ç•Œç‹‚æ­¡</div>

      <!-- çµ•å€é›¶ï¼ˆæ‡¶äººç‰ˆèƒ½é‡ï¼‰ -->
      <div class="game" id="zzz">
        <div class="top">
          <div class="title">
            <img class="icon" src="c.png" onerror="this.src='6.png'">
            <strong>çµ•å€é›¶</strong>
          </div>
          <span class="badge">æ¯æ—¥ï¼‹èƒ½é‡</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="zzz_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">é«”åŠ›ï¼ˆæ‡¶äººç‰ˆï¼‰</div>
          <div class="g-right">
            <span class="pill val" id="zzz_energy_view">240</span>
            <button class="pill" id="zzz_claim">æ”¶å– +80</button>
            <button class="pill" id="zzz_reset">æ»¿äº†é‡ç½®åˆ° 240</button>
            <span class="small">å€é–“ 240~960ï¼Œæ»¿å¾Œè‡ªå‹•å› 240</span>
          </div>
        </div>
      </div>

      <!-- è²“å’ªå¤§æˆ°çˆ­ -->
      <div class="game" id="cats">
        <div class="top">
          <div class="title">
            <img class="icon" src="e.jpg" onerror="this.src='6.png'">
            <strong>è²“å’ªå¤§æˆ°çˆ­</strong>
          </div>
          <span class="badge">é€±æœ«é™å®š</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="cats_daily"></label></div>
        </div>

        <div class="g-row" id="cats_weekend_row">
          <div class="g-left">é€±æœ«é—œå¡ï¼ˆå…­ã€æ—¥ï¼‰</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="cats_weekend"></label><span class="small">é€±æœ« 05:00 é‡ç½®</span></div>
        </div>
      </div>

      <!-- PokÃ©mon GO -->
      <div class="game" id="pogo">
        <div class="top">
          <div class="title">
            <img class="icon" src="f.jpg" onerror="this.src='6.png'">
            <strong>PokÃ©mon GO</strong>
          </div>
          <span class="badge">æ¯æ—¥</span>
        </div>
        <div class="g-row">
          <div class="g-left">è½‰ä¸€å€‹è£œçµ¦ç«™</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="pogo_spin"></label></div>
        </div>
        <div class="g-row">
          <div class="g-left">æ‰ä¸€éš»å¯¶å¯å¤¢</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="pogo_catch"></label></div>
        </div>
      </div>

      <!-- è«¾æé‡Œæ£® -->
      <div class="game" id="noti">
        <div class="top">
          <div class="title">
            <img class="icon" src="g.jpg" onerror="this.src='6.png'">
            <strong>è«¾æé‡Œæ£®</strong>
          </div>
          <span class="badge">æ¯æ—¥</span>
        </div>
        <div class="g-row">
          <div class="g-left">æ¯æ—¥</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="noti_daily"></label></div>
        </div>
      </div>

      <!-- æ–°ä¸–ç•Œç‹‚æ­¡ -->
      <div class="game" id="nsfw">
        <div class="top">
          <div class="title">
            <img class="icon" src="h.jpg" onerror="this.src='6.png'">
            <strong>æ–°ä¸–ç•Œç‹‚æ­¡</strong>
          </div>
          <span class="badge">æ¯æ—¥ï¼‹é‡‘å¹£å·</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="nsfw_daily"></label></div>
        </div>

        <div class="g-row">
   <div class="g-left">é‡‘å¹£å·ï¼ˆ3 å¤©ä¸€æ¬¡ï¼Œå¾ªç’° 0â†’1â†’2â†’0ï¼‰</div>
  <div class="g-right">
    <span class="pill val" id="nsfw_ticket_ctr">0 / 3</span>
    <button class="pill btn-plus" id="nsfw_ticket_inc">+1</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer-note">â€» æ™šä¸Š 20:00 èˆ‡ 22:00 è‹¥å°šæœ‰ã€Œæ¯æ—¥ã€æœªæ‰“å‹¾ï¼Œæœƒåœ¨å‰ç«¯æé†’ï¼ˆéœ€åœ¨ç¶²é å‰æ™¯é–‹è‘—ï¼‰ã€‚</div>
</div>

<script>
/* ------------ å°å·¥å…· ------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const toLocal5AM = (d=new Date()) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 5, 0, 0, 0);
function isTodayAfter5(now=new Date()){
  return now >= toLocal5AM(now);
}
function inWeekend(d=new Date()){
  const w = d.getDay(); // 0 Sun
  return (w === 0 || w === 6);
}
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function fmtDate(d){ if(!d) return '--'; const x=new Date(d); return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`; }
function nextAbyssBase(from){ // æ¯æœˆ 1 & 16
  const d = new Date(from);
  const day = d.getDate();
  const m = d.getMonth();
  const y = d.getFullYear();
  if(day < 1){ return new Date(y, m, 1); }
  if(day < 16){ return new Date(y, m, 16); }
  return new Date(y, m+1, 1);
}
function nextMonth1(from){
  const d = new Date(from);
  return new Date(d.getFullYear(), d.getMonth()+1, 1);
}
function next42(from){
  const d = new Date(from);
  d.setDate(d.getDate()+42);
  return d;
}

/* ------------ é è¨­ç‹€æ…‹ ------------- */
function defaultState(){
  const today = new Date();
  const baseAbyss = nextAbyssBase(today);
  const basePoem  = nextMonth1(today);

  return {
    // åŸç¥ï¼šå°ã€äº
    gsTw:{
      resin:{ val:160, last: Date.now() }, // 8 åˆ†é˜ +1ï¼Œmax 200
      daily:{ last:null },
      abyss:{ next: baseAbyss, done:false },
      poem: { next: basePoem , done:false },
      ver:  { next: next42(today) }
    },
    gsAs:{
      resin:{ val:160, last: Date.now() },
      daily:{ last:null },
      abyss:{ next: baseAbyss, done:false },
      poem: { next: basePoem , done:false },
      ver:  { next: next42(today) }
    },
    // æ˜Ÿç©¹éµé“
    hsr:{
      daily:{ last:null },
      mem: { next: new Date('2025-10-27'), done:false },
      pure:{ next: new Date('2025-11-24'), done:false },
      ape: { next: new Date('2025-11-10'), done:false },
      arbi:{ next: new Date('2025-11-05'), done:false },
      ver: { next: new Date('2025-11-05') }
    },
    // HoyoLAB
    hoyo:{ daily:{ last:null } },
    // ZZZ
    zzz:{ daily:{ last:null }, energy:240 },
    // è²“å’ª
    cats:{ daily:{ last:null }, weekend:{ last:null } },
    // POGO
    pogo:{ spin:{ last:null }, catch:{ last:null } },
    // è«¾æ
    noti:{ daily:{ last:null } },
    // æ–°ä¸–ç•Œç‹‚æ­¡
    nsfw:{ daily:{ last:null }, ticket:0 },

    // å…ƒè³‡è¨Šï¼šé‡ç½®é»èˆ‡ä»Šå¤©å­—ä¸²
    meta:{
      lastReset: null // å„²å­˜ã€Œä¸Šä¸€æ¬¡ 05:00 æ›æ—¥å¾Œçš„æ—¥æœŸ(yyyy-mm-dd)ã€
    }
  };
}

/* æ·±åº¦åˆä½µï¼ˆç”¨ default è£œç¼ºï¼Œä¸è¦†è“‹ç¾æœ‰å€¼ï¼‰ */
function deepMergeDefaults(def, cur){
  if (cur === undefined || cur === null) return def;
  if (Array.isArray(def) || Array.isArray(cur)) return cur ?? def;
  if (typeof def !== 'object' || typeof cur !== 'object') return (cur === undefined || cur === null) ? def : cur;
  const out = {...cur};
  for (const k of Object.keys(def)){
    out[k] = deepMergeDefaults(def[k], cur[k]);
  }
  return out;
}

/* ------------ æœ¬æ©Ÿå„²å­˜ ------------- */
const LS_KEY = "daily_state_v1";
function loadLocal(){
  try{ const raw=localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; }
}
function saveLocal(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

// --- Firebase åˆå§‹åŒ–ï¼ˆä½ å·²ç¶“æœ‰ï¼Œä¿æŒä¸å‹•ï¼‰ ---
const firebaseConfig = {
  apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
  authDomain: "eyvind95-182f0.firebaseapp.com",
  projectId: "eyvind95-182f0",
  storageBucket: "eyvind95-182f0.firebasestorage.app",
  messagingSenderId: "105770576221",
  appId: "1:105770576221:web:dd3a57ce4e051bda91a0b4"
};
if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const db = firebase.firestore();
/* ========== Firebase Cloud Messaging (æ¨æ’­é€šçŸ¥) ========== */
let messaging = null;
try {
  if (firebase.messaging && 'Notification' in window) {
    messaging = firebase.messaging();
  } else {
    console.warn('æ­¤ç’°å¢ƒä¸æ”¯æ´é€šçŸ¥æˆ–ç¼ºå°‘ messaging SDK');
  }
} catch (e) {
  console.warn('åˆå§‹åŒ– messaging å¤±æ•—ï¼š', e);
  messaging = null;
}

const VAPID_KEY = "BHwAITz4c7tcvzHApW6ZzMU9DOIZ0ZpiKbufVx1Uq46io--d2mvbcVmve9_wsxFzaQrOapYpMOi0oNRsxmbgVPY";

async function initFCM() {
  if (!messaging) return; // æ²’æœ‰å°±ä¸è¦åšï¼Œé¿å…ä¸­æ–·å…¶ä»–åŠŸèƒ½

  try {
    // è¨»å†Šå°ˆç”¨çš„ Messaging SWï¼ˆèˆ‡å¿«å– SW å…±å­˜æ²’å•é¡Œï¼‰
    const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
    messaging.useServiceWorker(reg);

    const perm = await Notification.requestPermission();
    if (perm !== 'granted') {
      console.warn('ä½¿ç”¨è€…æœªæˆæ¬Šé€šçŸ¥');
      return;
    }

    const token = await messaging.getToken({ vapidKey: VAPID_KEY });
    console.log('ğŸ“¢ FCM Token:', token);

    if (CURRENT_UID && token) {
      await db.collection('tokens').doc(CURRENT_UID).set({ token });
    }

    messaging.onMessage(payload => {
      const { title, body } = payload.notification || {};
      if (title) new Notification(title, { body });
    });
// === æœ¬åœ°æ¸¬è©¦ç”¨ï¼šæ¯ 30 ç§’è‡ªå‹•é¡¯ç¤ºä¸€æ¬¡é€šçŸ¥ ===
setInterval(() => {
  if (Notification.permission === 'granted') {
    new Notification("ğŸ“¢ æ¸¬è©¦é€šçŸ¥", {
      body: "é€™æ˜¯æ¯æ—¥ä»»å‹™é€šçŸ¥æ¸¬è©¦ï¼ˆæ¯ 30 ç§’ï¼‰",
      icon: "./6.png" // ä½ ç¶²ç«™åœ–ç¤ºï¼Œå¯æ›æˆ Pikachu é‚£å¼µ
    });
  }
}, 30000);
    
  } catch (err) {
    console.error('FCM åˆå§‹åŒ–å¤±æ•—ï¼š', err);
  }
}
// --- é‡è¦ï¼šçµ±ä¸€ç”¨ googleProvider é€™å€‹åå­— ---
let CURRENT_UID = null;
const googleProvider = new firebase.auth.GoogleAuthProvider();
googleProvider.setCustomParameters({ prompt: 'select_account' });

// Firestore è·¯å¾‘ï¼š/daily/<UID>
function userDoc() {
  return db.collection('daily').doc(CURRENT_UID);
}

// è®€å¯«é›²ç«¯
async function cloudLoad(){
  if(!CURRENT_UID) return null;
  const snap = await userDoc().get();
  return snap.exists ? snap.data() : null;
}
async function cloudSave(state){
  if(!CURRENT_UID) return;
  await userDoc().set(state, { merge:true }); // merge ä»¥å…è¦†è“‹
}
/* ------------ å…¨åŸŸç‹€æ…‹ ------------- */
let STATE = null;

/* ------------ æ›æ—¥é‚è¼¯ï¼ˆ05:00ï¼‰ ------------- */
function ensureDailyReset(){
  const now = new Date();
  const dayToken = ymd(isTodayAfter5(now) ? now : addDays(now,-1)); // ç•¶å¤© 05:00 ä¹‹å¾Œç®—ä»Šå¤©ï¼›å¦å‰‡ç®—æ˜¨å¤©
  if(STATE.meta.lastReset === dayToken) return;

  // é€šç”¨çš„ã€Œæ¯æ—¥ã€æ¬„ä½ï¼šæŠŠ last æ¸…æ‰ï¼ˆè¡¨ç¤ºå¯å‹¾ï¼‰
  function resetDaily(obj){
    if(!obj) return;
    Object.keys(obj).forEach(k=>{
      const v = obj[k];
      if(v && typeof v === 'object' && 'last' in v){
        v.last = null;
      }
    });
  }

  // é‡ç½®å„å€å¡Š
  resetDaily(STATE.gsTw);
  resetDaily(STATE.gsAs);
  resetDaily(STATE.hsr);
  resetDaily(STATE.hoyo);
  resetDaily(STATE.zzz);
  resetDaily(STATE.cats);
  resetDaily(STATE.pogo);
  resetDaily(STATE.noti);
  resetDaily(STATE.nsfw);

  // é€±æœ«é—œå¡ï¼šåªè¦åœ¨é€±æœ«ï¼ˆå…­æ—¥ï¼‰ï¼Œæ¯å¤©é‡ç½®ä¸€æ¬¡
  if(inWeekend(now)){
    STATE.cats.weekend.last = null;
  }

  STATE.meta.lastReset = dayToken;
}

/* ------------ åŸç¥æ¨¹è„‚è‡ªå‹•å›å¾© ------------- */
function tickResinAutoOne(node){
  const now = Date.now();
  let {val,last} = node;
  if(val>=200){ node.val=200; node.last=now; return; }
  const mins = Math.floor((now - last)/60000);
  if(mins <= 0) return;
  const add = Math.floor(mins/8);
  if(add>0){
    node.val = Math.min(200, val + add);
    node.last = last + add*8*60000;
  }
}
function tickResinAuto(){
  tickResinAutoOne(STATE.gsTw.resin);
  tickResinAutoOne(STATE.gsAs.resin);
}

/* ------------ UI ç¶å®š ------------- */
// é€šç”¨ã€Œæ¯æ—¥ checkboxã€
function bindDailyCheckbox(idPath, model){
  const el = document.getElementById(idPath);
  if(!el) return;
  el.checked = !!model.last;
  el.onchange = async ()=>{
    model.last = el.checked ? Date.now() : null;
    await persist();
    renderPending();
  }
}
function bindSpin(id, model){ // POGO
  const el = document.getElementById(id);
  el.checked = !!model.last;
  el.onchange = async ()=>{ model.last = el.checked ? Date.now() : null; await persist(); renderPending(); }
}
function bindPoGo(idCatch, idSpin){
  bindSpin(idSpin, STATE.pogo.spin);
  bindSpin(idCatch, STATE.pogo.catch);
}

function setText(id, txt){ const el=$(id.startsWith('#')?id:('#'+id)); if(el) el.textContent=txt; }

function etaTo200(resin){
  if(resin.val>=200) return 'æ»¿';
  const remain = 200 - resin.val;
  const mins = remain*8; // åˆ†é˜
  const h = Math.floor(mins/60);
  const m = mins % 60;
  return `${h}å°æ™‚ ${m}åˆ†`;
}

/* åŸç¥å€ï¼šå°/äº ç¶å®š */
function bindGenshinOne(prefix, node){
  const v = id => document.getElementById(prefix + '_' + id);

  // æ¨¹è„‚
  const view = v('resin_view'), eta = v('resin_eta');
  function paintResin(){
    view.textContent = node.resin.val;
    eta.textContent = etaTo200(node.resin);
  }
  v('resin_minus10').onclick = async ()=>{ node.resin.val = Math.max(0, node.resin.val-10); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_minus1').onclick  = async ()=>{ node.resin.val = Math.max(0, node.resin.val-1 ); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_plus1').onclick   = async ()=>{ node.resin.val = Math.min(200, node.resin.val+1 ); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_plus10').onclick  = async ()=>{ node.resin.val = Math.min(200, node.resin.val+10); node.resin.last=Date.now(); paintResin(); await persist(); };
  paintResin();

  // æ¯æ—¥
  bindDailyCheckbox(prefix+"_daily", node.daily);

  // èºæ—‹
  setText(prefix+"_abyss_next", fmtDate(node.abyss.next));
  const ckA = v('abyss_done'); ckA.checked = !!node.abyss.done;
  ckA.onchange = async ()=>{ node.abyss.done = ckA.checked; await persist(); };

  // åŠ‡è©©
  setText(prefix+"_poem_next", fmtDate(node.poem.next));
  const ckP = v('poem_done'); ckP.checked = !!node.poem.done;
  ckP.onchange = async ()=>{ node.poem.done = ckP.checked; await persist(); };

  // ç‰ˆæœ¬
  setText(prefix+"_ver_next", fmtDate(node.ver.next));
}

/* æ˜Ÿç©¹éµé“ */
function bindHSR(){
  bindDailyCheckbox("hsr_daily", STATE.hsr.daily);

  function one(key, labelId, ckId){
    setText(labelId, fmtDate(STATE.hsr[key].next));
    const ck = document.getElementById(ckId);
    ck.checked = !!STATE.hsr[key].done;
    ck.onchange = async ()=>{ STATE.hsr[key].done = ck.checked; await persist(); };
  }
  one('mem', "hsr_mem_next", "hsr_mem_done");
  one('pure',"hsr_pure_next","hsr_pure_done");
  one('ape',"hsr_ape_next","hsr_ape_done");
  one('arbi',"hsr_arbi_next","hsr_arbi_done");
  setText("hsr_ver_next", fmtDate(STATE.hsr.ver.next));
}

/* HoyoLAB */
function bindHoyo(){ bindDailyCheckbox("hoyo_daily", STATE.hoyo.daily); }

/* ZZZï¼ˆæ‡¶äººç‰ˆï¼‰ */
function bindZZZ(){
  bindDailyCheckbox("zzz_daily", STATE.zzz.daily);

  const view = $("#zzz_energy_view");
  function paint(){ view.textContent = STATE.zzz.energy; }
  paint();

  $("#zzz_claim").onclick = async ()=>{
    STATE.zzz.energy = Math.min(STATE.zzz.energy + 80, 960);
    if (STATE.zzz.energy >= 960) STATE.zzz.energy = 240;
    paint(); await persist();
  };
  $("#zzz_reset").onclick = async ()=>{ STATE.zzz.energy = 240; paint(); await persist(); };
}

/* è²“å’ªï¼šé€±æœ«è¡Œé¡¯ç¤ºæ§ç®¡ */
function toggleWeekendRow(){
  const row = $("#cats_weekend_row");
  if(!row) return;
  row.style.display = inWeekend() ? "" : "none";
}
function bindCats(){
  bindDailyCheckbox("cats_daily", STATE.cats.daily);
  toggleWeekendRow();
  const ck = $("#cats_weekend");
  if(ck){
    ck.checked = !!STATE.cats.weekend.last;
    ck.onchange = async ()=>{ STATE.cats.weekend.last = ck.checked ? Date.now() : null; await persist(); };
  }
}

/* POGO */
function bindPoGoAll(){ bindPoGo("pogo_catch", "pogo_spin"); }

/* è«¾æé‡Œæ£® */
function bindNoti(){ bindDailyCheckbox("noti_daily", STATE.noti.daily); }

/* æ–°ä¸–ç•Œç‹‚æ­¡ï¼ˆè‡ªå‹•å¾ªç’° 0â†’1â†’2â†’0ï¼‰ */
function bindNSFW(){
  bindDailyCheckbox("nsfw_daily", STATE.nsfw.daily);
  const ctr = $("#nsfw_ticket_ctr");
  const inc = $("#nsfw_ticket_inc");

  function paint(){ ctr.textContent = `${STATE.nsfw.ticket} / 3`; }
  paint();

  inc.onclick = async () => {
    STATE.nsfw.ticket = (STATE.nsfw.ticket + 1) % 3;
    paint();
    await persist();
  };
}

/* ------------ Pending çµ±è¨ˆ & æé†’ ------------- */
function renderPending(){
  // çµ±è¨ˆæ‰€æœ‰ã€Œæ¯æ—¥ã€é‚„æ²’æ‰“å‹¾çš„
  const arr = [
    STATE.gsTw.daily, STATE.gsAs.daily, STATE.hsr.daily, STATE.hoyo.daily, STATE.zzz.daily,
    STATE.cats.daily, STATE.pogo.spin, STATE.pogo.catch, STATE.noti.daily, STATE.nsfw.daily
  ];
  const cnt = arr.filter(x => !x.last).length;
  $("#pendingCount").textContent = cnt;
}
function scheduleLocalReminders(){
  // å‰ç«¯ç°¡å–®ä¿¡æ¯ï¼š20:00 / 22:00 è‹¥ pending>0 å°± alertï¼ˆé é¢é–‹è‘—æ‰æœƒè§¸ç™¼ï¼‰
  function plan(hour){
    const now = new Date(), t = new Date();
    t.setHours(hour,0,0,0);
    if(t <= now) t.setDate(t.getDate()+1);
    const ms = t - now;
    setTimeout(()=>{ renderPending(); const n=parseInt($("#pendingCount").textContent||"0",10);
      if(n>0) alert(`æé†’ï¼šä½ é‚„æœ‰ ${n} å€‹æ¯æ—¥å°šæœªå®Œæˆå–”ï¼`);
      plan(hour); // çºŒç´„
    }, ms);
  }
  plan(20); plan(22);
}

/* ------------ æ¸²æŸ“ ------------- */
function render(){
  // æ—¥æœŸæ¢
  const now = new Date();
  $("#todayStr").textContent = ymd(now);

  // æµç¨‹ï¼šè‡ªå‹•å›å¾©æ¨¹è„‚ â†’ æ¸²æŸ“å„å¡Š
  tickResinAuto();

  // Genshin
  bindGenshinOne("gsTw", STATE.gsTw);
  bindGenshinOne("gsAs", STATE.gsAs);

  // HSR / Hoyo / ZZZ / Cats / PoGo / Noti / NSFW
  bindHSR(); bindHoyo(); bindZZZ(); bindCats(); bindPoGoAll(); bindNoti(); bindNSFW();

  renderPending();
}

/* ------------ æ°¸ä¹…åŒ–ï¼ˆé›²ç«¯å„ªå…ˆï¼‰ ------------- */
async function persist(){
  saveLocal(STATE);
  if(CURRENT_UID){
    try{ await cloudSave(STATE); }catch(e){ console.error(e); }
  }
}

// æ›´æ–°å³ä¸Šè§’ç™»å…¥ç‹€æ…‹
function updateLoginUI(user){
  if(user){
    document.getElementById("who").textContent = `å·²ç™»å…¥ï¼š${user.email || 'Google'}`;
    document.getElementById("btnLogin").style.display = "none";
    document.getElementById("btnLogout").style.display = "";
  }else{
    document.getElementById("who").textContent = "(æœªç™»å…¥ï¼šåƒ…æœ¬æ©Ÿ)";
    document.getElementById("btnLogin").style.display = "";
    document.getElementById("btnLogout").style.display = "none";
  }
}
/* è‡ªå‹•æ›¿æŒ‰éˆ•åŠ ä¸Šé¡è‰² classï¼ˆä¾ç…§æ–‡å­—å…§å®¹ + / -ï¼‰ */
function colorizePlusMinus(){
  document.querySelectorAll('.counter .btn, .btn-inc, .btn-dec, button').forEach(b=>{
    const t = (b.textContent || '').trim();
    // å…ˆæ¸…æ‰èˆŠæ¨™è¨˜
    b.classList.remove('btn-plus','btn-minus');
    // åˆ¤æ–·å­—é¢ä¸Šæ˜¯å¦æ˜¯ + æˆ– -
    if (t.startsWith('+')) b.classList.add('btn-plus');
    if (t.startsWith('-')) b.classList.add('btn-minus');
  });
}
/* å¦‚æœä½ æœ‰ render() æˆ–åˆå§‹åŒ–ï¼Œçµå°¾å‘¼å«ä¸€ä¸‹ */
window.addEventListener('load', colorizePlusMinus);
/* è‹¥ä½ çš„é é¢æœ‰é‡æ–°æ¸²æŸ“ UI çš„æµç¨‹ï¼Œè¨˜å¾—åœ¨ render() çµå°¾ä¹ŸåŠ ä¸Š colorizePlusMinus(); */

/* ------------ å•Ÿå‹• ------------- */
(async function bootstrap(){
  // Service Workerï¼ˆè‹¥æª”æ¡ˆå­˜åœ¨å°±æœƒè¨»å†ŠæˆåŠŸï¼‰
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw-daily.js').catch(()=>{});
  }

  // è¼‰å…¥ç‹€æ…‹ï¼ˆé›²ç«¯æˆ–æœ¬æ©Ÿï¼‰â†’ åˆä½µé è¨­ â†’ 05:00 æ›æ—¥ â†’ è‡ªå‹•å›å¾© â†’ å­˜ â†’ æ¸²æŸ“
  let local = loadLocal();
  STATE = deepMergeDefaults(defaultState(), local||{});

  ensureDailyReset();
  tickResinAuto();
  await persist();
  render();

  // Google Auth ç›£è½
firebase.auth().onAuthStateChanged(async (user)=>{
  CURRENT_UID = user ? user.uid : null;
  updateLoginUI(user);

  try{
    if(user){
      // å…ˆè®€é›² â†’ åˆä½µ local â†’ å­˜å›é›²ï¼ˆè®“é›²ç«¯é•·å‡º /daily/<UID>ï¼‰
      const cloud = await cloudLoad();         // å¯èƒ½ç‚º nullï¼ˆç¬¬ä¸€æ¬¡ï¼‰
      const local = loadLocal() || {};         // ä½ åŸæœ¬çš„æœ¬æ©Ÿå­˜å–
      STATE = deepMergeDefaults(defaultState(), cloud || local || {});
      ensureDailyReset(); tickResinAuto();
      await cloudSave(STATE);                  // å¯«å›é›²ï¼ˆç¬¬ä¸€æ¬¡å°±æœƒå»ºç«‹æ–‡ä»¶ï¼‰
      saveLocal(STATE);                        // é †ä¾¿è¦†è“‹æœ¬æ©Ÿä¸€è‡´
      render();
    }else{
      // ç™»å‡ºå°±å›æœ¬æ©Ÿ
      const local = loadLocal() || {};
      STATE = deepMergeDefaults(defaultState(), local);
      ensureDailyReset(); tickResinAuto(); saveLocal(STATE); render();
    }
  }catch(err){
    console.error(err);
  }
});

document.getElementById("btnLogin").addEventListener("click", async () => {
  try{
    await firebase.auth().signInWithPopup(googleProvider);
  }catch(e){
    const fallback = [
      "auth/operation-not-supported-in-this-environment",
      "auth/popup-blocked",
      "auth/popup-closed-by-user",
    ];
    if (fallback.includes(e.code || "")) {
      await firebase.auth().signInWithRedirect(googleProvider);
    }else{
      alert("ç™»å…¥å¤±æ•—ï¼š" + e.message);
    }
  }
});
document.getElementById("btnLogout").addEventListener("click", async () => {
  await firebase.auth().signOut();
});
  // å‰ç«¯æé†’æ’ç¨‹
  scheduleLocalReminders();

  // æ¯åˆ†é˜ tick æ¨¹è„‚ä¸€æ¬¡ & æª¢æŸ¥é€±æœ«è¡Œé¡¯ç¤º
  setInterval(()=>{ tickResinAuto(); toggleWeekendRow(); renderPending(); }, 60000);
  initFCM();
})();
</script>
</body>
</html>


