<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>皮卡每日任務</title>

<!-- PWA / Icons -->
<link rel="manifest" href="daily.webmanifest">
<link rel="icon" href="6.png">
<meta name="theme-color" content="#0b0b0b" />
  
<!-- Firebase v8 compat（不載入 messaging） -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
<style>
:root{
  --bg:#0b0b0b;
  --panel:#151515cc;
  --tile:#101010cc;
  --muted:#bbbbbb;
  --accent:#6ee7ff;
  --ok:#8cff9c;
  --danger:#ff7b7b;
  --border:#2a2a2a;
}
*{box-sizing:border-box}
html,body{height:100%;}
body{
  margin:0; color:#fff;
  background:
    linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.25)),
    url("7.jpg") center/cover no-repeat fixed,
    var(--bg);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", "Helvetica Neue", Arial, sans-serif;
}
@media (max-width:768px){ body{ background-attachment:scroll; } }

.container{max-width:1080px; margin:20px auto; padding:0 12px;}
.header{
  display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
  background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:10px 12px; margin-bottom:12px;
}
h1{font-size:22px; margin:0;}
.header .right{display:flex; gap:8px; align-items:center;}
.btn{
  background:#202020; color:#fff; border:1px solid var(--border); border-radius:10px;
  padding:8px 10px; cursor:pointer;
}
.btn:hover{filter:brightness(1.08)}
.muted{color:var(--muted)}

.grid{
  display:grid; gap:12px;
  grid-template-columns: repeat(2, 1fr);
}
@media (max-width:900px){ .grid{grid-template-columns:1fr} }

.card{
  background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:12px;
}
.card h2{margin:0 0 8px 0; font-size:18px}
.card .sub{font-size:12px; color:var(--muted); margin-top:-4px; margin-bottom:8px}

.game{
  background:var(--tile); border:1px solid var(--border); border-radius:14px; padding:10px; margin-top:10px;
}
.game .top{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
.game .title{display:flex; align-items:center; gap:8px}
.game img.icon{width:28px; height:28px; border-radius:6px; object-fit:cover; background:#333}
.badge{font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); color:#ddd}

.g-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:7px 8px; border-top:1px dashed #2a2a2a; }
.g-left{ color:#ddd; }
.g-right{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.ck{ display:inline-flex; align-items:center; gap:6px; }
.ck input{ width:18px; height:18px; }
.pill{ background:#202020; border:1px solid var(--border); border-radius:999px; padding:4px 8px; font-size:12px; }
.pill.ok{ color:var(--ok) }
.pill.bad{ color:var(--danger) }
.small{ font-size:12px; color:#aaa; }
.val{ font-variant-numeric:tabular-nums; }

.sep{ height:8px }

.footer-note{ color:#aaa; font-size:12px; margin-top:12px; text-align:center; }

/* 數值膠囊 */
.counter .val,
.pill-val,
.resin .val,
.stamina .val,
.gs-resin-val {
  background:#0d0d0d !important;
  color:#fff !important;
  border:1px solid var(--border, #2a2a2a);
  border-radius:999px;
  padding:6px 12px;
  font-weight:700;
  min-width:64px; text-align:center;
}

/* + / - 按鈕基礎樣式 */
.counter .btn,
.btn-inc, .btn-dec {
  background:#1b1b1b;
  border:1px solid var(--border, #2a2a2a);
  color:#fff;
  width:28px; height:28px;
  border-radius:999px;
  display:grid; place-items:center;
  cursor:pointer; user-select:none;
}
/* 加號（綠） */
.btn-plus, .btn-inc { background:rgba(34,197,94,.14); border-color:#22c55e; color:#86efac; }
/* 減號（紅） */
.btn-minus, .btn-dec { background:rgba(239,68,68,.14); border-color:#ef4444; color:#fda4af; }

/* 絕區零體力按鈕色 */
#zzz_claim { background: rgba(34,197,94,.15); border: 1px solid #22c55e; color: #86efac; }
#zzz_reset { background: rgba(239,68,68,.15); border: 1px solid #ef4444; color: #fda4af; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1>皮卡每日任務</h1>
      <div class="muted small">今天（<span id="todayStr"></span>）05:00 作為換日點｜未完成每日：<span id="pendingCount" class="val">0</span> 個</div>
    </div>
    <div class="right">
      <span id="who" class="muted">(未登入：僅本機)</span>
      <button class="btn" id="btnLogin">Google 登入</button>
      <button class="btn" id="btnLogout" style="display:none">登出</button>
    </div>
  </div>

  <div class="grid">
    <!-- 左欄 -->
    <section class="card">
      <h2>米家三兄弟</h2><div class="sub">原神（台/亞）、崩壞：星穹鐵道、HoyoLAB</div>

      <!-- 原神（台服） -->
      <div class="game" id="gs-tw">
        <div class="top">
          <div class="title">
            <img class="icon" src="a.jpg" onerror="this.src='6.png'">
            <strong>原神・台服</strong>
          </div>
          <span class="badge">每日＋月更</span>
        </div>

        <div class="g-row">
          <div class="g-left">樹脂（8 分鐘 +1 ／ Max 200）</div>
          <div class="g-right">
            <button class="pill" id="gsTw_resin_minus200">-200</button>
            <button class="pill" id="gsTw_resin_minus10">-10</button>
            <button class="pill" id="gsTw_resin_minus1">-1</button>
            <span class="pill val" id="gsTw_resin_view">160</span>
            <button class="pill" id="gsTw_resin_plus1">+1</button>
            <button class="pill" id="gsTw_resin_plus10">+10</button>
            <span class="small">（距離滿：<span id="gsTw_resin_eta" class="val">--</span>）</span>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">每日委託</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="gsTw_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">淵月螺旋（每月 16）</div>
          <div class="g-right">
            <span class="small">下次：<span id="gsTw_abyss_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsTw_abyss_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">劇詩（每月 1）</div>
          <div class="g-right">
            <span class="small">下次：<span id="gsTw_poem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsTw_poem_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">版本更新（42 天）</div>
          <div class="g-right">
            <span class="small">下次：<span id="gsTw_ver_next" class="val">--</span></span>
          </div>
        </div>
      </div>

      <!-- 原神（亞服） -->
      <div class="game" id="gs-as">
        <div class="top">
          <div class="title">
            <img class="icon" src="a.jpg" onerror="this.src='6.png'">
            <strong>原神・亞服</strong>
          </div>
          <span class="badge">每日＋月更</span>
        </div>

        <div class="g-row">
          <div class="g-left">樹脂（8 分鐘 +1 ／ Max 200）</div>
          <div class="g-right">
            <button class="pill" id="gsAs_resin_minus200">-200</button>
            <button class="pill" id="gsAs_resin_minus10">-10</button>
            <button class="pill" id="gsAs_resin_minus1">-1</button>
            <span class="pill val" id="gsAs_resin_view">160</span>
            <button class="pill" id="gsAs_resin_plus1">+1</button>
            <button class="pill" id="gsAs_resin_plus10">+10</button>
            <span class="small">（距離滿：<span id="gsAs_resin_eta" class="val">--</span>）</span>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">每日委託</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="gsAs_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">淵月螺旋（每月 16）</div>
          <div class="g-right">
            <span class="small">下次：<span id="gsAs_abyss_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsAs_abyss_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">劇詩（每月 1）</div>
          <div class="g-right">
            <span class="small">下次：<span id="gsAs_poem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsAs_poem_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">版本更新（42 天）</div>
          <div class="g-right"><span class="small">下次：<span id="gsAs_ver_next" class="val">--</span></span></div>
        </div>
      </div>

      <!-- 崩壞：星穹鐵道 -->
      <div class="game" id="hsr">
        <div class="top">
          <div class="title">
            <img class="icon" src="b.jpg" onerror="this.src='6.png'">
            <strong>崩壞：星穹鐵道</strong>
          </div>
          <span class="badge">每日＋多個 42 天檔期</span>
        </div>

        <div class="g-row">
          <div class="g-left">每日</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="hsr_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">混沌回憶（42 天）</div>
          <div class="g-right">
            <span class="small">下次：<span id="hsr_mem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_mem_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">虛構敘事（42 天）</div>
          <div class="g-right">
            <span class="small">下次：<span id="hsr_pure_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_pure_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">末日幻影（42 天）</div>
          <div class="g-right">
            <span class="small">下次：<span id="hsr_ape_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_ape_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">異相仲裁（42 天）</div>
          <div class="g-right">
            <span class="small">下次：<span id="hsr_arbi_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_arbi_done"> 本輪狀態</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">版本更新（42 天）</div>
          <div class="g-right"><span class="small">下次：<span id="hsr_ver_next" class="val">--</span></span></div>
        </div>
      </div>

      <!-- HoyoLAB -->
      <div class="game" id="hoyo">
        <div class="top">
          <div class="title">
            <img class="icon" src="d.png" onerror="this.src='6.png'">
            <strong>HoyoLAB</strong>
          </div>
          <span class="badge">每日</span>
        </div>
        <div class="g-row">
          <div class="g-left">每日簽到</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="hoyo_daily"></label></div>
        </div>
      </div>
    </section>

    <!-- 右欄 -->
    <section class="card">
      <h2>其他</h2><div class="sub">絕區零、貓咪大戰爭、Pokémon GO、諾提里森、新世界狂歡</div>

      <!-- 絕區零 -->
      <div class="game" id="zzz">
        <div class="top">
          <div class="title">
            <img class="icon" src="c.png" onerror="this.src='6.png'">
            <strong>絕區零</strong>
          </div>
          <span class="badge">每日＋能量</span>
        </div>

        <div class="g-row">
          <div class="g-left">每日</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="zzz_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">體力（懶人版）</div>
          <div class="g-right">
            <span class="pill val" id="zzz_energy_view">240</span>
            <button class="pill" id="zzz_claim">收取 +80</button>
            <button class="pill" id="zzz_reset">滿了重置到 240</button>
            <span class="small">區間 240~960，滿後自動回 240</span>
          </div>
        </div>
      </div>

      <!-- 貓咪大戰爭 -->
      <div class="game" id="cats">
        <div class="top">
          <div class="title">
            <img class="icon" src="e.jpg" onerror="this.src='6.png'">
            <strong>貓咪大戰爭</strong>
          </div>
          <span class="badge">週末限定</span>
        </div>

        <div class="g-row">
          <div class="g-left">每日</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="cats_daily"></label></div>
        </div>

        <div class="g-row" id="cats_weekend_row">
          <div class="g-left">週末關卡（六、日）</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="cats_weekend"></label><span class="small">週末 05:00 重置</span></div>
        </div>
      </div>

      <!-- Pokémon GO -->
      <div class="game" id="pogo">
        <div class="top">
          <div class="title">
            <img class="icon" src="f.jpg" onerror="this.src='6.png'">
            <strong>Pokémon GO</strong>
          </div>
          <span class="badge">每日</span>
        </div>
        <div class="g-row">
          <div class="g-left">轉一個補給站</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="pogo_spin"></label></div>
        </div>
        <div class="g-row">
          <div class="g-left">捉一隻寶可夢</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="pogo_catch"></label></div>
        </div>
      </div>

      <!-- 諾提里森 -->
      <div class="game" id="noti">
        <div class="top">
          <div class="title">
            <img class="icon" src="g.jpg" onerror="this.src='6.png'">
            <strong>諾提里森</strong>
          </div>
          <span class="badge">每日</span>
        </div>
        <div class="g-row">
          <div class="g-left">每日</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="noti_daily"></label></div>
        </div>
      </div>

      <!-- 新世界狂歡 -->
      <div class="game" id="nsfw">
        <div class="top">
          <div class="title">
            <img class="icon" src="h.jpg" onerror="this.src='6.png'">
            <strong>新世界狂歡</strong>
          </div>
          <span class="badge">每日＋金幣卷</span>
        </div>

        <div class="g-row">
          <div class="g-left">每日</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="nsfw_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">金幣卷（3 天一次，循環 0→1→2→0）</div>
          <div class="g-right">
            <span class="pill val" id="nsfw_ticket_ctr">0 / 3</span>
            <button class="pill btn-inc" id="nsfw_ticket_inc">+1</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer-note">※ 晚上 20:00 與 22:00 若尚有「每日」未打勾，會在前端提醒（需在網頁前景開著）。</div>
</div>

<!-- 下面接 Script（見第 2 段） -->
<script>
/* =========================
   小工具 & 日期函式（數值時間戳版本）
   ========================= */
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const y2 = n => String(n).padStart(2,'0');
const ymd = d => `${d.getFullYear()}-${y2(d.getMonth()+1)}-${y2(d.getDate())}`;

// 今天 05:00 的 Date 物件
const toLocal5AM = (d=new Date()) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 5, 0, 0, 0);

function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function fmtDate(d){ if(d==null) return '--'; const x=(d instanceof Date)?d:new Date(d); return ymd(x); }
function inWeekend(d=new Date()){ const w=d.getDay(); return (w===0||w===6); }

// 方便運算：回傳「某年月日 05:00」的數值時間戳
function tsAt5(y, m/*0-based*/, d){ return +new Date(y, m, d, 5, 0, 0, 0); }
// 今天 05:00 的數值時間戳
function now5ts(now=new Date()){ return tsAt5(now.getFullYear(), now.getMonth(), now.getDate()); }

/* —— 淵月（每月 16 號 05:00）→ 回傳 number —— */
function nextAbyssBase(from = new Date()) {
  const base5 = now5ts(from);
  const y = from.getFullYear(), m = from.getMonth();
  const this16 = tsAt5(y, m, 16);
  const next16 = tsAt5(y, m+1, 16);
  return (this16 > base5) ? this16 : next16; // number
}
function nextAbyssAfter(now = new Date()) { return nextAbyssBase(now); }

/* —— 劇詩（每月 1 號 05:00）→ 回傳 number —— */
function nextMonth1After(now = new Date()){
  const base5 = now5ts(now);
  const y = now.getFullYear(), m = now.getMonth();
  const this1 = tsAt5(y, m, 1);
  const next1 = tsAt5(y, m+1, 1);
  return (this1 > base5) ? this1 : next1;    // number
}

/* —— 42 天週期（推到今天 05:00 之後）→ 回傳 number —— */
function next42(from){
  const start = (from instanceof Date) ? +from : Number(from);
  const base5 = now5ts(new Date());
  if (!Number.isFinite(start)) return base5;
  // 以 from 的「當地日子」組 05:00，然後每次加 42 天直到超過今天 05:00
  const f = new Date(start);
  let cur = tsAt5(f.getFullYear(), f.getMonth(), f.getDate());
  const STEP = 42 * 24 * 60 * 60 * 1000;
  while (cur <= base5) cur += STEP;
  return cur; // number
}

/* —— 「今天」的日鍵：以 05:00 為分日界 —— */
function dayKey(now = new Date()){
  const five = toLocal5AM(now);
  return (now < five) ? ymd(addDays(five,-1)) : ymd(five);
}

/* —— 將 last 正規化為日鍵（支援 null / timestamp / Date / 'YYYY-MM-DD'） —— */
function normalizeLastToKey(last){
  if (!last) return null;
  if (typeof last==='string') return last;
  if (typeof last==='number') return dayKey(new Date(last));
  if (last instanceof Date)   return dayKey(last);
  return null;
}

/* —— 以「天數」把 next 一路推到今天(05:00)之後 → 回傳 number —— */
function advanceByDaysUntilFuture(nextDate, periodDays){
  if (!nextDate || !periodDays) return Number(nextDate) || null;
  const base5 = now5ts(new Date());
  let cur = (nextDate instanceof Date) ? +nextDate : Number(nextDate);
  if (!Number.isFinite(cur)) return base5;
  // 以 cur 當地日子重設到 05:00
  const d = new Date(cur);
  cur = tsAt5(d.getFullYear(), d.getMonth(), d.getDate());
  const STEP = periodDays * 24 * 60 * 60 * 1000;
  while (cur <= base5) cur += STEP;
  return cur; // number
}

/* =========================
   預設狀態（依你提供的結構）
   ========================= */
function defaultState(){
  const today = new Date();
  const baseAbyss = nextAbyssAfter(today);   // number
  const basePoem  = nextMonth1After(today);  // number
  return {
    gsTw:{ resin:{ val:160, last: Date.now() }, daily:{ last:null },
           abyss:{ next:+baseAbyss, done:false },
           poem:{  next:+basePoem,  done:false },
           ver:{   next:+next42(today) } },
    gsAs:{ resin:{ val:160, last: Date.now() }, daily:{ last:null },
           abyss:{ next:+baseAbyss, done:false },
           poem:{  next:+basePoem,  done:false },
           ver:{   next:+next42(today) } },
hsr:{
  daily:{ last:null },

  // 重要：不要用 'YYYY-MM-DD' 字串（UTC 會飄），用數字建構 + 鎖 05:00
  mem:  { next:+new Date(2026, 2,  2, 5, 0, 0, 0), done:false }, // 混沌回憶  2026/03/02 05:00
  pure: { next:+new Date(2026, 1, 16, 5, 0, 0, 0), done:false }, // 虛構敘事  2026/02/16 05:00
  ape:  { next:+new Date(2026, 1,  2, 5, 0, 0, 0), done:false }, // 末日幻影  2026/02/02 05:00
  arbi: { next:+new Date(2026, 1, 13, 5, 0, 0, 0), done:false }, // 異相仲裁  2026/02/13 05:00
  ver: { next:+new Date(2026, 1, 13, 5, 0, 0, 0), done:false }, // 版本更新  2026/02/13 05:00

  // ver 你前面已經在處理 42 天版本錨點了，這裡保留你現有的寫法即可
  // ver: { next: +next42(HSR_VER_BASE) },
},
    hoyo:{ daily:{ last:null } },
    zzz: { daily:{ last:null }, energy:240 },
    cats:{ daily:{ last:null }, weekend:{ last:null } },
    pogo:{ spin:{ last:null }, catch:{ last:null } },
    noti:{ daily:{ last:null } },
    nsfw:{ daily:{ last:null }, ticket:0 },
    meta:{ lastReset: null }
  };
}

/* =========================
   本機儲存
   ========================= */
const LS_KEY = "daily_state_v1";
function loadLocal(){ try{ const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):null; }catch(_){ return null; } }
function saveLocal(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

/* =========================
   Firebase 初始化 / Firestore
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
  authDomain: "eyvind95-182f0.firebaseapp.com",
  projectId: "eyvind95-182f0",
  storageBucket: "eyvind95-182f0.firebasestorage.app",
  messagingSenderId: "105770576221",
  appId: "1:105770576221:web:dd3a57ce4e051bda91a0b4"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let CURRENT_UID = null;
const googleProvider = new firebase.auth.GoogleAuthProvider();
googleProvider.setCustomParameters({ prompt: 'select_account' });

function userDoc(){ return db.collection('daily').doc(CURRENT_UID); }

/* =========================
   FCM（前端）自動註冊與上傳 token  v2025-10-23
   需求：已載入 v8 的 firebase-app/auth/firestore/messaging
   ========================= */

const VAPID_PUBLIC_KEY = 'BHwAITz4c7tcvzHApW6ZzMU9DOIZ0ZpiKbufVx1Uq46io--d2mvbcVmve9_wsxFzaQrOapYpMOi0oNRsxmbgVPY';

// 1) 先拿 messaging；若環境不支援（非 HTTPS 或瀏覽器不支援），直接略過
let messaging = null;
try {
  messaging = firebase.messaging();
} catch (e) {
  console.warn('[FCM] 當前環境不支援 messaging：', e);
}

/** 取得/確保正確註冊的 SW（用絕對路徑與正確 scope） */
async function ensureSW() {
  if (!('serviceWorker' in navigator)) throw new Error('ServiceWorker not supported');
  const reg = await navigator.serviceWorker.register(
    '/hello/apps/ledger/firebase-messaging-sw.js',
    { scope: '/hello/apps/ledger/' }
  );
  // 若 SW 剛更新，請它立即接管（對應 SW 內的 skipWaiting/clients.claim）
  if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
  await navigator.serviceWorker.ready;
  return reg;
}

/** 申請通知權限（只有 default 情況才彈窗） */
async function ensureNotificationPermission() {
  if (!('Notification' in window)) throw new Error('Notification not supported');
  if (Notification.permission === 'default') {
    await Notification.requestPermission();
  }
  return Notification.permission === 'granted';
}

/** 寫 token 至 /daily/<uid>/tokens/<token>，避免重複寫入 */
async function upsertTokenToFirestore(uid, token) {
  const docRef = userDoc().collection('tokens').doc(token);
  await docRef.set({
    token,
    ua: navigator.userAgent,
    platform: navigator.platform || null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
  localStorage.setItem('fcm-token', token);
  console.log('[FCM] token 已寫入 Firestore：', token.slice(0, 12) + '…');
}

/** 取得 token 並上傳（會檢查權限、SW、以及是否真的改變） */
async function ensurePushToken(reg, uid) {
  if (!messaging) return null;

  const granted = await ensureNotificationPermission();
  if (!granted) { console.warn('[FCM] 使用者未允許通知'); return null; }

  const token = await messaging.getToken({
    vapidKey: VAPID_PUBLIC_KEY,
    serviceWorkerRegistration: reg
  });

  if (!token) { console.warn('[FCM] getToken() 回傳空'); return null; }

  const last = localStorage.getItem('fcm-token');
  if (token !== last) {
    await upsertTokenToFirestore(uid, token);
  } else {
    // 仍以 merge:true 再寫一次，確保 serverTimestamp 更新（可改為註解以減少寫入）
    await upsertTokenToFirestore(uid, token);
  }

  return token;
}

/** 前景訊息處理（Actions 走 data-only，不會觸發這個；若之後用 notification 欄位可在前景顯示） */
if (messaging) {
  messaging.onMessage((payload) => {
    console.log('[FCM] 前景訊息：', payload);
    // 你可以在這顯示一個前景 toast/snackbar
  });
}

/** 監聽 token 變更（瀏覽器或 SW 更新、權限重置等） */
async function bindTokenRefresh(reg, uid) {
  if (!messaging || !messaging.onTokenRefresh) return;
  messaging.onTokenRefresh(async () => {
    try {
      const newToken = await messaging.getToken({
        vapidKey: VAPID_PUBLIC_KEY,
        serviceWorkerRegistration: reg
      });
      if (!newToken) return;
      await upsertTokenToFirestore(uid, newToken);
      console.log('[FCM] token refreshed');
    } catch (e) {
      console.error('[FCM] refresh token 失敗', e);
    }
  });
}

/** 與登入流程串接 */
firebase.auth().onAuthStateChanged(async (user) => {
  CURRENT_UID = user ? user.uid : null;
  if (typeof updateLoginUI === 'function') updateLoginUI(user);

  if (!user || !messaging) return;

  try {
    const reg = await ensureSW();
    await ensurePushToken(reg, user.uid);
    await bindTokenRefresh(reg, user.uid);
  } catch (e) {
    console.error('[FCM] 初始化失敗：', e);
  }
});

// 可選：登出時清理本機快取（不刪雲端，保留裝置清單）
async function clearLocalFcmCacheOnSignOut() {
  localStorage.removeItem('fcm-token');
}

/* =========================
   雲端讀寫
   ========================= */
async function cloudLoad(){ if(!CURRENT_UID) return null; const snap=await userDoc().get(); return snap.exists ? snap.data() : null; }
async function cloudSave(state){ if(!CURRENT_UID) return; await userDoc().set(state, { merge:true }); }

/* =========================
   深度合併/序列化工具
   ========================= */
function deepMergeDefaults(def, cur){
  if (cur===undefined || cur===null) return def;
  if (Array.isArray(def) || Array.isArray(cur)) return cur ?? def;
  if (typeof def!=='object' || typeof cur!=='object') return (cur===undefined||cur===null)?def:cur;
  const out = {...cur};
  for (const k of Object.keys(def)){ out[k] = deepMergeDefaults(def[k], cur[k]); }
  return out;
}
function normalizeForSave(s){
  const j = JSON.parse(JSON.stringify(s));
  const fix = (node)=>{
    if(!node || typeof node!=='object') return;
    for(const k in node){
      const v = node[k];
      if(v instanceof Date){ node[k]=+v; }
      else if(v && typeof v==='object'){ fix(v); }
    }
  };
  fix(j);
  return j;
}

/* =========================
   樹脂自動回復（你原本的邏輯，略加防呆）
   ========================= */
function tickResinAutoOne(node){
  try{
    const now = Date.now();
    if (!node || typeof node!=='object') return;
    if (!Number.isFinite(node.val)) node.val = 0;
    if (typeof node.last!=='number'){ const t=Date.parse(node.last); node.last = Number.isFinite(t)?t:now; }
    if (node.val >= 200){ node.val=200; node.last=now; return; }
    const mins = Math.floor((now - node.last)/60000);
    if (mins < 8) return;
    const add = Math.floor(mins / 8);
    if (add <= 0) return;
    node.val = Math.min(200, node.val + add);
    node.last = node.last + add*8*60000;
  }catch(e){ console.error('tickResinAutoOne', e); }
}
function tickResinAuto(){
  try{
    tickResinAutoOne(STATE.gsTw.resin);
    tickResinAutoOne(STATE.gsAs.resin);
  }catch(e){ console.error('tickResinAuto', e); }
}
function etaTo200(resin){
  try{
    if(!resin || !Number.isFinite(resin.val)) return '-';
    if(resin.val>=200) return '滿';
    const remain=200-resin.val, mins=remain*8, h=Math.floor(mins/60), m=mins%60;
    return `${h}小時${m}分`;
  }catch(e){ return '-'; }
}
/* ===== 共用：限制/更新/重繪 ===== */
function clampResin(v){ return Math.max(0, Math.min(200, v|0)); }

function renderResin(which){ // which: 'gsTw' | 'gsAs'
  const r = STATE[which].resin;
  const viewId = `#${which}_resin_view`;
  const etaId  = `#${which}_resin_eta`;
  const v = (r && Number.isFinite(r.val)) ? r.val : 0;
  const show = document.querySelector(viewId);
  const eta  = document.querySelector(etaId);
  if (show) show.textContent = v;
  if (eta)  eta.textContent  = etaTo200(STATE[which].resin);
}

function setResin(which, value){
  const r = STATE[which].resin;
  r.val  = clampResin(value);
  r.last = Date.now();         // 以現在當作最新變動點
  renderResin(which);
  // 有存檔函式就叫它（沒有也不會壞）
  if (typeof saveStateDebounced === 'function') saveStateDebounced();
}

function addResin(which, delta){
  const r = STATE[which].resin;
  setResin(which, (Number.isFinite(r.val) ? r.val : 0) + delta);
}

/* ===== 事件綁定：台服 ===== */
// 選 A：-200
const twMinus200 = document.querySelector('#gsTw_resin_minus200');
if (twMinus200) twMinus200.addEventListener('click', ()=> addResin('gsTw', -200));

/* ===== 事件綁定：亞服 ===== */
// 選 A：-200
const asMinus200 = document.querySelector('#gsAs_resin_minus200');
if (asMinus200) asMinus200.addEventListener('click', () => addResin('gsAs', -200));

/* =========================
   週期刷新（唯一來源）
   ========================= */
function refreshCyclesOnOne(obj, kind){
  let changed = false;
  const todayK = dayKey();

  if (kind==='daily' || kind==='spin' || kind==='catch' || kind==='weekend'){
    const lk = normalizeLastToKey(obj.last);
    if (lk && lk !== todayK){ obj.last = null; changed = true; }
  }

if (kind === 'abyss'){ // 淵月螺旋：以「今天」直接取下一個 1/16
  if (obj){
    const future = nextAbyssAfter(new Date());
    if (!obj.next || +future !== +new Date(obj.next)){
      obj.done = false;
      obj.next = +future;
      changed  = true;
    }
  }
}

if (kind === 'poem'){ // 劇詩：以「今天」直接取下一個每月 1 日
  if (obj){
    const future = nextMonth1After(new Date());
    if (!obj.next || +future !== +new Date(obj.next)){
      obj.done = false;
      obj.next = +future;
      changed  = true;
    }
  }
}
if (kind === 'ver'){
  if (obj && obj.next){
    const cur    = new Date(obj.next);
    const future = advanceByDaysUntilFuture(cur, 42);
    if (+future !== +cur){ if ('done' in obj) obj.done = false; obj.next = +future; changed = true; }
  }
}
if (kind === 'hsr42'){
  if (obj && obj.next){
    const nextAt      = new Date(obj.next);
    const boundary    = toLocal5AM(nextAt);     // 到期日 05:00
    const earlyBound  = addDays(boundary, -1);  // 提前一天 05:00
    const today5      = toLocal5AM(new Date());
    if (today5 >= earlyBound){
      const future = advanceByDaysUntilFuture(nextAt, 42);
      if (+future !== +nextAt){ if ('done' in obj) obj.done = false; obj.next = +future; changed = true; }
    }
  }
}  
  return changed;
}
function refreshAllCycles(STATE){
  let changed = false;
  for (const k of ['gsTw','gsAs']){
    const g = STATE[k]; if(!g) continue;
    if (g.daily) changed = refreshCyclesOnOne(g.daily,'daily') || changed;
    if (g.abyss) changed = refreshCyclesOnOne(g.abyss,'abyss') || changed;
    if (g.poem)  changed = refreshCyclesOnOne(g.poem,'poem')   || changed;
    if (g.ver)   changed = refreshCyclesOnOne(g.ver,'ver')     || changed;
  }
  if (STATE.hsr){
    const h=STATE.hsr;
    if (h.daily) changed = refreshCyclesOnOne(h.daily,'daily') || changed;
    for (const key of ['mem','pure','ape','arbi']){
      if (h[key]) changed = refreshCyclesOnOne(h[key],'hsr42') || changed;
    }
    if (h.ver) changed = refreshCyclesOnOne(h.ver,'ver') || changed;
  }
  if (STATE.hoyo?.daily) changed = refreshCyclesOnOne(STATE.hoyo.daily,'daily') || changed;
  if (STATE.zzz?.daily)  changed = refreshCyclesOnOne(STATE.zzz.daily,'daily')  || changed;
  if (STATE.cats){
    if (STATE.cats.daily)   changed = refreshCyclesOnOne(STATE.cats.daily,'daily')   || changed;
    if (STATE.cats.weekend) changed = refreshCyclesOnOne(STATE.cats.weekend,'weekend') || changed;
  }
  if (STATE.pogo){
    if (STATE.pogo.spin)  changed = refreshCyclesOnOne(STATE.pogo.spin,'spin')  || changed;
    if (STATE.pogo.catch) changed = refreshCyclesOnOne(STATE.pogo.catch,'catch')|| changed;
  }
  if (STATE.noti?.daily) changed = refreshCyclesOnOne(STATE.noti.daily,'daily') || changed;
  if (STATE.nsfw?.daily) changed = refreshCyclesOnOne(STATE.nsfw.daily,'daily') || changed;
  return changed;
}

/* =========================
   Pending：單一定義（UI + Firestore 回報）
   ========================= */
async function renderPending(){
  const arr = [
    STATE.gsTw.daily, STATE.gsAs.daily, STATE.hsr.daily, STATE.hoyo.daily, STATE.zzz.daily,
    STATE.cats.daily, STATE.pogo.spin, STATE.pogo.catch, STATE.noti.daily, STATE.nsfw.daily
  ];
  const cnt = arr.filter(x => !x?.last).length;
  $("#pendingCount").textContent = cnt;

  if (CURRENT_UID){
    try{
      const dayToken = ymd(new Date());
      await userDoc().set({ meta:{ pendingCount:cnt, dayToken } }, { merge:true });
    }catch(e){ console.error('[renderPending] Firestore 寫入失敗：', e); }
  }
}

/* =========================
   UI 綁定（沿用你原本的）
   ========================= */
function setText(id, txt){ const el=$(id.startsWith('#')?id:('#'+id)); if(el) el.textContent=txt; }

async function persist(){
  saveLocal(STATE);
  if (CURRENT_UID){
    try{
      const clean = normalizeForSave(STATE);
      await cloudSave(clean);
    }catch(e){ console.error('persist', e); }
  }
}

function bindDailyCheckbox(idPath, model){
  const el=document.getElementById(idPath); if(!el) return;
  el.checked = !!model.last;
  el.onchange = async ()=>{
    model.last = el.checked ? Date.now() : null;
    await persist();
    renderPending();
  };
}
function bindSpin(id, model){
  const el=document.getElementById(id); if(!el) return;
  el.checked = !!model.last;
  el.onchange = async ()=>{ model.last = el.checked ? Date.now() : null; await persist(); renderPending(); };
}
function bindPoGo(idCatch, idSpin){ bindSpin(idSpin, STATE.pogo.spin); bindSpin(idCatch, STATE.pogo.catch); }

function bindGenshinOne(prefix, node){
  const v = id => document.getElementById(prefix+'_'+id);
  const view=v('resin_view'), eta=v('resin_eta');
  function paintResin(){ view.textContent = node.resin.val; eta.textContent = etaTo200(node.resin); }
  v('resin_minus10').onclick = async ()=>{ node.resin.val=Math.max(0,node.resin.val-10); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_minus1' ).onclick = async ()=>{ node.resin.val=Math.max(0,node.resin.val-1 ); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_plus1'  ).onclick = async ()=>{ node.resin.val=Math.min(200,node.resin.val+1 ); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_plus10' ).onclick = async ()=>{ node.resin.val=Math.min(200,node.resin.val+10); node.resin.last=Date.now(); paintResin(); await persist(); };
  paintResin();

  bindDailyCheckbox(prefix+"_daily", node.daily);

  setText(prefix+"_abyss_next", fmtDate(node.abyss.next));
  const ckA=v('abyss_done'); if(ckA){ ckA.checked=!!node.abyss.done; ckA.onchange=async ()=>{ node.abyss.done=ckA.checked; await persist(); }; }

  setText(prefix+"_poem_next", fmtDate(node.poem.next));
  const ckP=v('poem_done'); if(ckP){ ckP.checked=!!node.poem.done; ckP.onchange=async ()=>{ node.poem.done=ckP.checked; await persist(); }; }

  setText(prefix+"_ver_next", fmtDate(node.ver.next));
}

function bindHSR(){
  bindDailyCheckbox("hsr_daily", STATE.hsr.daily);
  function one(key, labelId, ckId){
    setText(labelId, fmtDate(STATE.hsr[key].next));
    const ck = document.getElementById(ckId);
    if(!ck) return;
    ck.checked = !!STATE.hsr[key].done;
    ck.onchange = async ()=>{ STATE.hsr[key].done = ck.checked; await persist(); };
  }
  one('mem',"hsr_mem_next","hsr_mem_done");
  one('pure',"hsr_pure_next","hsr_pure_done");
  one('ape',"hsr_ape_next","hsr_ape_done");
  one('arbi',"hsr_arbi_next","hsr_arbi_done");
  setText("hsr_ver_next", fmtDate(STATE.hsr.ver.next));
}

function bindHoyo(){ bindDailyCheckbox("hoyo_daily", STATE.hoyo.daily); }
function bindZZZ(){
  bindDailyCheckbox("zzz_daily", STATE.zzz.daily);
  const view=$("#zzz_energy_view");
  function paint(){ view.textContent = STATE.zzz.energy; }
  paint();
  $("#zzz_claim").onclick = async ()=>{ STATE.zzz.energy = Math.min(STATE.zzz.energy+80, 960); if(STATE.zzz.energy>=960) STATE.zzz.energy=240; paint(); await persist(); };
  $("#zzz_reset").onclick = async ()=>{ STATE.zzz.energy = 240; paint(); await persist(); };
}
function toggleWeekendRow(){ const row=$("#cats_weekend_row"); if(row) row.style.display = inWeekend() ? "" : "none"; }
function bindCats(){
  bindDailyCheckbox("cats_daily", STATE.cats.daily);
  toggleWeekendRow();
  const ck=$("#cats_weekend");
  if(ck){ ck.checked=!!STATE.cats.weekend.last; ck.onchange=async ()=>{ STATE.cats.weekend.last=ck.checked?Date.now():null; await persist(); }; }
}
function bindPoGoAll(){ bindPoGo("pogo_catch","pogo_spin"); }
function bindNoti(){ bindDailyCheckbox("noti_daily", STATE.noti.daily); }
function bindNSFW(){
  bindDailyCheckbox("nsfw_daily", STATE.nsfw.daily);
  const ctr=$("#nsfw_ticket_ctr"), inc=$("#nsfw_ticket_inc");
  const paint=()=>{ ctr.textContent = `${STATE.nsfw.ticket} / 3`; };
  paint();
  inc.onclick = async ()=>{ STATE.nsfw.ticket=(STATE.nsfw.ticket+1)%3; paint(); await persist(); };
}

/* =========================
   渲染 / 刷新
   ========================= */
function colorizePlusMinus(){
  document.querySelectorAll('button').forEach(b=>{
    const t=(b.textContent||'').trim();
    b.classList.remove('btn-plus','btn-minus');
    if (t.startsWith('+')) b.classList.add('btn-plus');
    if (t.startsWith('-')) b.classList.add('btn-minus');
  });
}

function render(){
  const now = new Date();
  $("#todayStr").textContent = ymd(now);
  tickResinAuto();
  bindGenshinOne("gsTw", STATE.gsTw);
  bindGenshinOne("gsAs", STATE.gsAs);
  bindHSR(); bindHoyo(); bindZZZ(); bindCats(); bindPoGoAll(); bindNoti(); bindNSFW();
  renderPending();
  colorizePlusMinus();
  setInterval(tickResinAuto, 60*1000);
}

async function refreshAndRenderOnce(){
  const changed = refreshAllCycles(STATE);
  if (changed){ try{ await persist(); }catch(e){ console.warn('persist after refresh failed', e); } }
  render();
}

/* =========================
   啟動
   ========================= */
let STATE = null;

(async function bootstrap(){
  // PWA 快取 SW（另行共存）
  if ('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }

  // 載入狀態 → 合併預設 → 刷新 → 存 → 渲染
  const local = loadLocal();
  STATE = deepMergeDefaults(defaultState(), local||{});
  await refreshAndRenderOnce();

  // Auth 後再試取雲端
  firebase.auth().onAuthStateChanged(async (user)=>{
    CURRENT_UID = user ? user.uid : null;
    updateLoginUI(user);
    try{
      if (user){
        const cloud = await cloudLoad();
        const merged = deepMergeDefaults(defaultState(), cloud || STATE || {});
        STATE = merged;
      }else{
        STATE = deepMergeDefaults(defaultState(), loadLocal() || {});
      }
      await refreshAndRenderOnce();
    }catch(e){ console.error(e); }
  });

  // 回到前景與每小時巡檢
  document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible') refreshAndRenderOnce(); });
  setInterval(refreshAndRenderOnce, 60*60*1000);
})();

/* =========================
   登入 UI
   ========================= */
function updateLoginUI(user){
  if(user){
    $("#who").textContent = `已登入：${user.email||'Google'}`;
    $("#btnLogin").style.display="none";
    $("#btnLogout").style.display="";
  }else{
    $("#who").textContent = "(未登入：僅本機)";
    $("#btnLogin").style.display="";
    $("#btnLogout").style.display="none";
  }
}
$("#btnLogin")?.addEventListener('click', async ()=>{
  try{ await firebase.auth().signInWithPopup(googleProvider); }
  catch(e){
    const fb = ["auth/operation-not-supported-in-this-environment","auth/popup-blocked","auth/popup-closed-by-user"];
    if (fb.includes(e.code||"")) await firebase.auth().signInWithRedirect(googleProvider);
    else alert("登入失敗：" + e.message);
  }
});
$("#btnLogout")?.addEventListener('click', async ()=>{ await firebase.auth().signOut(); });
</script>
</body>
</html>












