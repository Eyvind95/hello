<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>çš®å¡æ¯æ—¥ä»»å‹™</title>

<!-- PWA / Icons -->
<link rel="manifest" href="daily.webmanifest">
<link rel="icon" href="6.png">
<meta name="theme-color" content="#0b0b0b" />
  
<!-- Firebase v8 compatï¼ˆä¸è¼‰å…¥ messagingï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
<style>
:root{
  --bg:#0b0b0b;
  --panel:#151515cc;
  --tile:#101010cc;
  --muted:#bbbbbb;
  --accent:#6ee7ff;
  --ok:#8cff9c;
  --danger:#ff7b7b;
  --border:#2a2a2a;
}
*{box-sizing:border-box}
html,body{height:100%;}
body{
  margin:0; color:#fff;
  background:
    linear-gradient(rgba(0,0,0,0.25), rgba(0,0,0,0.25)),
    url("7.jpg") center/cover no-repeat fixed,
    var(--bg);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", "Helvetica Neue", Arial, sans-serif;
}
@media (max-width:768px){ body{ background-attachment:scroll; } }

.container{max-width:1080px; margin:20px auto; padding:0 12px;}
.header{
  display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
  background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:10px 12px; margin-bottom:12px;
}
h1{font-size:22px; margin:0;}
.header .right{display:flex; gap:8px; align-items:center;}
.btn{
  background:#202020; color:#fff; border:1px solid var(--border); border-radius:10px;
  padding:8px 10px; cursor:pointer;
}
.btn:hover{filter:brightness(1.08)}
.muted{color:var(--muted)}

.grid{
  display:grid; gap:12px;
  grid-template-columns: repeat(2, 1fr);
}
@media (max-width:900px){ .grid{grid-template-columns:1fr} }

.card{
  background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:12px;
}
.card h2{margin:0 0 8px 0; font-size:18px}
.card .sub{font-size:12px; color:var(--muted); margin-top:-4px; margin-bottom:8px}

.game{
  background:var(--tile); border:1px solid var(--border); border-radius:14px; padding:10px; margin-top:10px;
}
.game .top{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
.game .title{display:flex; align-items:center; gap:8px}
.game img.icon{width:28px; height:28px; border-radius:6px; object-fit:cover; background:#333}
.badge{font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); color:#ddd}

.g-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:7px 8px; border-top:1px dashed #2a2a2a; }
.g-left{ color:#ddd; }
.g-right{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.ck{ display:inline-flex; align-items:center; gap:6px; }
.ck input{ width:18px; height:18px; }
.pill{ background:#202020; border:1px solid var(--border); border-radius:999px; padding:4px 8px; font-size:12px; }
.pill.ok{ color:var(--ok) }
.pill.bad{ color:var(--danger) }
.small{ font-size:12px; color:#aaa; }
.val{ font-variant-numeric:tabular-nums; }

.sep{ height:8px }

.footer-note{ color:#aaa; font-size:12px; margin-top:12px; text-align:center; }

/* æ•¸å€¼è† å›Š */
.counter .val,
.pill-val,
.resin .val,
.stamina .val,
.gs-resin-val {
  background:#0d0d0d !important;
  color:#fff !important;
  border:1px solid var(--border, #2a2a2a);
  border-radius:999px;
  padding:6px 12px;
  font-weight:700;
  min-width:64px; text-align:center;
}

/* + / - æŒ‰éˆ•åŸºç¤æ¨£å¼ */
.counter .btn,
.btn-inc, .btn-dec {
  background:#1b1b1b;
  border:1px solid var(--border, #2a2a2a);
  color:#fff;
  width:28px; height:28px;
  border-radius:999px;
  display:grid; place-items:center;
  cursor:pointer; user-select:none;
}
/* åŠ è™Ÿï¼ˆç¶ ï¼‰ */
.btn-plus, .btn-inc { background:rgba(34,197,94,.14); border-color:#22c55e; color:#86efac; }
/* æ¸›è™Ÿï¼ˆç´…ï¼‰ */
.btn-minus, .btn-dec { background:rgba(239,68,68,.14); border-color:#ef4444; color:#fda4af; }

/* çµ•å€é›¶é«”åŠ›æŒ‰éˆ•è‰² */
#zzz_claim { background: rgba(34,197,94,.15); border: 1px solid #22c55e; color: #86efac; }
#zzz_reset { background: rgba(239,68,68,.15); border: 1px solid #ef4444; color: #fda4af; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1>çš®å¡æ¯æ—¥ä»»å‹™</h1>
      <div class="muted small">ä»Šå¤©ï¼ˆ<span id="todayStr"></span>ï¼‰05:00 ä½œç‚ºæ›æ—¥é»ï½œæœªå®Œæˆæ¯æ—¥ï¼š<span id="pendingCount" class="val">0</span> å€‹</div>
    </div>
    <div class="right">
      <span id="who" class="muted">(æœªç™»å…¥ï¼šåƒ…æœ¬æ©Ÿ)</span>
      <button class="btn" id="btnLogin">Google ç™»å…¥</button>
      <button class="btn" id="btnLogout" style="display:none">ç™»å‡º</button>
    </div>
  </div>

  <div class="grid">
    <!-- å·¦æ¬„ -->
    <section class="card">
      <h2>ç±³å®¶ä¸‰å…„å¼Ÿ</h2><div class="sub">åŸç¥ï¼ˆå°/äºï¼‰ã€å´©å£ï¼šæ˜Ÿç©¹éµé“ã€HoyoLAB</div>

      <!-- åŸç¥ï¼ˆå°æœï¼‰ -->
      <div class="game" id="gs-tw">
        <div class="top">
          <div class="title">
            <img class="icon" src="a.jpg" onerror="this.src='6.png'">
            <strong>åŸç¥ãƒ»å°æœ</strong>
          </div>
          <span class="badge">æ¯æ—¥ï¼‹æœˆæ›´</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¨¹è„‚ï¼ˆ8 åˆ†é˜ +1 ï¼ Max 200ï¼‰</div>
          <div class="g-right">
            <button class="pill" id="gsTw_resin_minus10">-10</button>
            <button class="pill" id="gsTw_resin_minus1">-1</button>
            <span class="pill val" id="gsTw_resin_view">160</span>
            <button class="pill" id="gsTw_resin_plus1">+1</button>
            <button class="pill" id="gsTw_resin_plus10">+10</button>
            <span class="small">ï¼ˆè·é›¢æ»¿ï¼š<span id="gsTw_resin_eta" class="val">--</span>ï¼‰</span>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥å§”è¨—</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="gsTw_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">æ·µæœˆèºæ—‹ï¼ˆæ¯æœˆ 1 ï¼† 16ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="gsTw_abyss_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsTw_abyss_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">åŠ‡è©©ï¼ˆæ¯æœˆ 1ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="gsTw_poem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsTw_poem_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">ç‰ˆæœ¬æ›´æ–°ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="gsTw_ver_next" class="val">--</span></span>
          </div>
        </div>
      </div>

      <!-- åŸç¥ï¼ˆäºæœï¼‰ -->
      <div class="game" id="gs-as">
        <div class="top">
          <div class="title">
            <img class="icon" src="a.jpg" onerror="this.src='6.png'">
            <strong>åŸç¥ãƒ»äºæœ</strong>
          </div>
          <span class="badge">æ¯æ—¥ï¼‹æœˆæ›´</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¨¹è„‚ï¼ˆ8 åˆ†é˜ +1 ï¼ Max 200ï¼‰</div>
          <div class="g-right">
            <button class="pill" id="gsAs_resin_minus10">-10</button>
            <button class="pill" id="gsAs_resin_minus1">-1</button>
            <span class="pill val" id="gsAs_resin_view">160</span>
            <button class="pill" id="gsAs_resin_plus1">+1</button>
            <button class="pill" id="gsAs_resin_plus10">+10</button>
            <span class="small">ï¼ˆè·é›¢æ»¿ï¼š<span id="gsAs_resin_eta" class="val">--</span>ï¼‰</span>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥å§”è¨—</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="gsAs_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">æ·µæœˆèºæ—‹ï¼ˆæ¯æœˆ 1 ï¼† 16ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="gsAs_abyss_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsAs_abyss_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">åŠ‡è©©ï¼ˆæ¯æœˆ 1ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="gsAs_poem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="gsAs_poem_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">ç‰ˆæœ¬æ›´æ–°ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right"><span class="small">ä¸‹æ¬¡ï¼š<span id="gsAs_ver_next" class="val">--</span></span></div>
        </div>
      </div>

      <!-- å´©å£ï¼šæ˜Ÿç©¹éµé“ -->
      <div class="game" id="hsr">
        <div class="top">
          <div class="title">
            <img class="icon" src="b.jpg" onerror="this.src='6.png'">
            <strong>å´©å£ï¼šæ˜Ÿç©¹éµé“</strong>
          </div>
          <span class="badge">æ¯æ—¥ï¼‹å¤šå€‹ 42 å¤©æª”æœŸ</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="hsr_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">æ··æ²Œå›æ†¶ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="hsr_mem_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_mem_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">è™›æ§‹æ•˜äº‹ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="hsr_pure_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_pure_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">æœ«æ—¥å¹»å½±ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="hsr_ape_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_ape_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">ç•°ç›¸ä»²è£ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right">
            <span class="small">ä¸‹æ¬¡ï¼š<span id="hsr_arbi_next" class="val">--</span></span>
            <label class="ck"><input type="checkbox" id="hsr_arbi_done"> æœ¬è¼ªç‹€æ…‹</label>
          </div>
        </div>

        <div class="g-row">
          <div class="g-left">ç‰ˆæœ¬æ›´æ–°ï¼ˆ42 å¤©ï¼‰</div>
          <div class="g-right"><span class="small">ä¸‹æ¬¡ï¼š<span id="hsr_ver_next" class="val">--</span></span></div>
        </div>
      </div>

      <!-- HoyoLAB -->
      <div class="game" id="hoyo">
        <div class="top">
          <div class="title">
            <img class="icon" src="d.png" onerror="this.src='6.png'">
            <strong>HoyoLAB</strong>
          </div>
          <span class="badge">æ¯æ—¥</span>
        </div>
        <div class="g-row">
          <div class="g-left">æ¯æ—¥ç°½åˆ°</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="hoyo_daily"></label></div>
        </div>
      </div>
    </section>

    <!-- å³æ¬„ -->
    <section class="card">
      <h2>å…¶ä»–</h2><div class="sub">çµ•å€é›¶ã€è²“å’ªå¤§æˆ°çˆ­ã€PokÃ©mon GOã€è«¾æé‡Œæ£®ã€æ–°ä¸–ç•Œç‹‚æ­¡</div>

      <!-- çµ•å€é›¶ -->
      <div class="game" id="zzz">
        <div class="top">
          <div class="title">
            <img class="icon" src="c.png" onerror="this.src='6.png'">
            <strong>çµ•å€é›¶</strong>
          </div>
          <span class="badge">æ¯æ—¥ï¼‹èƒ½é‡</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="zzz_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">é«”åŠ›ï¼ˆæ‡¶äººç‰ˆï¼‰</div>
          <div class="g-right">
            <span class="pill val" id="zzz_energy_view">240</span>
            <button class="pill" id="zzz_claim">æ”¶å– +80</button>
            <button class="pill" id="zzz_reset">æ»¿äº†é‡ç½®åˆ° 240</button>
            <span class="small">å€é–“ 240~960ï¼Œæ»¿å¾Œè‡ªå‹•å› 240</span>
          </div>
        </div>
      </div>

      <!-- è²“å’ªå¤§æˆ°çˆ­ -->
      <div class="game" id="cats">
        <div class="top">
          <div class="title">
            <img class="icon" src="e.jpg" onerror="this.src='6.png'">
            <strong>è²“å’ªå¤§æˆ°çˆ­</strong>
          </div>
          <span class="badge">é€±æœ«é™å®š</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="cats_daily"></label></div>
        </div>

        <div class="g-row" id="cats_weekend_row">
          <div class="g-left">é€±æœ«é—œå¡ï¼ˆå…­ã€æ—¥ï¼‰</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="cats_weekend"></label><span class="small">é€±æœ« 05:00 é‡ç½®</span></div>
        </div>
      </div>

      <!-- PokÃ©mon GO -->
      <div class="game" id="pogo">
        <div class="top">
          <div class="title">
            <img class="icon" src="f.jpg" onerror="this.src='6.png'">
            <strong>PokÃ©mon GO</strong>
          </div>
          <span class="badge">æ¯æ—¥</span>
        </div>
        <div class="g-row">
          <div class="g-left">è½‰ä¸€å€‹è£œçµ¦ç«™</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="pogo_spin"></label></div>
        </div>
        <div class="g-row">
          <div class="g-left">æ‰ä¸€éš»å¯¶å¯å¤¢</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="pogo_catch"></label></div>
        </div>
      </div>

      <!-- è«¾æé‡Œæ£® -->
      <div class="game" id="noti">
        <div class="top">
          <div class="title">
            <img class="icon" src="g.jpg" onerror="this.src='6.png'">
            <strong>è«¾æé‡Œæ£®</strong>
          </div>
          <span class="badge">æ¯æ—¥</span>
        </div>
        <div class="g-row">
          <div class="g-left">æ¯æ—¥</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="noti_daily"></label></div>
        </div>
      </div>

      <!-- æ–°ä¸–ç•Œç‹‚æ­¡ -->
      <div class="game" id="nsfw">
        <div class="top">
          <div class="title">
            <img class="icon" src="h.jpg" onerror="this.src='6.png'">
            <strong>æ–°ä¸–ç•Œç‹‚æ­¡</strong>
          </div>
          <span class="badge">æ¯æ—¥ï¼‹é‡‘å¹£å·</span>
        </div>

        <div class="g-row">
          <div class="g-left">æ¯æ—¥</div>
          <div class="g-right"><label class="ck"><input type="checkbox" id="nsfw_daily"></label></div>
        </div>

        <div class="g-row">
          <div class="g-left">é‡‘å¹£å·ï¼ˆ3 å¤©ä¸€æ¬¡ï¼Œå¾ªç’° 0â†’1â†’2â†’0ï¼‰</div>
          <div class="g-right">
            <span class="pill val" id="nsfw_ticket_ctr">0 / 3</span>
            <button class="pill btn-inc" id="nsfw_ticket_inc">+1</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer-note">â€» æ™šä¸Š 20:00 èˆ‡ 22:00 è‹¥å°šæœ‰ã€Œæ¯æ—¥ã€æœªæ‰“å‹¾ï¼Œæœƒåœ¨å‰ç«¯æé†’ï¼ˆéœ€åœ¨ç¶²é å‰æ™¯é–‹è‘—ï¼‰ã€‚</div>
</div>

<!-- ä¸‹é¢æ¥ Scriptï¼ˆè¦‹ç¬¬ 2 æ®µï¼‰ -->
<script>
/* ------------ å°å·¥å…· ------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const toLocal5AM = (d=new Date()) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 5, 0, 0, 0);
function isTodayAfter5(now=new Date()){ return now >= toLocal5AM(now); }
function inWeekend(d=new Date()){ const w = d.getDay(); return (w === 0 || w === 6); }
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function fmtDate(d){
  if(d==null) return '--';
  const x = (d instanceof Date) ? d : new Date(d);
  return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`;
}
function nextAbyssBase(from){ // æ¯æœˆ 1 & 16
  const d = new Date(from), day = d.getDate(), m = d.getMonth(), y = d.getFullYear();
  if(day < 1)  return new Date(y, m, 1);
  if(day < 16) return new Date(y, m, 16);
  return new Date(y, m+1, 1);
}
function nextMonth1(from){ const d = new Date(from); return new Date(d.getFullYear(), d.getMonth()+1, 1); }
function next42(from){ const d = new Date(from); d.setDate(d.getDate()+42); return d; }

/* ------------ é è¨­ç‹€æ…‹ ------------- */
function defaultState(){
  const today = new Date();
  const baseAbyss = nextAbyssBase(today);
  const basePoem  = nextMonth1(today);
  return {
    gsTw:{ resin:{ val:160, last: Date.now() }, daily:{ last:null }, abyss:{ next: +baseAbyss, done:false }, poem:{ next:+basePoem, done:false }, ver:{ next:+next42(today) } },
    gsAs:{ resin:{ val:160, last: Date.now() }, daily:{ last:null }, abyss:{ next: +baseAbyss, done:false }, poem:{ next:+basePoem, done:false }, ver:{ next:+next42(today) } },
    hsr: { daily:{ last:null },
           mem:{ next:+new Date('2025-10-27'), done:false },
           pure:{ next:+new Date('2025-11-24'), done:false },
           ape:{ next:+new Date('2025-11-10'), done:false },
           arbi:{ next:+new Date('2025-11-05'), done:false },
           ver:{ next:+new Date('2025-11-05') } },
    hoyo:{ daily:{ last:null } },
    zzz: { daily:{ last:null }, energy:240 },
    cats:{ daily:{ last:null }, weekend:{ last:null } },
    pogo:{ spin:{ last:null }, catch:{ last:null } },
    noti:{ daily:{ last:null } },
    nsfw:{ daily:{ last:null }, ticket:0 },
    meta:{ lastReset: null }
  };
}

/* æ·±åº¦åˆä½µï¼ˆç”¨ default è£œç¼ºï¼Œä¸è¦†è“‹ç¾æœ‰å€¼ï¼‰ */
function deepMergeDefaults(def, cur){
  if (cur === undefined || cur === null) return def;
  if (Array.isArray(def) || Array.isArray(cur)) return cur ?? def;
  if (typeof def !== 'object' || typeof cur !== 'object') return (cur === undefined || cur === null) ? def : cur;
  const out = {...cur};
  for (const k of Object.keys(def)){ out[k] = deepMergeDefaults(def[k], cur[k]); }
  return out;
}

/* å°‡ç‹€æ…‹ä¸­çš„ Date è½‰ç‚º numberï¼ˆmsï¼‰ */
function normalizeForSave(s){
  const j = JSON.parse(JSON.stringify(s)); // æ·±æ‹·è²
  // ä¿è­‰æ‰€æœ‰æ—¥æœŸæ¬„ä½æ˜¯ number
  const fix = (node)=>{
    if(!node || typeof node!=='object') return;
    for(const k in node){
      const v = node[k];
      if(v instanceof Date){ node[k] = +v; }
      else if(v && typeof v==='object'){ fix(v); }
    }
  };
  fix(j);
  return j;
}
/* å°‡é›²ç«¯è®€å›çš„ number é‚„åŸç‚º numberï¼ˆæœ¬é çš†ç”¨ number å­˜ epochï¼ŒfmtDate æ™‚å† new Dateï¼‰*/
function reviveFromCloud(s){ return s || null; }

/* ------------ æœ¬æ©Ÿå„²å­˜ ------------- */
const LS_KEY = "daily_state_v1";
function loadLocal(){ try{ const raw=localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; } }
function saveLocal(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

/* ------------ Firebaseï¼ˆAuth + Firestoreï¼‰ ------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
  authDomain: "eyvind95-182f0.firebaseapp.com",
  projectId: "eyvind95-182f0",
  storageBucket: "eyvind95-182f0.firebasestorage.app",
  messagingSenderId: "105770576221",
  appId: "1:105770576221:web:dd3a57ce4e051bda91a0b4"
};
(async () => {
  // å…ˆè¨»å†Š SWï¼ˆç”¨çµ•å°è·¯å¾‘ + æ­£ç¢º scopeï¼‰
  const reg = await navigator.serviceWorker.register(
    '/hello/apps/ledger/firebase-messaging-sw.js',
    { scope: '/hello/apps/ledger/' }
  );
  await navigator.serviceWorker.ready;

  // å•Ÿç”¨é€šçŸ¥æ¬Šé™
  const perm = await Notification.requestPermission();
  if (perm !== 'granted') { console.warn('user denied notification'); return; }

  // å– tokenï¼ˆé€™è£¡æ”¾ Cloud Messaging é é¢çš„ã€Œç¶²é æ¨æ’­æ†‘è­‰ã€Public keyï¼ŒB é–‹é ­é‚£ä¸²ï¼‰
  const VAPID = 'BHwAITz4c7tcvzHApW6ZzMU9DOIZ0ZpiKbufVx1Uq46io--d2mvbcVmve9_wsxFzaQrOapYpMOi0oNRsxmbgVPY';
  const messaging = firebase.messaging();
  const token = await messaging.getToken({ vapidKey: VAPID, serviceWorkerRegistration: reg });
  console.log('NEW TOKEN =>', token);
})();
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let CURRENT_UID = null;
const googleProvider = new firebase.auth.GoogleAuthProvider();
googleProvider.setCustomParameters({ prompt: 'select_account' });

function userDoc() {
  return db.collection('daily').doc(CURRENT_UID);
}

// === é›²ç«¯è®€å– ===
async function cloudLoad() {
  if (!CURRENT_UID) return null;
  const snap = await userDoc().get();
  return snap.exists ? snap.data() : null;
}

// === é›²ç«¯å„²å­˜ï¼ˆä¿ç•™å…¶ä»–æ¬„ä½ï¼Œä¾‹å¦‚ meta.tokensï¼‰===
async function cloudSave(state) {
  if (!CURRENT_UID) return;
  await userDoc().set(state, { merge: true });
}

// === å°ˆé–€çµ¦ GitHub Actions åˆ¤æ–·ç”¨ ===
async function savePendingCountToCloud(pending) {
  if (!CURRENT_UID) {
    console.warn("å°šæœªç™»å…¥ï¼Œç„¡æ³•å¯«å…¥ pendingCount");
    return;
  }

  const dayToken = new Date().toISOString().slice(0, 10);

  try {
    await userDoc().update({
      'meta.pendingCount': pending,
      'meta.dayToken': dayToken,
      'meta.pendingUpdatedAt': firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch (e) {
    if (e.code === 'not-found') {
      await userDoc().set({
        meta: {
          pendingCount: pending,
          dayToken,
          pendingUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }
      }, { merge: true });
    } else {
      console.error('savePendingCountToCloud failed:', e);
    }
  }
}

/* ------------ å…¨åŸŸç‹€æ…‹ ------------- */
let STATE = null;

/* ------------ æ›æ—¥é‚è¼¯ï¼ˆ05:00ï¼‰ ------------- */
function ensureDailyReset(){
  const now = new Date();
  const dayToken = ymd(isTodayAfter5(now) ? now : addDays(now,-1));
  if(STATE.meta.lastReset === dayToken) return;

  const resetDaily = (obj)=>{
    if(!obj) return;
    Object.keys(obj).forEach(k=>{
      const v = obj[k];
      if(v && typeof v === 'object' && Object.prototype.hasOwnProperty.call(v,'last')){
        v.last = null;
      }
    });
  };

  resetDaily(STATE.gsTw);
  resetDaily(STATE.gsAs);
  resetDaily(STATE.hsr);
  resetDaily(STATE.hoyo);
  resetDaily(STATE.zzz);
  resetDaily(STATE.cats);
  resetDaily(STATE.pogo);
  resetDaily(STATE.noti);
  resetDaily(STATE.nsfw);

  if(inWeekend(now)){ STATE.cats.weekend.last = null; }
  STATE.meta.lastReset = dayToken;
}

/* -------------- åŸç¥æ¨¹è„‚è‡ªå‹•å›å¾©ï¼ˆä¿®æ­£ç‰ˆï¼‰ -------------- */
function tickResinAutoOne(node) {
  const now = Date.now();

  // ğŸ©µ åˆå§‹åŒ–é˜²å‘†ï¼šç¬¬ä¸€æ¬¡æ²’æœ‰ val æˆ– last
  if (!Number.isFinite(node.val)) node.val = 0;
  if (!node.last) {
    node.last = now;
    return;
  }

  // â± è¨ˆç®—ç¶“éçš„åˆ†é˜æ•¸
  const mins = Math.floor((now - node.last) / 60000);
  if (mins <= 0) return;

  // æ¯ 8 åˆ†é˜æ¢å¾© 1 é»æ¨¹è„‚
  const add = Math.floor(mins / 8);
  if (add <= 0) return;

  // ğŸ’§ åŠ å€¼å¾Œå†åšä¸Šé™é™åˆ¶ï¼ˆä¸å†ä¸€é–‹å§‹å¼·åˆ¶ 200ï¼‰
  node.val = Math.min(200, node.val + add);

  // â° èª¿æ•´ lastï¼Œè®“å®ƒæº–ç¢ºåœåœ¨åŠ å€¼å¾Œçš„æ™‚é–“é»
  node.last = node.last + add * 8 * 60000;
}

function tickResinAuto() {
  // ğŸ” ä¸€æ¬¡æ›´æ–°æ‰€æœ‰å€æœ
  tickResinAutoOne(STATE.gsTw.resin);
  tickResinAutoOne(STATE.gsAs.resin);
  tickResinAutoOne(STATE.hsr.resin);
  tickResinAutoOne(STATE.hoyo.resin);
  tickResinAutoOne(STATE.zzz.resin);
}

function etaTo200(resin) {
  // ğŸ“… è¨ˆç®—è·é›¢æ»¿æ¨¹è„‚å‰©é¤˜æ™‚é–“
  if (resin.val >= 200) return 'æ»¿';
  const remain = 200 - resin.val;
  const mins = remain * 8;
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `${h}å°æ™‚${m}åˆ†`;
}
// â€”â€” æŠŠæœªå®Œæˆæ•¸é‡å­˜åˆ°é›²ç«¯ /daily/<UID> çš„ meta.pendingCount â€”â€” 
async function savePendingCountToCloud(pending){
  // åªæœ‰ç™»å…¥ï¼ˆæœ‰ UIDï¼‰æ‰å›å ±ï¼›æœªç™»å…¥æ™‚ä¿æŒã€Œæœ¬æ©Ÿæ¨¡å¼ã€ä¸å¯«é›²
  if (!CURRENT_UID) return;
    const dateStr = new Date().toLocaleDateString('zh-TW',{ timeZone:'Asia/Taipei', year:'numeric', month:'2-digit', day:'2-digit' })
                    .replace(/\//g,'-'); // 2025-10-21
  await userDoc().set({ meta: { pendingCount: pending, dayToken: dateStr } }, { merge: true });
  try{
    await userDoc().set({
      meta: {
        pendingCount: pending,
        pendingUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }
    }, { merge:true });
  }catch(e){
    console.error('savePendingCountToCloud failed:', e);
  }
}
  /* ------------ Pending çµ±è¨ˆ & å‰ç«¯æé†’ï¼ˆ20:00 / 22:00ï¼‰ ------------- */
function renderPending(){
  const arr = [
    STATE.gsTw.daily, STATE.gsAs.daily, STATE.hsr.daily, STATE.hoyo.daily, STATE.zzz.daily,
    STATE.cats.daily, STATE.pogo.spin, STATE.pogo.catch, STATE.noti.daily, STATE.nsfw.daily
  ];
  const cnt = arr.filter(x => !x.last).length;
  $("#pendingCount").textContent = cnt;
  savePendingCountToCloud(cnt); // â† å¿…ç•™ï¼Œé›²ç«¯è¦è®€é€™å€‹æ•¸
}
/* ------------ UI ç¶å®š ------------- */
function setText(id, txt){ const el=$(id.startsWith('#')?id:('#'+id)); if(el) el.textContent=txt; }

function bindDailyCheckbox(idPath, model){
  const el = document.getElementById(idPath);
  if(!el) return;
  el.checked = !!model.last;
  el.onchange = async ()=>{
    model.last = el.checked ? Date.now() : null;
    await persist(); 
    renderPending();
    updatePendingDisplay();
  };
}
function bindSpin(id, model){ const el = document.getElementById(id); if(!el) return;
  el.checked = !!model.last;
  el.onchange = async ()=>{ model.last = el.checked ? Date.now() : null; await persist(); renderPending(); };
}
function bindPoGo(idCatch, idSpin){ bindSpin(idSpin, STATE.pogo.spin); bindSpin(idCatch, STATE.pogo.catch); }

/* åŸç¥ï¼ˆå–®ä¸€å¸³ï¼‰ */
function bindGenshinOne(prefix, node){
  const v = id => document.getElementById(prefix + '_' + id);

  // æ¨¹è„‚
  const view = v('resin_view'), eta = v('resin_eta');
  function paintResin(){ view.textContent = node.resin.val; eta.textContent = etaTo200(node.resin); }

  v('resin_minus10').onclick = async ()=>{ node.resin.val = Math.max(0, node.resin.val-10); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_minus1').onclick  = async ()=>{ node.resin.val = Math.max(0, node.resin.val-1 ); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_plus1').onclick   = async ()=>{ node.resin.val = Math.min(200, node.resin.val+1 ); node.resin.last=Date.now(); paintResin(); await persist(); };
  v('resin_plus10').onclick  = async ()=>{ node.resin.val = Math.min(200, node.resin.val+10); node.resin.last=Date.now(); paintResin(); await persist(); };
  paintResin();

  // æ¯æ—¥
  bindDailyCheckbox(prefix+"_daily", node.daily);

  // èºæ—‹
  setText(prefix+"_abyss_next", fmtDate(node.abyss.next));
  const ckA = v('abyss_done'); if(ckA){ ckA.checked = !!node.abyss.done; ckA.onchange = async ()=>{ node.abyss.done = ckA.checked; await persist(); }; }

  // åŠ‡è©©
  setText(prefix+"_poem_next", fmtDate(node.poem.next));
  const ckP = v('poem_done'); if(ckP){ ckP.checked = !!node.poem.done; ckP.onchange = async ()=>{ node.poem.done = ckP.checked; await persist(); }; }

  // ç‰ˆæœ¬
  setText(prefix+"_ver_next", fmtDate(node.ver.next));
}

/* æ˜Ÿç©¹éµé“ */
function bindHSR(){
  bindDailyCheckbox("hsr_daily", STATE.hsr.daily);
  function one(key, labelId, ckId){
    setText(labelId, fmtDate(STATE.hsr[key].next));
    const ck = document.getElementById(ckId);
    if(!ck) return;
    ck.checked = !!STATE.hsr[key].done;
    ck.onchange = async ()=>{ STATE.hsr[key].done = ck.checked; await persist(); };
  }
  one('mem',"hsr_mem_next","hsr_mem_done");
  one('pure',"hsr_pure_next","hsr_pure_done");
  one('ape',"hsr_ape_next","hsr_ape_done");
  one('arbi',"hsr_arbi_next","hsr_arbi_done");
  setText("hsr_ver_next", fmtDate(STATE.hsr.ver.next));
}

/* HoyoLAB */
function bindHoyo(){ bindDailyCheckbox("hoyo_daily", STATE.hoyo.daily); }

/* ZZZï¼ˆæ‡¶äººç‰ˆï¼‰ */
function bindZZZ(){
  bindDailyCheckbox("zzz_daily", STATE.zzz.daily);
  const view = $("#zzz_energy_view");
  function paint(){ view.textContent = STATE.zzz.energy; }
  paint();
  $("#zzz_claim").onclick = async ()=>{ STATE.zzz.energy = Math.min(STATE.zzz.energy + 80, 960); if(STATE.zzz.energy>=960) STATE.zzz.energy = 240; paint(); await persist(); };
  $("#zzz_reset").onclick = async ()=>{ STATE.zzz.energy = 240; paint(); await persist(); };
}

/* è²“å’ªé€±æœ«è¡Œé¡¯ç¤º */
function toggleWeekendRow(){ const row = $("#cats_weekend_row"); if(row) row.style.display = inWeekend() ? "" : "none"; }
function bindCats(){
  bindDailyCheckbox("cats_daily", STATE.cats.daily);
  toggleWeekendRow();
  const ck = $("#cats_weekend");
  if(ck){ ck.checked = !!STATE.cats.weekend.last; ck.onchange = async ()=>{ STATE.cats.weekend.last = ck.checked ? Date.now() : null; await persist(); }; }
}

/* PokÃ©mon GO */
function bindPoGoAll(){ bindPoGo("pogo_catch","pogo_spin"); }

/* è«¾æé‡Œæ£® */
function bindNoti(){ bindDailyCheckbox("noti_daily", STATE.noti.daily); }

/* æ–°ä¸–ç•Œç‹‚æ­¡ï¼ˆç¥¨ 0â†’1â†’2â†’0ï¼‰ */
function bindNSFW(){
  bindDailyCheckbox("nsfw_daily", STATE.nsfw.daily);
  const ctr=$("#nsfw_ticket_ctr"), inc=$("#nsfw_ticket_inc");
  function paint(){ ctr.textContent = `${STATE.nsfw.ticket} / 3`; }
  paint();
  inc.onclick = async ()=>{ STATE.nsfw.ticket = (STATE.nsfw.ticket + 1) % 3; paint(); await persist(); };
}

/* ------------ Pending çµ±è¨ˆ & å‰ç«¯æé†’ï¼ˆ20:00 / 22:00ï¼‰ ------------- */
async function renderPending() {
  const arr = [
    STATE.gsTw.daily, STATE.gsAs.daily, STATE.hsr.daily, STATE.hoyo.daily, STATE.zzz.daily,
    STATE.cats.daily, STATE.pogo.spin, STATE.pogo.catch, STATE.noti.daily, STATE.nsfw.daily
  ];

  const cnt = arr.filter(x => !x.last).length;
  $("#pendingCount").textContent = cnt;

  // å¯«å› Firestoreï¼Œè®“ GitHub Actions èƒ½è®€åˆ°
  if (CURRENT_UID) {
    try {
      const dayToken = ymd(new Date()); // ä½ çš„æ—¥æ¨™ï¼Œå¯ç…§åŸæ¨£ä¿ç•™
      await userDoc().set({
        meta: {
          pendingCount: cnt,
          dayToken
        }
      }, { merge: true });
    } catch (e) {
      console.error("[renderPending] Firestore å¯«å…¥å¤±æ•—ï¼š", e);
    }
  }
}


  function updatePendingDisplay(){
  const arr = [
    STATE.gsTw.daily, STATE.gsAs.daily, STATE.hsr.daily, STATE.hoyo.daily, STATE.zzz.daily,
    STATE.cats.daily, STATE.pogo.spin, STATE.pogo.catch, STATE.noti.daily, STATE.nsfw.daily
  ];
  const pending = arr.filter(x => !x.last).length;
  $("#pendingCount").textContent = pending;
  savePendingCountToCloud(pending); // â† é€™è¡ŒæœƒåŒæ­¥ Firestore
}
function scheduleLocalReminders(){
  function plan(hour){
    const now = new Date(), t = new Date();
    t.setHours(hour,0,0,0);
    if(t <= now) t.setDate(t.getDate()+1);
    const ms = t - now;
    setTimeout(()=>{
      renderPending();
      const n = parseInt($("#pendingCount").textContent||"0",10);
      if(n>0) alert(`æé†’ï¼šä½ é‚„æœ‰ ${n} å€‹æ¯æ—¥å°šæœªå®Œæˆå–”ï¼`);
      plan(hour);
    }, ms);
  }
  plan(20); plan(22);
}

/* ------------ æ¸²æŸ“ ------------- */
function colorizePlusMinus(){
  document.querySelectorAll('button').forEach(b=>{
    const t = (b.textContent||'').trim();
    b.classList.remove('btn-plus','btn-minus');
    if (t.startsWith('+')) b.classList.add('btn-plus');
    if (t.startsWith('-')) b.classList.add('btn-minus');
  });
}
function render(){
  const now = new Date();
  $("#todayStr").textContent = ymd(now);
  tickResinAuto();
  bindGenshinOne("gsTw", STATE.gsTw);
  bindGenshinOne("gsAs", STATE.gsAs);
  bindHSR(); bindHoyo(); bindZZZ(); bindCats(); bindPoGoAll(); bindNoti(); bindNSFW();
  renderPending();
  updatePendingDisplay();
  colorizePlusMinus();
}

/* ------------ æ°¸ä¹…åŒ–ï¼ˆé›²ç«¯å„ªå…ˆï¼‰ ------------- */
async function persist(){
  // å„ªå…ˆæœ¬æ©Ÿ
  saveLocal(STATE);
  // é›²ç«¯ï¼ˆç™»å…¥æ‰å­˜ï¼‰
  if (CURRENT_UID){
    try{
      const clean = normalizeForSave(STATE);
      await cloudSave(clean);
    }catch(e){ console.error(e); }
  }
}

/* ------------ ç™»å…¥ UI ------------- */
function updateLoginUI(user){
  if(user){
    $("#who").textContent = `å·²ç™»å…¥ï¼š${user.email||'Google'}`;
    $("#btnLogin").style.display="none";
    $("#btnLogout").style.display="";
  }else{
    $("#who").textContent = "(æœªç™»å…¥ï¼šåƒ…æœ¬æ©Ÿ)";
    $("#btnLogin").style.display="";
    $("#btnLogout").style.display="none";
  }
}

/* ------------ å•Ÿå‹• ------------- */
(async function bootstrap(){
  // åƒ…è¨»å†Šå¿«å– SWï¼ˆä¸è¨»å†Š firebase-messaging-sw.jsï¼‰
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }

  // è¼‰å…¥ç‹€æ…‹ â†’ åˆä½µé è¨­ â†’ 05:00 æ›æ—¥ â†’ è‡ªå‹•å›å¾© â†’ å­˜ â†’ æ¸²æŸ“
  let local = loadLocal();
  STATE = deepMergeDefaults(defaultState(), local||{});
  ensureDailyReset(); tickResinAuto(); await persist(); render();

  // Auth ç›£è½
  firebase.auth().onAuthStateChanged(async (user)=>{
    CURRENT_UID = user ? user.uid : null;
    updateLoginUI(user);
    try{
      if(user){
        const cloud = await cloudLoad();
        const revived = cloud ? reviveFromCloud(cloud) : null;
        STATE = deepMergeDefaults(defaultState(), revived || STATE || {});
        render();
    const pending = 0;
    savePendingCountToCloud(pending);
      }else{
        const loc = loadLocal();
        STATE = deepMergeDefaults(defaultState(), loc || {});
      }
      ensureDailyReset(); tickResinAuto(); await persist(); render();
    }catch(e){ console.error(e); }
  });

  // Login/Logout
  $("#btnLogin").onclick = async ()=>{
    try{ await firebase.auth().signInWithPopup(googleProvider); }
    catch(e){
      const fallback = ["auth/operation-not-supported-in-this-environment","auth/popup-blocked","auth/popup-closed-by-user"];
      if(fallback.includes(e.code||"")) await firebase.auth().signInWithRedirect(googleProvider);
      else alert("ç™»å…¥å¤±æ•—ï¼š" + e.message);
    }
  };
  $("#btnLogout").onclick = async ()=>{ await firebase.auth().signOut(); };

  // å‰ç«¯æé†’ï¼ˆéœ€é é¢åœ¨å‰æ™¯æˆ–è‡³å°‘é–‹è‘—ï¼‰
  scheduleLocalReminders();

  // æ¯åˆ†é˜ï¼šæ¨¹è„‚ tickã€é€±æœ«è¡Œé¡¯ç¤ºã€Pending æ›´æ–°
  setInterval(()=>{ tickResinAuto(); toggleWeekendRow(); renderPending(); }, 60000);
})();
</script>
</body>
</html>















