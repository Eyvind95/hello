<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<title>Get FCM Web Token</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

<body style="font-family:system-ui;padding:24px">
  <h1>FCM Web Token 工具</h1>
  <button id="btn">取得 / 更新 Token</button>
  <pre id="out" style="white-space:pre-wrap;margin-top:16px"></pre>

<script>
  // --- Firebase 初始化 ---
  const firebaseConfig = {
    apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
    authDomain: "eyvind95-182f0.firebaseapp.com",
    projectId: "eyvind95-182f0",
    storageBucket: "eyvind95-182f0.firebasestorage.app",
    messagingSenderId: "105770576221",
    appId: "1:105770576221:web:dd3a57ce4e051bda91a0b4"
  };
  const VAPID = "BHwAITz4c7tcvzHApW6ZzMU9DOIZ0ZpiKbufVx1Uq46io--d2mvbcVmve9_wsxFzaQrOapYpM0i0oONRSxmbgVPY";

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const messaging = firebase.messaging();
  const out = document.getElementById('out');

  document.getElementById('btn').onclick = async () => {
    out.textContent = '註冊中...';

    try {
      // ✅ 先註冊 service worker
      const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
      // ✅ 指定給 messaging 使用
      messaging.useServiceWorker(reg);

      // ✅ 請求通知權限
      const perm = await Notification.requestPermission();
      if (perm !== 'granted') throw new Error('使用者未允許通知');

      // ✅ 取得 Token
      const token = await messaging.getToken({
        vapidKey: VAPID,
        serviceWorkerRegistration: reg
      });

      out.textContent = `✅ 取得成功！\n\nFCM_TOKEN:\n${token}\n\n請複製貼到 GitHub Secrets → FCM_TOKEN`;
      console.log('NEW TOKEN =>', token);
    } catch (err) {
      out.textContent = '❌ 發生錯誤：' + err.message;
      console.error(err);
    }
  };
</script>
</body>
</html>
