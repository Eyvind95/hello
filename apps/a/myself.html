<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æˆ‘çš„è¨˜å¸³æœ¬</title>

<!-- å¯æœ‰å¯ç„¡ï¼šfavicon èˆ‡ PWA manifestï¼ˆä½ æœ‰æ”¾æª”å°±æœƒç”Ÿæ•ˆï¼‰ -->
<link rel="icon" href="6.png" />
<link rel="apple-touch-icon" href="6.png" />
<link rel="manifest" href="https://eyvind95.github.io/hello/apps/a/myself.webmanifest" />

<!-- Firebase v8 compatï¼ˆç©©å®šï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
  :root{
    --bg:#0b0b0b;
    --panel:#151515cc;
    --muted:#bbbbbb;
    --accent:#6ee7ff;
    --danger:#ff7b7b;
    --ok:#8cff9c;
    --border:#2a2a2a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;}
  body{
    margin:0; color:#fff;
    background:
      linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)),
      url("https://i.pinimg.com/736x/9e/79/c3/9e79c358e0914cd144e90a39f102e1cc.jpg") center / cover no-repeat fixed,
      var(--bg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", "Helvetica Neue", Arial, sans-serif;
  }
  @media (max-width:768px){ body{ background-attachment:scroll; } }

  .container{ max-width:1100px; margin:32px auto; padding:0 16px; }
  header{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px; }
  h1{font-size:28px; margin:0;}
  .controls{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    background:var(--panel); padding:10px 12px; border:1px solid var(--border); border-radius:14px;
  }
  .controls button, .controls select, .controls input{
    background:#202020; color:#fff; border:1px solid var(--border);
    padding:8px 10px; border-radius:10px; outline:none;
  }
  .controls button:hover{filter:brightness(1.12); cursor:pointer}

  .row{
    display: grid;
    gap: 16px;
    grid-template-columns: 1.11fr 1.35fr; /* å·¦ï¼š1.11 å³ï¼š1.35 */
  }
  .row > *{ min-width: 0; }
  @media (max-width: 900px){ .row{grid-template-columns:1fr;} }

  .card{ background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:16px; min-width:0; }
  .card h2{margin:0 0 10px 0; font-size:20px;}
.week-pies-grid{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.week-card{
  background:#101010;
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
}
.week-title{
  color:var(--muted);
  font-size:14px;
  margin-bottom:8px;
}
.week-legend{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  font-size:13px;
  color:var(--muted);
  margin-top:8px;
}
.week-legend .key{display:inline-flex;align-items:center;gap:6px;}
.week-legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block;}

  /* æ–°å¢ä¸€ç­†è¡¨å–® */
  form.grid{ display:grid; gap:12px; grid-template-columns: repeat(6, 1fr); }
  form.grid > *{min-width:0}
  form.grid input, form.grid select, form.grid button{
    width:100%; background:#202020; color:#fff; border:1px solid var(--border); padding:10px; border-radius:10px;
  }
  form .col-span-2{grid-column: span 2;}
  form .col-span-3{grid-column: span 3;}
  form .col-span-6{grid-column: span 6;}
  @media (max-width: 600px){
    form.grid{ grid-template-columns:1fr !important; grid-auto-flow:row; justify-items:stretch; }
    form.grid > *{ grid-column:1 / -1 !important; width:100% !important; }
  }

  table{width:100%; border-collapse:collapse; margin-top:10px;}
  th, td{border-bottom:1px solid var(--border); padding:10px 8px; text-align:left; font-size:14px;}
  th{color:var(--muted); font-weight:600;}
  td.amount{font-variant-numeric: tabular-nums;}
  .type-income{color:var(--ok); font-weight:600;}
  .type-expense{color:var(--danger); font-weight:600;}
  .actions button{ background:#2a2a2a; border:1px solid var(--border); color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; }

  /* äº”å¡Šçµ±è¨ˆ */
  .summary{
    display: grid;
    gap: 12px;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }
  .tile{ background:#101010; border:1px solid var(--border); border-radius:14px; padding:14px; }
  .tile h3{margin:0 0 8px 0; font-size:14px; color:var(--muted)}
  .tile .val{font-size:22px; font-variant-numeric: tabular-nums;}
  .tile.income .val{color:var(--ok)}
  .tile.expense .val{color:var(--danger)}
  .tile.net .val{color:var(--accent)}
  .muted{color:var(--muted)}
  .right{display:flex;align-items:center;gap:8px;}
  .spacer{flex:1}

  /* åˆ†é¡å°è¨ˆï¼šä¸Šä¸‹æ’ï¼ˆåœ“é¤…åœ–åœ¨ä¸‹é¢ï¼‰ */
  .cat-wrap{
    display:flex; flex-direction:column; gap:20px; align-items:center; justify-content:center;
  }
  .cat-chart{ width:100%; display:flex; flex-direction:column; align-items:center; }
  .legend{ display:flex; flex-wrap:wrap; gap:10px; font-size:13px; color:var(--muted); }
  .legend .key{ display:inline-flex; align-items:center; gap:6px; }
  .legend .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }

  /* æœ€å¸¸è¨˜çš„ 5 ç­† */
  .freq{ margin-top:14px; background:#101010; border:1px solid var(--border); border-radius:14px; padding:12px; }
  .freq h3{ margin:0 0 8px; font-size:16px; }
  .freq-item{
    display:flex; align-items:center; justify-content:space-between;
    gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; margin-top:6px;
  }
  .rerun{ background:#2a2a2a; color:#fff; border:1px solid var(--border); padding:6px 10px; border-radius:8px; cursor:pointer; }
  .rerun:hover{ filter:brightness(1.12); }

  /* æ¯é€±æ”¯å‡ºçµ±è¨ˆï¼ˆå³ä¸‹è¡¨æ ¼ï¼‰ */
  .weekly{ margin-top:14px; background:#101010; border:1px solid var(--border); border-radius:14px; padding:12px; }
  .weekly h3{ margin:0 0 8px; font-size:16px; }

  /* å·¦å´æ¯é€±åˆ†é¡é¤…ï¼ˆæ–°åŠ çš„é‚£å››å€‹åœ“ï¼‰ */
  .weekly-pies-grid{
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .week-pie{
    background:#101010;
    border:1px solid var(--border);
    border-radius:14px;
    padding:8px 10px 10px;
  }
  .week-title{
    font-size:13px;
    color:var(--muted);
    margin-bottom:4px;
  }
  .week-pie canvas{
    width:100%;
    max-width:260px;
    height:auto;
    display:block;
    margin:0 auto;
  }
  .week-pie .legend{
    margin-top:4px;
    font-size:12px;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .week-pie .legend .key{
    display:inline-flex;
    align-items:center;
    gap:4px;
  }
  .week-pie .legend .dot{
    width:8px;
    height:8px;
    border-radius:50%;
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>æˆ‘çš„è¨˜å¸³æœ¬</h1>
    <div class="controls">
      <button id="prevMonth" title="ä¸Šä¸€å€‹æœˆ">â—€</button>
      <input type="month" id="monthPicker" />
      <button id="nextMonth" title="ä¸‹ä¸€å€‹æœˆ">â–¶</button>
      <span class="muted" id="rangeHint"></span>
      <div class="spacer"></div>

      <button id="editInitBtn" title="è¨­å®šæœ¬æœˆæœŸåˆ">è¨­å®šæœŸåˆ</button>
      <button id="exportBtn" title="åŒ¯å‡º JSON">åŒ¯å‡º</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button id="importBtn" title="åŒ¯å…¥ JSON">åŒ¯å…¥</button>
      <button id="clearBtn" title="æ¸…ç©ºæ‰€æœ‰è³‡æ–™">æ¸…ç©º</button>
      <button id="updateBtn" onclick="forceUpdate()">ğŸ”„ å¼·åˆ¶æ›´æ–°</button>
      <!-- Google ç™»å…¥/ç™»å‡º -->
      <button id="fbLoginBtn"  title="ç”¨ Google ç™»å…¥">ç™»å…¥</button>
      <button id="fbLogoutBtn" title="ç™»å‡º" style="display:none">ç™»å‡º</button>
      <span id="fbWho" class="muted">(æœªç™»å…¥ï¼šåŒ¿åæ¨¡å¼ï¼Œåƒ…æœ¬è£ç½®)</span>

      <!-- GitHub æ‰‹å‹•åŒæ­¥ -->
      <button id="ghLoginBtn" title="ç™»å…¥ GitHubï¼ˆè¼¸å…¥/æ›´æ–° Tokenï¼‰">GitHub ç™»å…¥</button>
      <button id="ghSaveBtn"  title="æŠŠæœ¬æ©Ÿ/é›²ç«¯è³‡æ–™å­˜åˆ° GitHub">åŒæ­¥åˆ° GitHub</button>
      <button id="ghLoadBtn"  title="å¾ GitHub è¼‰å…¥åˆ°æœ¬æ©Ÿ">å¾ GitHub è¼‰å…¥</button>
    </div>
  </header>

  <div class="row">
    <!-- å·¦å´ï¼šæ–°å¢è¨˜å¸³ + æœ€å¸¸è¨˜çš„ 5 ç­† + æ¯é€±åˆ†é¡é¤… -->
    <section class="card">
      <h2>æ–°å¢ä¸€ç­†</h2>
      <form id="entryForm" class="grid">
        <input class="col-span-2" type="date" id="date" required />
        <select class="col-span-2" id="type" required>
          <option value="expense">æ”¯å‡º</option>
          <option value="income">æ”¶å…¥</option>
        </select>
        <input class="col-span-2" type="number" id="amount" inputmode="decimal" step="0.01" placeholder="é‡‘é¡" required />

        <!-- é¡åˆ¥ï¼šæ”¯å‡ºæ‰é¡¯ç¤º -->
        <select class="col-span-3" id="category">
          <option value="">é¸æ“‡é¡åˆ¥</option>
          <option value="åƒ">åƒ</option>
          <option value="äº¤é€š">äº¤é€š</option>
          <option value="ç©">ç©</option>
          <option value="æ´—è¡£æœ">æ´—è¡£æœ</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>

        <!-- å‚™è¨»ï¼šä¸‹æ‹‰ + è¼¸å…¥æ¡† -->
        <select class="col-span-3" id="noteSelect">
          <option value="">ç•™ç©º</option>
          <option value="é›¶é£Ÿ">é›¶é£Ÿ</option>
          <option value="æ—©é¤">æ—©é¤</option>
          <option value="åˆé¤">åˆé¤</option>
          <option value="æ™šé¤">æ™šé¤</option>
          <option value="å®µå¤œ">å®µå¤œ</option>
          <option value="æ›¸è²»">æ›¸è²»</option>
          <option value="å°é½Šç¾å¯¦">å°é½Šç¾å¯¦</option>
          <option value="custom">è«‹è¼¸å…¥å‚™è¨»</option>
        </select>
        <input class="col-span-3" type="text" id="noteInput" placeholder="è«‹è¼¸å…¥å‚™è¨»" style="display:none;" />

        <button class="col-span-6" type="submit">åŠ å…¥</button>
      </form>
      <p class="muted" style="margin-top:8px;">æç¤ºï¼šæœˆä»½çµ±è¨ˆä¾æ—¥æœŸï¼ˆæ¯æœˆ 1 æ—¥ ~ è©²æœˆæœ€å¾Œä¸€å¤©ï¼‰ã€‚</p>

      <div class="freq">
        <h3>æœ€å¸¸è¨˜çš„ 5 ç­†</h3>
        <div id="freqList"></div>
      </div>

<!-- æ–°å¢ï¼šå·¦é‚Š æ¯é€±åˆ†é¡åœ“é¤…åœ–ï¼ˆå‹•æ…‹ç”¢ç”Ÿï¼‰ -->
<div class="weekly">
  <h3>æ¯é€±åˆ†é¡é¤…ï¼ˆæœ¬æœˆæ”¯å‡ºï¼‰</h3>
  <div id="weekPies" class="week-pies-grid"></div>
</div>

    </section>

    <!-- å³å´ï¼šåˆ—è¡¨èˆ‡çµ±è¨ˆ -->
    <section class="card">
      <h2>æœ¬æœˆæ˜ç´°</h2>
      <div class="summary">
        <div class="tile income">
          <h3>æœ¬æœˆæ”¶å…¥</h3>
          <div class="val" id="sumIncome">$0</div>
        </div>
        <div class="tile expense">
          <h3>æœ¬æœˆæ”¯å‡º</h3>
          <div class="val" id="sumExpense">$0</div>
        </div>
        <div class="tile net">
          <h3>æœ¬æœˆæ·¨é¡ï¼ˆæ”¶âˆ’æ”¯ï¼‰</h3>
          <div class="val" id="sumNet">$0</div>
        </div>
        <div class="tile">
          <h3>æœ¬æœˆæœŸåˆï¼ˆæœ¬éŒ¢ï¼‰</h3>
          <div class="val" id="sumInit">$0</div>
        </div>
        <div class="tile">
          <h3>æœ¬æœˆæœŸæœ«ï¼ˆçµé¤˜ï¼‰</h3>
          <div class="val" id="sumEnd">$0</div>
        </div>
      </div>

      <!-- åˆ†é¡å°è¨ˆï¼ˆåªè¨ˆæ”¯å‡ºï¼‰ + åœ“é¤…åœ– -->
      <div class="card" style="background:#101010; border:1px solid var(--border); border-radius:14px; padding:14px; margin-top:12px;">
        <h3 style="margin:0 0 8px 0; font-size:16px; color:var(--muted)">æœ¬æœˆåˆ†é¡å°è¨ˆï¼ˆæ”¯å‡ºï¼‰</h3>
        <div class="cat-wrap">
          <!-- ä¸Šé¢ï¼šè¡¨æ ¼ -->
          <table id="catTable" style="max-width:860px;width:100%;">
            <thead>
              <tr>
                <th style="width:120px">åˆ†é¡</th>
                <th style="width:140px">é‡‘é¡å°è¨ˆ</th>
                <th>ç­†æ•¸</th>
              </tr>
            </thead>
            <tbody id="catTbody"></tbody>
          </table>

          <!-- ä¸‹é¢ï¼šåœ“é¤…åœ– -->
          <div class="cat-chart" style="margin-top:6px;">
            <canvas id="catPie" width="360" height="240" style="width:100%;max-width:420px;height:auto;display:block;"></canvas>
            <div id="catLegend" class="legend" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>

      <!-- æ¯é€±æ”¯å‡ºçµ±è¨ˆï¼ˆæœ¬æœˆï¼‰ -->
      <div class="weekly">
        <h3>æ¯é€±æ”¯å‡ºçµ±è¨ˆï¼ˆæœ¬æœˆï¼‰</h3>
        <table>
          <thead>
            <tr>
              <th style="width:80px">ç¬¬å¹¾é€±</th>
              <th style="width:200px">æ—¥æœŸç¯„åœ</th>
              <th style="width:120px">æ”¯å‡ºé‡‘é¡</th>
            </tr>
          </thead>
          <tbody id="weeklyTbody"></tbody>
        </table>
      </div>

      <table id="table">
        <thead>
          <tr>
            <th style="width:110px">æ—¥æœŸ</th>
            <th style="width:80px">æ”¶/æ”¯</th>
            <th style="width:110px">é‡‘é¡</th>
            <th>é¡åˆ¥</th>
            <th>å‚™è¨»</th>
            <th style="width:90px">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </div>
</div>

<script>
/* ===========================
   Ledger App (single <script> replacement)
   - ä¿®æ­£ï¼šå‹•æ…‹é€±æ•¸åœ“é¤…ï¼ˆä¸å†å›ºå®š 4 é€±/5 é€±ï¼‰
   - ä¿®æ­£ï¼šä¸å†æœ‰ã€ŒéŠé›¢ç¨‹å¼ç¢¼ã€é€ æˆæ•´æ”¯ JS çˆ†ç‚¸
   - ä¿®æ­£ï¼šé€±å€é–“/é¡¯ç¤ºçµ±ä¸€ç”¨ã€Œæœ¬åœ°æ™‚é–“ã€
   =========================== */

(() => {
  const BUILD = "v12-weekly-pies-dynamic-fixed";
  console.log("Build:", BUILD);

  /* ============== Firebaseï¼ˆæ²¿ç”¨ä½ çš„å°ˆæ¡ˆè¨­å®šï¼‰ ============== */
  const firebaseConfig = {
    apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
    authDomain: "eyvind95-182f0.firebaseapp.com",
    projectId: "eyvind95-182f0",
    storageBucket: "eyvind95-182f0.firebasestorage.app",
    messagingSenderId: "105770576221",
    appId: "1:105770576221:web:4256dca5ec54b7cf91a0b4"
  };

  function initFirebaseApp(){
    if(!window.firebase) {
      console.error("Firebase SDK not found. è«‹ç¢ºèªå·²è¼‰å…¥ firebase-app / auth / firestore");
      return;
    }
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  }
  initFirebaseApp();

  /* ============== Firestore èˆ‡ UID ============== */
  let db = firebase.firestore();
  let CURRENT_UID = null;
  const googleProvider = new firebase.auth.GoogleAuthProvider();
  googleProvider.setCustomParameters({ prompt: "select_account" });

  firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

  function isStandaloneLike () {
    return (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches)
        || window.navigator.standalone === true
        || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  }

  function userDoc(){ return db.collection("users").doc(CURRENT_UID); }
  function colEntries(){ return userDoc().collection("entries"); }
  function colInitials(){ return userDoc().collection("initials"); }

  /* ============== GitHub ä¸€éµåŒæ­¥ï¼ˆé¸ç”¨ï¼‰ ============== */
  const GH_OWNER = "Eyvind95";
  const GH_REPO  = "hello";
  const GH_BRANCH = "main";
  const GH_ENTRIES_PATH  = "data/entries.json";
  const GH_INITIALS_PATH = "data/initials.json";
  const GH_TOKEN_KEY = "gh_pat_my_ledger";

  function ghGetToken(){ return localStorage.getItem(GH_TOKEN_KEY) || ""; }
  function ghSetToken(t){
    if(!t) return;
    localStorage.setItem(GH_TOKEN_KEY, t);
    alert("å·²å„²å­˜ GitHub Tokenï¼ˆå­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ï¼‰");
  }

  async function ghApi(path, method="GET", body){
    const token = ghGetToken();
    if(!token) throw new Error("å°šæœªè¨­å®š GitHub Token");
    const res = await fetch(`https://api.github.com${path}`, {
      method,
      headers: {
        "Authorization": `Bearer ${token}`,
        "Accept": "application/vnd.github+json"
      },
      body: body ? JSON.stringify(body) : undefined
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(`GitHub API ${res.status}: ${t}`);
    }
    return res.json();
  }

  async function ghReadFile(repoPath){
    return ghApi(`/repos/${GH_OWNER}/${GH_REPO}/contents/${repoPath}?ref=${GH_BRANCH}`,"GET");
  }

  async function ghWriteFile(repoPath, jsonObj, message){
    const contentStr = JSON.stringify(jsonObj, null, 2);
    const base64 = btoa(unescape(encodeURIComponent(contentStr)));
    let sha = undefined;
    try{
      const exist = await ghReadFile(repoPath);
      sha = exist.sha;
    }catch(e){}
    return ghApi(`/repos/${GH_OWNER}/${GH_REPO}/contents/${repoPath}`, "PUT", {
      message: message || `update ${repoPath}`,
      content: base64,
      branch: GH_BRANCH,
      sha
    });
  }

  function base64ToJson(b64){
    const str = decodeURIComponent(escape(atob(b64)));
    return JSON.parse(str);
  }

  /* ============== å…±ç”¨å·¥å…· & æœ¬æ©Ÿå„²å­˜ ============== */
  const $  = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const LS_KEY = "ledgerEntries_v1";
  const INITIALS_KEY = "ledgerInitials_v1";

  const fmtMoney = (n) =>
    new Intl.NumberFormat("zh-Hant-TW", { style: "currency", currency: "TWD" })
      .format(Number(n)||0);

  const ymd = (d) => d.toISOString().slice(0,10);

  // âœ… å…¨ç¨‹ç”¨æœ¬åœ° 00:00ï¼Œé¿å… UTC åç§»
  const toDate = (s) => {
    // s: "YYYY-MM-DD"
    const [yy, mm, dd] = (s||"").split("-").map(x=>parseInt(x,10));
    if(!yy || !mm || !dd) return new Date("Invalid");
    return new Date(yy, mm-1, dd, 0,0,0,0);
  };

  function round2(n){ return Math.round((Number(n)||0) * 100) / 100; }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, c => ({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      '"':"&quot;",
      "'":"&#039;"
    }[c]));
  }

  function monthKey(y, m){ return `${y}-${String(m).padStart(2,"0")}`; } // m:1-12

  function prevMonthOf(y, m){
    const d = new Date(y, m-1, 1);
    d.setMonth(d.getMonth()-1);
    return { y: d.getFullYear(), m: d.getMonth()+1 };
  }

  // monthIdx: 0=Jan..11=Dec
  // âœ… æœ¬åœ°æ™‚é–“ 00:00 ~ 23:59:59.999
  function getMonthRange(year, monthIdx){
    const start = new Date(year, monthIdx, 1);
    const end   = new Date(year, monthIdx + 1, 0);
    start.setHours(0,0,0,0);
    end.setHours(23,59,59,999);
    return { start, end };
  }

  /* ============== æœ¬æ©Ÿå„²å­˜ ============== */
  function loadLocal(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : [];
    }catch(e){ return []; }
  }
  function saveLocal(list){
    localStorage.setItem(LS_KEY, JSON.stringify(list));
  }
  function loadInitialsLocal(){
    try{
      const raw = localStorage.getItem(INITIALS_KEY);
      return raw ? JSON.parse(raw) : {};
    }catch(e){ return {}; }
  }
  function saveInitialsLocal(obj){
    localStorage.setItem(INITIALS_KEY, JSON.stringify(obj));
  }

  /* ============== é›²ç«¯è®€å¯« ============== */
  async function cloudLoad(){
    if(!CURRENT_UID) return [];
    const list = [];
    const snap = await colEntries().get();
    snap.forEach(doc => list.push(doc.data()));
    list.sort((a,b)=>
      (a.date===b.date
        ? (a.createdAt||0)-(b.createdAt||0)
        : a.date.localeCompare(b.date))
    );
    return list;
  }

  async function cloudLoadInitials(){
    if(!CURRENT_UID) return {};
    const obj = {};
    const snap = await colInitials().get();
    snap.forEach(doc => { obj[doc.id] = (doc.data().amount || 0); });
    return obj;
  }

  async function cloudSave(all){
    if(!CURRENT_UID) return;

    const cur = await colEntries().get();
    const del = db.batch();
    cur.forEach(doc=> del.delete(doc.ref));
    await del.commit();

    const batch = db.batch();
    for(const it of all){
      batch.set(colEntries().doc(it.id), it);
    }
    await batch.commit();
  }

  async function cloudSaveInitials(obj){
    if(!CURRENT_UID) return;

    const cur = await colInitials().get();
    const del = db.batch();
    cur.forEach(doc=> del.delete(doc.ref));
    await del.commit();

    const batch = db.batch();
    for(const [k,v] of Object.entries(obj)){
      batch.set(colInitials().doc(k), { amount: Number(v)||0 });
    }
    await batch.commit();
  }

  /* ============== çµ±ä¸€å­˜å–ï¼šé›²ç«¯å„ªå…ˆï¼Œå¤±æ•—é€€æœ¬æ©Ÿ ============== */
  async function loadUnified(){
    try{
      if(CURRENT_UID){
        const [list, ini] = await Promise.all([cloudLoad(), cloudLoadInitials()]);
        saveLocal(list);
        saveInitialsLocal(ini);
        return { list, initials: ini };
      }
    }catch(e){
      alert("é›²ç«¯è®€å–å¤±æ•—ï¼Œæ”¹ç”¨æœ¬æ©Ÿè³‡æ–™");
    }
    return { list: loadLocal(), initials: loadInitialsLocal() };
  }

  async function saveUnified(){
    if(CURRENT_UID){
      try{
        await Promise.all([cloudSave(entries), cloudSaveInitials(initials)]);
        return;
      }catch(e){
        alert("é›²ç«¯å„²å­˜å¤±æ•—ï¼Œè³‡æ–™å…ˆç•™åœ¨æœ¬æ©Ÿ");
      }
    }
    saveLocal(entries);
    saveInitialsLocal(initials);
  }

  /* ============== ç‹€æ…‹èˆ‡åˆå§‹åŒ– ============== */
  let entries = [];
  let initials = {};

  const monthPicker = $("#monthPicker");
  const today = new Date();
  if(monthPicker) monthPicker.value = today.toISOString().slice(0,7);
  if($("#date")) $("#date").value = ymd(today);
  
// æ—¥æœŸæ”¹è®Šæ™‚ï¼Œè‡ªå‹•åˆ‡æ›åˆ°è©²å¹´æœˆ
$("#date").addEventListener("change", () => {
  const d = $("#date").value; // yyyy-mm-dd
  if(!d) return;
  const ym = d.slice(0, 7);
  if (monthPicker.value !== ym) {
    monthPicker.value = ym;
    renderWithEnsure();
  }
});
  /* ============== Google ç™»å…¥ / ç™»å‡º ============== */
  async function googleLogin(){
    try{
      if(isStandaloneLike()){
        await firebase.auth().signInWithRedirect(googleProvider);
        return;
      }
      await firebase.auth().signInWithPopup(googleProvider);
    }catch(e){
      const code = e.code || "";
      const needRedirect = [
        "auth/operation-not-supported-in-this-environment",
        "auth/popup-blocked",
        "auth/popup-closed-by-user",
        "auth/cancelled-popup-request"
      ];
      if(needRedirect.includes(code)){
        try{
          await firebase.auth().signInWithRedirect(googleProvider);
          return;
        }catch(err2){
          alert("æ”¹ç”¨ Redirect ä»å¤±æ•—ï¼š\n" + (err2.message || err2));
        }
      }else if(code === "auth/unauthorized-domain"){
        alert("æ­¤ç¶²åŸŸæœªåŠ å…¥ Firebase å…è¨±æ¸…å–®ï¼š\nFirebase > Authentication > Settings > Authorized domains\nåŠ å…¥ eyvind95.github.io");
      }else{
        alert("Google ç™»å…¥å¤±æ•—ï¼š\n" + (e.message || e));
      }
    }
  }

  async function googleLogout(){
    await firebase.auth().signOut();
    CURRENT_UID = null;
    updateLoginUI(null);
    const loaded = await loadUnified();
    entries = loaded.list;
    initials = loaded.initials;
    renderWithEnsure();
  }

  firebase.auth().onAuthStateChanged(async (user)=>{
    if(user){
      CURRENT_UID = user.uid;
      updateLoginUI(user);
    }else{
      CURRENT_UID = null;
      updateLoginUI(null);
    }
    const loaded = await loadUnified();
    entries = loaded.list;
    initials = loaded.initials;
    renderWithEnsure();
  });

  function updateLoginUI(user){
    if(!$("#fbWho")) return;
    if(user){
      $("#fbWho").textContent = `å·²ç™»å…¥ï¼š${user.email || "Google å¸³è™Ÿ"}`;
      if($("#fbLoginBtn")) $("#fbLoginBtn").style.display="none";
      if($("#fbLogoutBtn")) $("#fbLogoutBtn").style.display="";
    }else{
      $("#fbWho").textContent = "(æœªç™»å…¥ï¼šåŒ¿åæ¨¡å¼ï¼Œåƒ…æœ¬è£ç½®)";
      if($("#fbLoginBtn")) $("#fbLoginBtn").style.display="";
      if($("#fbLogoutBtn")) $("#fbLogoutBtn").style.display="none";
    }
  }

  /* ============== äº‹ä»¶ï¼šæ–°å¢/åˆªé™¤/åŒ¯å‡º/åŒ¯å…¥/æ¸…ç©º ============== */
  if($("#entryForm")){
    $("#entryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const date = $("#date")?.value;
      const type = $("#type")?.value; // income | expense
      const amountStr = $("#amount")?.value?.trim() || "";
      const category = (type === "expense") ? ($("#category")?.value || "") : "";

      let note = "";
      const noteSelect = $("#noteSelect");
      const noteInput = $("#noteInput");
      if(noteSelect){
        if(noteSelect.value === "custom") note = (noteInput?.value || "").trim();
        else note = noteSelect.value || "";
      }

      if(!date || !type || !amountStr) return;

      const amount = parseFloat(amountStr);
      if(isNaN(amount) || amount <= 0){
        alert("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡ï¼ˆ> 0ï¼‰");
        return;
      }

      const entry = {
        id: crypto.randomUUID(),
        date,
        type,
        amount: round2(amount),
        category,
        note,
        createdAt: Date.now()
      };

      entries.push(entry);
      await saveUnified();

      if($("#amount")) $("#amount").value = "";
      if(noteInput) noteInput.value = "";
      if(noteSelect) noteSelect.value = "";

      renderWithEnsure();
    });
  }

  async function removeEntry(id){
    if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†ï¼Ÿ")) return;
    entries = entries.filter(e => e.id !== id);
    await saveUnified();
    renderWithEnsure();
  }

  if($("#exportBtn")){
    $("#exportBtn").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify({entries, initials}, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ledger_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    });
  }

  if($("#importBtn") && $("#importFile")){
    $("#importBtn").addEventListener("click", () => $("#importFile").click());
    $("#importFile").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!data || !Array.isArray(data.entries) || typeof data.initials !== "object")
          throw new Error("æ ¼å¼éŒ¯èª¤");
        for(const it of data.entries){
          if(!it.id || !it.date || !it.type || !it.amount)
            throw new Error("æ˜ç´°ç¼ºå°‘å¿…è¦æ¬„ä½");
        }
        entries  = data.entries;
        initials = data.initials;
        await saveUnified();
        alert("åŒ¯å…¥å®Œæˆï¼");
        renderWithEnsure();
      }catch(err){
        alert("åŒ¯å…¥å¤±æ•—ï¼š" + err.message);
      }finally{
        e.target.value = "";
      }
    });
  }

  if($("#clearBtn")){
    $("#clearBtn").addEventListener("click", async () => {
      if(confirm("é€™æœƒåˆªé™¤æ‰€æœ‰ã€æ˜ç´°ï¼‹æœŸåˆã€è³‡æ–™ï¼ˆä¸å¯å¾©åŸï¼‰ã€‚ç¢ºå®šï¼Ÿ")){
        entries = [];
        initials = {};
        await saveUnified();
        renderWithEnsure();
      }
    });
  }

  if($("#type") && $("#category")){
    $("#type").addEventListener("change", () => {
      $("#category").style.display = ($("#type").value === "income") ? "none" : "block";
    });
    $("#type").dispatchEvent(new Event("change"));
  }

  if($("#noteSelect") && $("#noteInput")){
    $("#noteSelect").addEventListener("change", () => {
      const sel = $("#noteSelect").value;
      const input = $("#noteInput");
      if(sel === "custom") input.style.display = "block";
      else { input.style.display = "none"; input.value = ""; }
    });
  }

  /* ============== æœŸåˆé‚è¼¯ï¼šè¨­å®šã€æ‰¿æ¥ã€é¡¯ç¤º ============== */
  function ensureInitialForMonth(y, m){
    const mk = monthKey(y, m);
    if(initials[mk] !== undefined) return;

    // æ‰¿æ¥ä¸ŠæœˆæœŸæœ«
    const { y:py, m:pm } = prevMonthOf(y, m);
    const pmk = monthKey(py, pm);
    let prevInit = Number(initials[pmk] ?? 0);

    const {start:ps, end:pe} = getMonthRange(py, pm-1);
    let pIncome = 0, pExpense = 0;
    for(const it of entries){
      const d = toDate(it.date);
      if(d >= ps && d <= pe){
        if(it.type === "income") pIncome += it.amount;
        else pExpense += it.amount;
      }
    }
    pIncome = round2(pIncome);
    pExpense = round2(pExpense);
    const prevEnd = round2(prevInit + pIncome - pExpense);

    if(initials[pmk] !== undefined || pIncome > 0 || pExpense > 0){
      initials[mk] = prevEnd;
    }else{
      const v = prompt(`è«‹è¼¸å…¥ ${y} å¹´ ${m} æœˆçš„æœŸåˆé‡‘é¡ï¼ˆæœ¬éŒ¢ï¼‰ï¼š`, "0");
      const n = Number(v);
      initials[mk] = Number.isFinite(n) ? round2(n) : 0;
    }
    saveUnified();
  }

  if($("#editInitBtn")){
    $("#editInitBtn").addEventListener("click", async () => {
      const [y, m] = (monthPicker?.value || "").split("-").map(x=>parseInt(x,10));
      if(!y || !m) return;
      const mk = monthKey(y, m);
      const cur = Number(initials[mk] ?? 0);
      const v = prompt(`è¨­å®š ${y} å¹´ ${m} æœˆæœŸåˆé‡‘é¡ï¼š`, String(cur));
      if(v === null) return;
      const n = Number(v);
      initials[mk] = Number.isFinite(n) ? round2(n) : cur;
      await saveUnified();
      renderWithEnsure();
    });
  }

  /* ============== æœˆä»½åˆ‡æ›ï¼ˆæœ¬åœ°æœˆä»½ï¼Œé¿å… UTCï¼‰ ============== */
  if($("#prevMonth")) $("#prevMonth").addEventListener("click", () => shiftMonth(-1));
  if($("#nextMonth")) $("#nextMonth").addEventListener("click", () => shiftMonth(1));
  if(monthPicker) monthPicker.addEventListener("change", renderWithEnsure);

  function shiftMonth(delta){
    const [y, m] = (monthPicker?.value || "").split("-").map(x=>parseInt(x,10));
    if(!y || !m) return;
    const d = new Date(y, m-1, 1);
    d.setMonth(d.getMonth() + delta);
    monthPicker.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    renderWithEnsure();
  }

// åªç”¨æœ¬åœ°æ™‚é–“ï¼šé€±ä¸€~é€±æ—¥ï¼Œä¸¦è£åˆ‡åœ¨æœ¬æœˆå…§ï¼ˆæœƒåŒ…å« 1 è™Ÿé‚£é€±çš„æ®˜é€±ï¼‰
function buildWeeksOfMonth(y, m){ // m:1~12
  const start = new Date(y, m-1, 1, 0, 0, 0, 0);           // æœ¬åœ°
  const end   = new Date(y, m,   0, 23,59,59,999);         // æœ¬åœ°

  // æ‰¾åˆ°ã€ŒåŒ…å«æœ¬æœˆ 1 è™Ÿã€é‚£ä¸€é€±çš„é€±ä¸€ï¼ˆå¯èƒ½è½åœ¨ä¸Šå€‹æœˆï¼‰
  const first = new Date(start);
  const day = first.getDay(); // 0 Sun..6 Sat
  const diff = (day === 0) ? -6 : (1 - day); // é€±æ—¥->å›åˆ°å‰é€±ä¸€ï¼Œå…¶å®ƒ->å›åˆ°æœ¬é€±ä¸€
  first.setDate(first.getDate() + diff);
  first.setHours(0,0,0,0);

  const weeks = [];
  let ws = new Date(first);
  let idx = 1;

  while (ws <= end){
    const we = new Date(ws);
    we.setDate(we.getDate() + 6);
    we.setHours(23,59,59,999);

    const rangeStart = new Date(Math.max(ws.getTime(), start.getTime()));
    rangeStart.setHours(0,0,0,0);

    const rangeEnd = new Date(Math.min(we.getTime(), end.getTime()));
    rangeEnd.setHours(23,59,59,999);

    // åªè¦é€™é€±è·Ÿæœ¬æœˆæœ‰äº¤é›†ï¼Œå°±æ”¶é€²ä¾†
    if (rangeStart <= rangeEnd){
      weeks.push({ idx: idx++, s: rangeStart, e: rangeEnd });
    }

    ws.setDate(ws.getDate() + 7);
    ws.setHours(0,0,0,0);
  }

  return weeks;
}

  /* ============== åœ“é¤…åœ–ï¼šå…±ç”¨ç•«æ³• ============== */
  function drawPie(canvasId, data, total){
    const canvas = document.getElementById(canvasId);
    if(!canvas) return;
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(!total || total<=0){
      ctx.beginPath();
      ctx.arc(canvas.width/2, canvas.height/2,
              Math.min(canvas.width, canvas.height)/2 - 10,
              0, Math.PI*2);
      ctx.strokeStyle = "rgba(255,255,255,0.15)";
      ctx.lineWidth = 10;
      ctx.stroke();
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.font = "14px system-ui, -apple-system, 'Segoe UI', Roboto";
      ctx.textAlign = "center";
      ctx.fillText("æœ¬é€±å°šç„¡æ”¯å‡º", canvas.width/2, canvas.height/2+5);
      return;
    }

    const cx = canvas.width/2, cy = canvas.height/2;
    const r  = Math.min(canvas.width, canvas.height)/2 - 8;
    let start = -Math.PI/2;

    for(const d of data){
      if(d.value<=0) continue;
      const ang = d.value/total * Math.PI*2;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,start+ang);
      ctx.closePath();
      ctx.fillStyle=d.color;
      ctx.fill();
      start += ang;
    }

    // donut hole
    ctx.beginPath();
    ctx.arc(cx,cy,r*0.55,0,Math.PI*2);
    ctx.fillStyle="#101010";
    ctx.fill();

    ctx.fillStyle="rgba(255,255,255,0.9)";
    ctx.font="12px system-ui, -apple-system, 'Segoe UI', Roboto";
    ctx.textAlign="center";
    ctx.fillText("ç¸½æ”¯å‡º",cx,cy-4);
    ctx.font="16px system-ui, -apple-system, 'Segoe UI', Roboto";
    ctx.fillText(fmtMoney(total),cx,cy+18);
  }

  /* ============== åˆ†é¡å°è¨ˆï¼ˆæ•´æœˆï¼‰ï¼‹ æœˆåœ“é¤… ============== */
  function renderCategorySummary(monthItems){
    const cats = ["åƒ","äº¤é€š","ç©","æ´—è¡£æœ","å…¶ä»–"];
    const colors = {
      "åƒ":"#ff7f50",
      "äº¤é€š":"#ffd93b",
      "ç©":"#6ec5ff",
      "æ´—è¡£æœ":"#b19cd9",
      "å…¶ä»–":"#aaaaaa"
    };

    const map = new Map(cats.map(c => [c, {sum:0, count:0}]));
    for(const it of monthItems){
      if(it.type !== "expense") continue;
      const key = (it.category || "").trim();
      if(map.has(key)){
        const rec = map.get(key);
        rec.sum   = round2(rec.sum + it.amount);
        rec.count += 1;
      }else{
        // ä»»ä½•éäº”é¡ â†’ ä¸Ÿåˆ°ã€Œå…¶ä»–ã€
        const rec = map.get("å…¶ä»–");
        rec.sum   = round2(rec.sum + it.amount);
        rec.count += 1;
      }
    }

    // è¡¨æ ¼
    const tbody = document.getElementById("catTbody");
    if(tbody){
      tbody.innerHTML = cats.map(cat=>{
        const rec = map.get(cat);
        return `<tr><td>${cat}</td><td class="amount">${fmtMoney(rec.sum)}</td><td>${rec.count}</td></tr>`;
      }).join("");
    }

    // æœˆåœ“é¤…
    const data  = cats.map(c => ({ label:c, value: map.get(c).sum, color: colors[c] }));
    const total = data.reduce((s,d)=>s+d.value,0);
    drawPie("catPie", data, total);

    const legend = document.getElementById("catLegend");
    if(legend){
      legend.innerHTML = (total<=0)
        ? `<span class="muted">æœ¬æœˆå°šç„¡æ”¯å‡º</span>`
        : data.filter(d=>d.value>0)
             .map(d=>{
               const pct=((d.value/total)*100).toFixed(1);
               return `<span class="key"><span class="dot" style="background:${d.color}"></span>${d.label} ${pct}%</span>`;
             }).join(" ");
    }
  }

  /* ============== æœ€å¸¸è¨˜çš„ 5 ç­†ï¼ˆæŒ‰ é‡‘é¡+é¡åˆ¥ çµ±è¨ˆï¼‰ ============== */
  function renderFrequentPairs(list){
    const box = $("#freqList");
    if(!box) return;

    const countMap = new Map(); // key: "80.00|åƒ"
    for(const it of list){
      if(it.type !== "expense") continue;
      const amt = round2(it.amount);
      const cat = (it.category||"").trim();
      const key = `${amt.toFixed(2)}|${cat}`;
      const cur = countMap.get(key) || { amount: amt, category: cat, count: 0, last: 0 };
      cur.count += 1;
      cur.last   = Math.max(cur.last, it.createdAt||0);
      countMap.set(key, cur);
    }

    const arr = Array.from(countMap.values())
      .sort((a,b)=> b.count - a.count || b.last - a.last)
      .slice(0,5);

    box.innerHTML = arr.map(p => `
      <div class="freq-item">
        <div><strong>${fmtMoney(p.amount)}</strong> <span class="muted">ï¼ˆ${escapeHtml(p.category||"â€”")}ï¼‰ Ã— ${p.count}</span></div>
        <button class="rerun" data-amount="${p.amount}" data-category="${escapeHtml(p.category||"")}">å†è¨˜ä¸€æ¬¡</button>
      </div>
    `).join("");

    $$("#freqList .rerun").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const amount   = Number(btn.dataset.amount);
        const category = btn.dataset.category || "";
        const entry = {
          id: crypto.randomUUID(),
          date: ymd(new Date()),
          type: "expense",
          amount: round2(amount),
          category,
          note: "",
          createdAt: Date.now()
        };
        entries.push(entry);
        await saveUnified();
        renderWithEnsure();
      });
    });
  }

  /* ============== æ¯é€±æ”¯å‡ºçµ±è¨ˆï¼ˆå³ä¸‹è¡¨æ ¼ï¼‰ ============== */
  function renderWeekly(monthItems, y, m){
    const tbody = $("#weeklyTbody");
    if(!tbody) return;

    const weeks = buildWeeksOfMonth(y, m);
    let html = "";

    for(const w of weeks){
      let sum = 0;
      for(const it of monthItems){
        if(it.type !== "expense") continue;
        const d = toDate(it.date);
        if(d >= w.s && d <= w.e) sum += it.amount;
      }
      sum = round2(sum);

      // âœ… é¡¯ç¤ºä¹Ÿç”¨æœ¬åœ°æ™‚é–“
      const sTxt = `${String(w.s.getMonth()+1).padStart(2,"0")}/${String(w.s.getDate()).padStart(2,"0")}`;
      const eTxt = `${String(w.e.getMonth()+1).padStart(2,"0")}/${String(w.e.getDate()).padStart(2,"0")}`;

      html += `<tr><td>ç¬¬ ${w.idx} é€±</td><td>${sTxt} ~ ${eTxt}</td><td class="amount">${fmtMoney(sum)}</td></tr>`;
    }

    tbody.innerHTML = html || `<tr><td colspan="3" class="muted">æœ¬æœˆå°šç„¡æ”¯å‡º</td></tr>`;
  }

  /* ============== âœ… å‹•æ…‹é€±æ•¸åˆ†é¡åœ“é¤…ï¼ˆå·¦å´ weekPies å®¹å™¨ï¼‰ ============== */
  function renderWeeklyPies(monthItems, y, m){
    const box = document.getElementById("weekPies");
    if(!box) return;

    const cats = ["åƒ","äº¤é€š","ç©","æ´—è¡£æœ","å…¶ä»–"];
    const colors = {
      "åƒ":"#ff7f50",
      "äº¤é€š":"#ffd93b",
      "ç©":"#6ec5ff",
      "æ´—è¡£æœ":"#b19cd9",
      "å…¶ä»–":"#aaaaaa"
    };

    const weeks = buildWeeksOfMonth(y, m);

    // ç”Ÿæˆå¡ç‰‡
    box.innerHTML = weeks.map(w=>{
      const sTxt = `${String(w.s.getMonth()+1).padStart(2,"0")}/${String(w.s.getDate()).padStart(2,"0")}`;
      const eTxt = `${String(w.e.getMonth()+1).padStart(2,"0")}/${String(w.e.getDate()).padStart(2,"0")}`;
      return `
        <div class="week-card">
          <div class="week-title">ç¬¬ ${w.idx} é€±ï¼ˆ${sTxt} ~ ${eTxt}ï¼‰</div>
          <canvas id="weekPie_${w.idx}" width="360" height="240" style="width:100%;max-width:420px;height:auto;display:block;"></canvas>
          <div id="weekLegend_${w.idx}" class="week-legend"></div>
        </div>
      `;
    }).join("");

    // ç•«åœ– + legend
    for(const w of weeks){
      const sums = new Map(cats.map(c=>[c,0]));

      for(const it of monthItems){
        if(it.type !== "expense") continue;
        const d = toDate(it.date);
        if(d < w.s || d > w.e) continue;

        const c = (it.category||"").trim();
        if(sums.has(c)) sums.set(c, round2(sums.get(c) + it.amount));
        else sums.set("å…¶ä»–", round2(sums.get("å…¶ä»–") + it.amount));
      }

      const data = cats.map(c=>({ label:c, value:sums.get(c), color:colors[c] }));
      const total = data.reduce((s,d)=>s+d.value,0);

      drawPie(`weekPie_${w.idx}`, data, total);

      const legend = document.getElementById(`weekLegend_${w.idx}`);
      if(legend){
        legend.innerHTML = (total<=0)
          ? `<span class="muted">æœ¬é€±å°šç„¡æ”¯å‡º</span>`
          : data.filter(d=>d.value>0).map(d=>{
              return `<span class="key"><span class="dot" style="background:${d.color}"></span>${d.label} ${fmtMoney(d.value)}</span>`;
            }).join(" ");
      }
    }
  }

  /* ============== æ¸²æŸ“ä¸»æµç¨‹ ============== */
  function renderWithEnsure(){
    const [y, m] = (monthPicker?.value || "").split("-").map(x=>parseInt(x,10));
    if(!y || !m) return;
    ensureInitialForMonth(y, m);
    render();
  }

  function render(){
    const [y, m] = (monthPicker?.value || "").split("-").map(x=>parseInt(x,10));
    if(!y || !m) return;

    const {start, end} = getMonthRange(y, m - 1);

    // å€é–“æç¤ºï¼ˆæœ¬åœ°é¡¯ç¤ºï¼‰
    if($("#rangeHint")){
      $("#rangeHint").textContent =
        `${y}å¹´${m}æœˆ 1 æ—¥ ~ ${y}å¹´${m}æœˆ ${end.getDate()} æ—¥`;
    }

    // æœ¬æœˆè³‡æ–™ï¼ˆæ•´æœˆï¼‰
    const monthItems = entries
      .filter(e => {
        const d = toDate(e.date);
        return d >= start && d <= end;
      })
      .sort((a,b) =>
        (a.date === b.date
          ? (a.createdAt||0) - (b.createdAt||0)
          : a.date.localeCompare(b.date))
      );

    // âœ… åªé¡¯ç¤ºè¿‘ä¸ƒå¤© + æœ¬æœˆæœªä¾†æ—¥æœŸï¼ˆé¿å…è¨˜åˆ°æœªä¾†åˆªä¸åˆ°ï¼‰
    const todayLocal = new Date();
    todayLocal.setHours(0,0,0,0);
    const sevenDaysAgo = new Date(todayLocal);
    sevenDaysAgo.setDate(todayLocal.getDate() - 6);

    const endOfToday = new Date(todayLocal);
    endOfToday.setHours(23,59,59,999);

    const recentItems = monthItems.filter(it => {
      const d = toDate(it.date);
      return (d >= sevenDaysAgo && d <= endOfToday) || d > endOfToday;
    });

    // æ˜ç´°è¡¨ï¼ˆè¿‘ 7 å¤© + æœªä¾†ï¼‰
    const tbody = $("#tbody");
    if(tbody){
      tbody.innerHTML = "";
      for(const it of recentItems){
        const tr = document.createElement("tr");
        const typeClass = it.type === "income" ? "type-income" : "type-expense";
        tr.innerHTML = `
          <td>${escapeHtml(it.date)}</td>
          <td class="${typeClass}">${it.type === "income" ? "æ”¶å…¥" : "æ”¯å‡º"}</td>
          <td class="amount">${fmtMoney(it.amount)}</td>
          <td>${escapeHtml(it.category || "")}</td>
          <td>${escapeHtml(it.note || "")}</td>
          <td class="actions"><button data-id="${it.id}" class="del">åˆªé™¤</button></td>
        `;
        tbody.appendChild(tr);
      }
      $$("#tbody .del").forEach(btn =>
        btn.addEventListener("click", () => removeEntry(btn.dataset.id))
      );
    }

    // çµ±è¨ˆï¼ˆæ•´æœˆï¼‰
    let income = 0, expense = 0;
    for(const it of monthItems){
      if(it.type === "income") income += it.amount;
      else expense += it.amount;
    }
    income = round2(income);
    expense = round2(expense);
    const net = round2(income - expense);

    if($("#sumIncome")) $("#sumIncome").textContent = fmtMoney(income);
    if($("#sumExpense")) $("#sumExpense").textContent = fmtMoney(expense);
    if($("#sumNet")) $("#sumNet").textContent = fmtMoney(net);

    // æœŸåˆ & æœŸæœ«
    const mk = monthKey(y, m);
    const initAmt = Number(initials[mk] ?? 0);
    const endAmt  = round2(initAmt + income - expense);

    if($("#sumInit")) $("#sumInit").textContent = fmtMoney(initAmt);
    if($("#sumEnd")) $("#sumEnd").textContent = fmtMoney(endAmt);

    // åˆ†é¡å°è¨ˆ + æœˆåœ“é¤…
    renderCategorySummary(monthItems);

    // æœ€å¸¸è¨˜çš„ 5 ç­†
    renderFrequentPairs(monthItems);

    // æ¯é€±æ”¯å‡ºçµ±è¨ˆï¼ˆè¡¨ï¼‰
    renderWeekly(monthItems, y, m);

    // âœ… æ¯é€±åˆ†é¡åœ“é¤…ï¼ˆå‹•æ…‹é€±æ•¸ï¼‰
    renderWeeklyPies(monthItems, y, m);
  }

  /* ============== GitHub æŒ‰éˆ•äº‹ä»¶ ============== */
  if($("#ghLoginBtn")){
    $("#ghLoginBtn").addEventListener("click", () => {
      const cur = ghGetToken();
      const t = prompt("è²¼ä¸Šä½ çš„ GitHub Fine-grained Tokenï¼ˆåªæœƒå­˜æœ¬æ©Ÿï¼‰:", cur || "");
      if(t) ghSetToken(t.trim());
    });
  }

  if($("#ghSaveBtn")){
    $("#ghSaveBtn").addEventListener("click", async () => {
      try{
        await ghWriteFile(GH_ENTRIES_PATH, entries, "save: entries");
        await ghWriteFile(GH_INITIALS_PATH, initials, "save: initials");
        alert("å·²åŒæ­¥åˆ° GitHub âœ…");
      }catch(e){
        alert("åŒæ­¥å¤±æ•—ï¼š\n" + e.message);
      }
    });
  }

  if($("#ghLoadBtn")){
    $("#ghLoadBtn").addEventListener("click", async () => {
      if(!confirm("é€™æœƒç”¨ GitHub ä¸Šçš„è³‡æ–™è¦†è“‹æœ¬æ©Ÿï¼ˆæ­¤è£ç½®ï¼‰çš„è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ")) return;
      try{
        const eRes = await ghReadFile(GH_ENTRIES_PATH);
        const iRes = await ghReadFile(GH_INITIALS_PATH);
        entries  = base64ToJson(eRes.content);
        initials = base64ToJson(iRes.content);
        await saveUnified();
        renderWithEnsure();
        alert("å·²å¾ GitHub è¼‰å…¥ âœ…");
      }catch(e){
        alert("è¼‰å…¥å¤±æ•—ï¼š\n" + e.message + "\n\næç¤ºï¼šå…ˆæŒ‰ä¸€æ¬¡ã€åŒæ­¥åˆ° GitHubã€å»ºç«‹æª”æ¡ˆã€‚");
      }
    });
  }

  /* Google ç™»å…¥/ç™»å‡ºæŒ‰éˆ• */
  if($("#fbLoginBtn")) $("#fbLoginBtn").addEventListener("click", googleLogin);
  if($("#fbLogoutBtn")) $("#fbLogoutBtn").addEventListener("click", googleLogout);

  /* æ¯æ¬¡é–‹é æŠŠã€Œæ–°å¢æ—¥æœŸã€è¨­ç‚ºä»Šå¤© */
  (function initToday(){
    const dateInput = document.querySelector('input[type="date"]');
    if(dateInput){
      const now = new Date();
      dateInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
    }
  })();

  // åˆæ¬¡æ¸²æŸ“ï¼ˆå°šæœªç™»å…¥ä¹Ÿèƒ½çœ‹æœ¬æ©Ÿï¼‰
  (async function boot(){
    const loaded = await loadUnified();
    entries = loaded.list;
    initials = loaded.initials;
    renderWithEnsure();
  })();

})();
</script>

<script>
  // å¼·åˆ¶æ›´æ–°ï¼ˆä½ åŸæœ¬çš„ï¼‰
  async function forceUpdate() {
    try {
      if ("serviceWorker" in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (const r of regs) await r.unregister();
      }
      if ("caches" in window) {
        const keys = await caches.keys();
        for (const k of keys) await caches.delete(k);
      }
    } catch (e) {}
    location.replace(location.pathname + "?v=" + Date.now());
  }
</script>

<script>
  // PWA å°ˆç”¨ SWï¼šé›¢ç·šå¯ç”¨
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js"); // ç›¸å°æ–¼ /hello/apps/a/
  }
</script>
</body>
</html>
