<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>我的記帳本</title>
  <style>
    :root{
      --bg:#0b0b0b;
      --panel:#151515cc;
      --muted:#bbbbbb;
      --accent:#6ee7ff;
      --danger:#ff7b7b;
      --ok:#8cff9c;
      --border:#2a2a2a;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; color:#fff;
      background:
        linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)),
        url("https://i.pinimg.com/736x/9e/79/c3/9e79c358e0914cd144e90a39f102e1cc.jpg") center / cover no-repeat fixed,
        var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", "Helvetica Neue", Arial, sans-serif;
    }
    @media (max-width: 768px){ body{ background-attachment: scroll; } }

    .container{ max-width:1200px; margin:24px auto 80px; padding:0 16px; }
    header{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom:16px; }
    h1{font-size:26px; margin:0;}
    .controls{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      background:var(--panel); padding:10px 12px; border:1px solid var(--border); border-radius:14px;
    }
    .controls button, .controls select, .controls input{
      background:#202020; color:#fff; border:1px solid var(--border);
      padding:8px 10px; border-radius:10px; outline:none;
    }
    .controls button:hover{filter:brightness(1.12); cursor:pointer}

    .row{display:grid; gap:16px; grid-template-columns: 1.05fr 1fr;}
    @media (max-width: 980px){ .row{grid-template-columns:1fr;} }

    .card{ background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:16px; }
    .card h2{margin:0 0 10px 0; font-size:20px;}

    form.grid{ display:grid; gap:12px; grid-template-columns: repeat(6, 1fr); }
    form.grid > *{min-width:0}
    form.grid input, form.grid select, form.grid button{
      width:100%; background:#202020; color:#fff; border:1px solid var(--border); padding:10px; border-radius:10px;
    }
    form .col-span-1{grid-column: span 1;}
    form .col-span-2{grid-column: span 2;}
    form .col-span-3{grid-column: span 3;}
    form .col-span-6{grid-column: span 6;}
    @media (max-width:900px){
      form.grid{grid-template-columns:1fr 1fr;}
      form .col-span-1, form .col-span-2, form .col-span-3, form .col-span-6{grid-column: span 2;}
    }

    table{width:100%; border-collapse:collapse; margin-top:10px;}
    th, td{border-bottom:1px solid var(--border); padding:10px 8px; text-align:left; font-size:14px;}
    th{color:var(--muted); font-weight:600;}
    td.amount{font-variant-numeric: tabular-nums;}
    .type-income{color:var(--ok); font-weight:600;}
    .type-expense{color:var(--danger); font-weight:600;}
    .actions button{ background:#2a2a2a; border:1px solid var(--border); color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; }

    .summary{ display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; margin-top:8px; }
    @media (max-width:900px){ .summary{ grid-template-columns:1fr 1fr; } }
    .tile{ background:#101010; border:1px solid var(--border); border-radius:14px; padding:14px; }
    .tile h3{margin:0 0 8px 0; font-size:14px; color:var(--muted)}
    .tile .val{font-size:22px; font-variant-numeric: tabular-nums;}
    .tile.income .val{color:var(--ok)}
    .tile.expense .val{color:var(--danger)}
    .tile.net .val{color:var(--accent)}
    .muted{color:var(--muted)}

    /* 右側：分類表（上）＋ 圓餅圖（下） */
    .cat-card h3{margin:0 0 8px 0; font-size:16px; color:var(--muted)}
    .cat-foot{margin-top:6px; font-size:13px; color:var(--muted); display:flex; align-items:center; gap:6px;}
    .legend{ display:flex; flex-wrap:wrap; gap:10px; font-size:13px; color:var(--muted); margin-top:8px; }
    .legend .key{ display:inline-flex; align-items:center; gap:6px; }
    .legend .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }

    .pie-wrap{margin-top:14px; background:#101010; border:1px solid var(--border); border-radius:14px; padding:14px;}
    .pie-title{margin:0 0 8px 0; font-size:16px; color:var(--muted)}

    /* 左側：常用 */
    .quick{ margin-top:14px; background:#101010; border:1px solid var(--border); border-radius:14px; padding:14px; }
    .quick h3{ margin:0 0 10px 0; font-size:16px; color:var(--muted); }
    .quick-list{display:grid; gap:10px;}
    .quick-item{ display:flex; align-items:center; justify-content:space-between; background:#171717; border:1px solid var(--border); border-radius:12px; padding:10px; }
    .badge{ font-size:12px; color:#000; background:#ffd93b; border-radius:999px; padding:2px 8px; margin-left:8px; }
    .quick-item .left{ display:flex; align-items:center; gap:8px; }
    .quick-item .again{ background:#2a2a2a; color:#fff; border:1px solid var(--border); padding:6px 10px; border-radius:8px; cursor:pointer; }

    /* 每週支出統計 */
    .week-card{ margin-top:14px; background:#101010; border:1px solid var(--border); border-radius:14px; padding:14px;}
    .week-card h3{ margin:0 0 8px 0; font-size:16px; color:var(--muted); }
  </style>

  <!-- Firebase（匿名登入 + Firestore；compat 版） -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>我的記帳本</h1>
      <div class="controls">
        <button id="prevMonth" title="上一個月">◀</button>
        <input type="month" id="monthPicker" />
        <button id="nextMonth" title="下一個月">▶</button>
        <span class="muted" id="rangeHint"></span>
        <div style="flex:1"></div>

        <button id="editInitBtn" title="設定本月期初">設定期初</button>
        <button id="exportBtn" title="匯出 JSON">匯出</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="importBtn" title="匯入 JSON">匯入</button>
        <button id="clearBtn" title="清空所有資料">清空</button>

        <!-- GitHub 同步 -->
        <button id="ghLoginBtn" title="登入 GitHub（輸入/更新 Token）">GitHub 登入</button>
        <button id="ghSaveBtn"  title="把本機/雲端資料存到 GitHub">同步到 GitHub</button>
        <button id="ghLoadBtn"  title="從 GitHub 載入到本機">從 GitHub 載入</button>
      </div>
    </header>

    <div class="row">
      <!-- 左側：新增＋最常記 -->
      <section class="card">
        <h2>新增一筆</h2>
        <form id="entryForm" class="grid">
          <input class="col-span-2" type="date" id="date" required />
          <select class="col-span-1" id="type" required>
            <option value="expense">支出</option>
            <option value="income">收入</option>
          </select>
          <input class="col-span-1" type="number" id="amount" inputmode="decimal" step="0.01" placeholder="金額" required />
          <select class="col-span-2" id="category">
            <option value="">選擇類別</option>
            <option value="吃">吃</option>
            <option value="交通">交通</option>
            <option value="玩">玩</option>
            <option value="其他">其他</option>
          </select>
          <input class="col-span-3" type="text" id="note" placeholder="備註（可留空）" />
          <button class="col-span-6" type="submit">加入</button>
        </form>
        <p class="muted" style="margin-top:8px;">提示：月份統計依日期（每月 1 日 ~ 該月最後一天）。</p>

        <!-- 常用（以 金額+類別 為一組） -->
        <div class="quick">
          <h3>最常記的 5 筆</h3>
          <div id="quickList" class="quick-list"></div>
        </div>
      </section>

      <!-- 右側：本月明細 + 分類表(上) + 圓餅圖(下) + 每週支出統計 -->
      <section class="card">
        <h2>本月明細</h2>
        <div class="summary">
          <div class="tile income"><h3>本月收入</h3><div class="val" id="sumIncome">$0</div></div>
          <div class="tile expense"><h3>本月支出</h3><div class="val" id="sumExpense">$0</div></div>
          <div class="tile net"><h3>本月淨額（收−支）</h3><div class="val" id="sumNet">$0</div></div>
          <div class="tile"><h3>本月期初（本錢）</h3><div class="val" id="sumInit">$0</div></div>
          <div class="tile"><h3>本月期末（結餘）</h3><div class="val" id="sumEnd">$0</div></div>
        </div>

        <!-- 分類表（上） -->
        <div class="cat-card">
          <h3>本月分類小計（支出）</h3>
          <table id="catTable">
            <thead>
              <tr>
                <th style="width:120px">分類</th>
                <th style="width:140px">金額小計</th>
                <th>筆數</th>
              </tr>
            </thead>
            <tbody id="catTbody"></tbody>
          </table>
          <div class="cat-foot"><span>．</span><span id="catDesc" class="muted">—</span></div>
        </div>

        <!-- 圓餅圖（下） -->
        <div class="pie-wrap">
          <h3 class="pie-title">支出圓餅圖</h3>
          <canvas id="catPie" width="520" height="320" style="width:100%;height:auto;display:block;"></canvas>
          <div id="catLegend" class="legend"></div>
        </div>

        <!-- 每週支出統計 -->
        <div class="week-card">
          <h3>每週支出統計</h3>
          <table id="weekTable">
            <thead>
              <tr>
                <th style="width:80px;">週次</th>
                <th style="width:160px;">日期範圍</th>
                <th>支出金額</th>
              </tr>
            </thead>
            <tbody id="weekTbody"></tbody>
          </table>
        </div>

        <!-- 全部列表 -->
        <table id="table" style="margin-top:14px;">
          <thead>
            <tr>
              <th style="width:110px">日期</th>
              <th style="width:80px">收/支</th>
              <th style="width:110px">金額</th>
              <th>類別</th>
              <th>備註</th>
              <th style="width:90px">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </section>
    </div>
  </div>

  <script>
    /* =================== 你需要填的設定（GitHub、Firebase） =================== */
    // GitHub 同步
    const GH_OWNER = "Eyvind95";   // ← 改成你的 GitHub 帳號
    const GH_REPO  = "hello";      // ← 改成你的 repo 名
    const GH_BRANCH = "main";
    const GH_ENTRIES_PATH  = "data/entries.json";
    const GH_INITIALS_PATH = "data/initials.json";
    const GH_TOKEN_KEY = "gh_pat_my_ledger"; // Token 儲存在瀏覽器

    // Firebase（匿名登入 + Firestore；users/{uid}/{entries|initials}）
    const USE_FIREBASE = true; // 想暫時不用雲端可改 false
    const firebaseConfig = {
      apiKey: "AIzaSyAP4hKop0wN9jrAN6_xx0fGhwInAAa5chI",
      authDomain: "eyvind95-182f0.firebaseapp.com",
      projectId: "eyvind95-182f0",
      storageBucket: "eyvind95-182f0.firebasestorage.app",
      messagingSenderId: "105770576221",
      appId: "1:105770576221:web:4256dca5ec54b7cf91a0b4"
      // measurementId: "G-XXXX" // 可留空
    };
    const FIREBASE_ROOT = "users";
    const FIREBASE_SUB_ENTRIES  = "entries";
    const FIREBASE_SUB_INITIALS = "initials";

    /* =================== 共用工具 & 本機儲存 =================== */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const LS_KEY = "ledgerEntries_v1";
    const INITIALS_KEY = "ledgerInitials_v1";

    const fmtMoney = (n) => new Intl.NumberFormat("zh-Hant-TW", { style: "currency", currency: "TWD" }).format(Number(n)||0);
    const ymd = (d) => d.toISOString().slice(0,10);
    const toDate = (s) => new Date(s + "T00:00:00");
    const getMonthRange = (year, monthIdx /*0-11*/) => {
      const start = new Date(Date.UTC(year, monthIdx, 1));
      const end = new Date(Date.UTC(year, monthIdx + 1, 0));
      return { start, end };
    };
    function round2(n){ return Math.round(n * 100) / 100; }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&quot;',"'":'&#039;'}[c])); }
    function monthKey(y, m){ return `${y}-${String(m).padStart(2,'0')}`; } // m:1-12
    function prevMonthOf(y, m){ const d=new Date(Date.UTC(y, m-1, 1)); d.setUTCMonth(d.getUTCMonth()-1); return {y:d.getUTCFullYear(), m:d.getUTCMonth()+1}; }

    function loadLocal(){ try{ const raw=localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
    function saveLocal(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }
    function loadInitialsLocal(){ try{ const raw=localStorage.getItem(INITIALS_KEY); return raw ? JSON.parse(raw) : {}; }catch(e){ return {}; } }
    function saveInitialsLocal(obj){ localStorage.setItem(INITIALS_KEY, JSON.stringify(obj)); }

    /* =================== Firebase 初始化/讀寫（UID 隔離） =================== */
    let db = null;
    let CURRENT_UID = null;

    async function firebaseInitIfNeeded(){
      if(!USE_FIREBASE) return;
      if(db && CURRENT_UID) return;
      if(firebase.apps.length === 0){ firebase.initializeApp(firebaseConfig); }
      const cred = await firebase.auth().signInAnonymously();
      CURRENT_UID = cred.user.uid;
      db = firebase.firestore();
    }
    function colEntries(){  return db.collection(FIREBASE_ROOT).doc(CURRENT_UID).collection(FIREBASE_SUB_ENTRIES); }
    function colInitials(){ return db.collection(FIREBASE_ROOT).doc(CURRENT_UID).collection(FIREBASE_SUB_INITIALS); }

    async function cloudLoad(){
      await firebaseInitIfNeeded();
      const list = [];
      const snap = await colEntries().get();
      snap.forEach(doc => list.push(doc.data()));
      list.sort((a,b)=> (a.date===b.date? (a.createdAt||0)-(b.createdAt||0) : a.date.localeCompare(b.date)));
      return list;
    }
    async function cloudLoadInitials(){
      await firebaseInitIfNeeded();
      const obj = {};
      const snap = await colInitials().get();
      snap.forEach(doc => { obj[doc.id] = (doc.data().amount || 0); });
      return obj;
    }
    async function cloudSave(all){
      await firebaseInitIfNeeded();
      const cur = await colEntries().get();
      const del = db.batch();
      cur.forEach(doc=> del.delete(doc.ref));
      await del.commit();
      const batch = db.batch();
      for(const it of all){ batch.set(colEntries().doc(it.id), it); }
      await batch.commit();
    }
    async function cloudSaveInitials(obj){
      await firebaseInitIfNeeded();
      const cur = await colInitials().get();
      const del = db.batch();
      cur.forEach(doc=> del.delete(doc.ref));
      await del.commit();
      const batch = db.batch();
      for(const [k,v] of Object.entries(obj)){ batch.set(colInitials().doc(k), { amount: Number(v)||0 }); }
      await batch.commit();
    }

    // 統一入口：能上雲就雲，失敗回落本機
    async function loadUnified(){
      if(USE_FIREBASE){
        try{
          const [list, ini] = await Promise.all([cloudLoad(), cloudLoadInitials()]);
          saveLocal(list); saveInitialsLocal(ini); // 離線備份
          return { list, initials: ini };
        }catch(e){
          alert("雲端讀取失敗，改用本機資料");
        }
      }
      return { list: loadLocal(), initials: loadInitialsLocal() };
    }
    async function saveUnified(){
      if(USE_FIREBASE){
        try{
          await Promise.all([cloudSave(entries), cloudSaveInitials(initials)]);
          return;
        }catch(e){
          alert("雲端儲存失敗，資料先留在本機");
        }
      }
      saveLocal(entries); saveInitialsLocal(initials);
    }

    /* =================== GitHub API =================== */
    function ghGetToken(){ return localStorage.getItem(GH_TOKEN_KEY) || ""; }
    function ghSetToken(t){ if(!t) return; localStorage.setItem(GH_TOKEN_KEY, t); alert("已儲存 GitHub Token（存在本機瀏覽器）"); }
    async function ghApi(path, method="GET", body){
      const token = ghGetToken();
      if(!token) throw new Error("尚未設定 GitHub Token");
      const res = await fetch(`https://api.github.com${path}`, {
        method,
        headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" },
        body: body ? JSON.stringify(body) : undefined
      });
      if(!res.ok){ const t = await res.text(); throw new Error(`GitHub API ${res.status}: ${t}`); }
      return res.json();
    }
    async function ghReadFile(repoPath){ return ghApi(`/repos/${GH_OWNER}/${GH_REPO}/contents/${repoPath}?ref=${GH_BRANCH}`,"GET"); }
    async function ghWriteFile(repoPath, jsonObj, message){
      const contentStr = JSON.stringify(jsonObj, null, 2);
      const base64 = btoa(unescape(encodeURIComponent(contentStr)));
      let sha = undefined; try{ const exist = await ghReadFile(repoPath); sha = exist.sha; }catch(e){}
      return ghApi(`/repos/${GH_OWNER}/${GH_REPO}/contents/${repoPath}`, "PUT", { message: message || `update ${repoPath}`, content: base64, branch: GH_BRANCH, sha });
    }
    function base64ToJson(b64){ const str = decodeURIComponent(escape(atob(b64))); return JSON.parse(str); }

    /* =================== 狀態 & 日期初始化 =================== */
    let entries = [];
    let initials = {};
    const monthPicker = $("#monthPicker");

    // 每次開頁都帶入今天
    (function initDatesNow(){
      const now = new Date();
      monthPicker.value = now.toISOString().slice(0,7);
      $("#date").value = ymd(now);
    })();

    /* =================== 期初：自動承接上月期末或第一次提示 =================== */
    function ensureInitialForMonth(y, m){
      const mk = monthKey(y, m);
      if(initials[mk] !== undefined) return;

      const { y:py, m:pm } = prevMonthOf(y, m);
      const pmk = monthKey(py, pm);
      let prevInit = Number(initials[pmk] ?? 0);

      const {start:ps, end:pe} = getMonthRange(py, pm-1);
      let pIncome = 0, pExpense = 0;
      for(const it of entries){
        const d = toDate(it.date);
        if(d >= ps && d <= pe){
          if(it.type === "income") pIncome += it.amount;
          else pExpense += it.amount;
        }
      }
      pIncome = round2(pIncome); pExpense = round2(pExpense);
      const prevEnd = round2(prevInit + pIncome - pExpense);

      if(initials[pmk] !== undefined || pIncome > 0 || pExpense > 0){
        initials[mk] = prevEnd;
      }else{
        const v = prompt(`請輸入 ${y} 年 ${m} 月的期初金額（本錢）：`, "0");
        const n = Number(v);
        initials[mk] = Number.isFinite(n) ? round2(n) : 0;
      }
      // 存
      saveUnified();
    }

    /* =================== 事件：新增/刪除/匯出/匯入/清空 =================== */
    $("#entryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const date = $("#date").value;
      const type = $("#type").value;
      const amountStr = $("#amount").value.trim();
      const category = type === "expense" ? $("#category").value : "";
      const note = $("#note").value.trim();

      if(!date || !type || !amountStr){ return; }
      const amount = parseFloat(amountStr);
      if(isNaN(amount) || amount <= 0){ alert("請輸入正確金額（> 0）"); return; }

      const entry = { id: crypto.randomUUID(), date, type, amount: round2(amount), category, note, createdAt: Date.now() };
      entries.push(entry);
      await saveUnified();

      $("#amount").value = ""; $("#note").value = "";
      renderWithEnsure();
    });

    async function removeEntry(id){
      if(!confirm("確定刪除此筆？")) return;
      entries = entries.filter(e => e.id !== id);
      await saveUnified();
      renderWithEnsure();
    }

    $("#exportBtn").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify({entries, initials}, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "ledger_backup.json"; a.click();
      URL.revokeObjectURL(url);
    });
    $("#importBtn").addEventListener("click", () => $("#importFile").click());
    $("#importFile").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!data || !Array.isArray(data.entries) || typeof data.initials !== "object") throw new Error("格式錯誤");
        for(const it of data.entries){ if(!it.id || !it.date || !it.type || !it.amount) throw new Error("明細缺少必要欄位"); }
        entries = data.entries;
        initials = data.initials;
        await saveUnified();
        alert("匯入完成！");
        renderWithEnsure();
      }catch(err){ alert("匯入失敗：" + err.message); }
      finally{ e.target.value = ""; }
    });
    $("#clearBtn").addEventListener("click", async () => {
      if(confirm("這會刪除所有『明細＋期初』資料（不可復原）。確定？")){
        entries = []; initials = {};
        await saveUnified();
        renderWithEnsure();
      }
    });

    /* 類別選單：收入隱藏、支出顯示 */
    $("#type").addEventListener("change", () => {
      $("#category").style.display = ($("#type").value === "income") ? "none" : "block";
    });
    $("#type").dispatchEvent(new Event("change"));

    /* 手動調整期初 */
    document.getElementById("editInitBtn").addEventListener("click", async () => {
      const [y, m] = monthPicker.value.split("-").map(x=>parseInt(x,10));
      const mk = monthKey(y, m);
      const cur = Number(initials[mk] ?? 0);
      const v = prompt(`設定 ${y} 年 ${m} 月期初金額：`, String(cur));
      if(v === null) return;
      const n = Number(v);
      initials[mk] = Number.isFinite(n) ? round2(n) : cur;
      await saveUnified();
      renderWithEnsure();
    });

    /* 月份切換 */
    $("#prevMonth").addEventListener("click", () => shiftMonth(-1));
    $("#nextMonth").addEventListener("click", () => shiftMonth(1));
    function shiftMonth(delta){
      const [y, m] = monthPicker.value.split("-").map(x=>parseInt(x,10));
      const d = new Date(Date.UTC(y, m - 1 + delta, 1));
      monthPicker.value = d.toISOString().slice(0,7);
      renderWithEnsure();
    }
    monthPicker.addEventListener("change", renderWithEnsure);

    /* =================== 渲染流程 =================== */
    function renderWithEnsure(){
      const [y, m] = monthPicker.value.split("-").map(x=>parseInt(x,10));
      ensureInitialForMonth(y, m);
      render();
    }

    function render(){
      const [y, m] = monthPicker.value.split("-").map(x=>parseInt(x,10));
      const {start, end} = getMonthRange(y, m - 1);
      $("#rangeHint").textContent = `${y}年${m}月 1 日 ~ ${y}年${m}月 ${end.getUTCDate()} 日`;

      // 本月資料
      const monthItems = entries
        .filter(e => { const d = toDate(e.date); return d >= start && d <= end; })
        .sort((a,b) => (a.date === b.date ? a.createdAt - b.createdAt : a.date.localeCompare(b.date)));

      // 明細表
      const tbody = $("#tbody");
      tbody.innerHTML = "";
      for(const it of monthItems){
        const tr = document.createElement("tr");
        const typeClass = it.type === "income" ? "type-income" : "type-expense";
        tr.innerHTML = `
          <td>${it.date}</td>
          <td class="${typeClass}">${it.type === "income" ? "收入" : "支出"}</td>
          <td class="amount">${fmtMoney(it.amount)}</td>
          <td>${escapeHtml(it.category || "")}</td>
          <td>${escapeHtml(it.note || "")}</td>
          <td class="actions"><button data-id="${it.id}" class="del">刪除</button></td>
        `;
        tbody.appendChild(tr);
      }
      $$("#tbody .del").forEach(btn => btn.addEventListener("click", () => removeEntry(btn.dataset.id)));

      // 匯總
      let income = 0, expense = 0;
      for(const it of monthItems){ if(it.type === "income") income += it.amount; else expense += it.amount; }
      income = round2(income); expense = round2(expense);
      const net = round2(income - expense);
      $("#sumIncome").textContent = fmtMoney(income);
      $("#sumExpense").textContent = fmtMoney(expense);
      $("#sumNet").textContent = fmtMoney(net);

      // 期初/期末
      const mk = monthKey(y, m);
      const initAmt = Number(initials[mk] ?? 0);
      const endAmt = round2(initAmt + income - expense);
      $("#sumInit").textContent = fmtMoney(initAmt);
      $("#sumEnd").textContent  = fmtMoney(endAmt);

      // 分類 & 圓餅
      renderCategorySummary(monthItems);

      // 常用（歷史所有；若只看本月，把 entries 改成 monthItems）
      renderFrequentPairs(entries);

      // 週統計（支出）
      renderWeekly(entries, y, m);
    }

    // 分類小計 + 圓餅圖
    function renderCategorySummary(monthItems){
      const cats = ["吃","交通","玩","其他"];
      const colors = { "吃":"#ff7f50", "交通":"#ffd93b", "玩":"#6ec5ff", "其他":"#aaaaaa" };

      const map = new Map(cats.map(c => [c, {sum:0, count:0}]));
      for(const it of monthItems){
        if(it.type !== "expense") continue;
        const key = (it.category || "").trim();
        if(map.has(key)){ const rec = map.get(key); rec.sum = round2(rec.sum + it.amount); rec.count += 1; }
      }

      const rows = [];
      let descParts = [];
      for(const cat of cats){
        const rec = map.get(cat);
        rows.push(`<tr><td>${cat}</td><td class="amount">${fmtMoney(rec.sum)}</td><td>${rec.count}</td></tr>`);
        if(rec.sum>0) descParts.push(`${cat} ${fmtMoney(rec.sum)}（${rec.count} 筆）`);
      }
      $("#catTbody").innerHTML = rows.join("");
      $("#catDesc").textContent = descParts.length? descParts.join("，") : "本月尚無支出";

      const data = cats.map(c => ({ label:c, value: map.get(c).sum, color: colors[c] }));
      const total = data.reduce((s,d)=>s+d.value,0);
      drawPie("catPie", data, total);

      const legend = $("#catLegend");
      if(legend){
        legend.innerHTML = (total<=0)
          ? `<span class="muted">本月尚無支出</span>`
          : data.filter(d=>d.value>0).map(d=>{
              const pct=((d.value/total)*100).toFixed(1);
              return `<span class="key"><span class="dot" style="background:${d.color}"></span>${d.label} ${pct}%</span>`;
            }).join(" ");
      }
    }
    function drawPie(canvasId, data, total){
      const canvas = document.getElementById(canvasId);
      if(!canvas) return;
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if(!total || total<=0){
        ctx.beginPath();
        ctx.arc(canvas.width/2, canvas.height/2, Math.min(canvas.width, canvas.height)/2 - 10, 0, Math.PI*2);
        ctx.strokeStyle = "rgba(255,255,255,0.15)";
        ctx.lineWidth = 10;
        ctx.stroke();
        ctx.fillStyle = "rgba(255,255,255,0.7)";
        ctx.font = "14px system-ui, -apple-system, 'Segoe UI', Roboto";
        ctx.textAlign = "center";
        ctx.fillText("本月無支出", canvas.width/2, canvas.height/2+5);
        return;
      }

      const cx = canvas.width/2, cy = canvas.height/2;
      const r  = Math.min(canvas.width, canvas.height)/2 - 8;
      let start = -Math.PI/2;

      for(const d of data){
        if(d.value<=0) continue;
        const ang = d.value/total * Math.PI*2;
        ctx.beginPath(); ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,start,start+ang);
        ctx.closePath(); ctx.fillStyle=d.color; ctx.fill();
        start += ang;
      }
      ctx.beginPath(); ctx.arc(cx,cy,r*0.55,0,Math.PI*2); ctx.fillStyle="#101010"; ctx.fill();
      ctx.fillStyle="rgba(255,255,255,0.9)";
      ctx.font="12px system-ui, -apple-system, 'Segoe UI', Roboto";
      ctx.textAlign="center"; ctx.fillText("總支出",cx,cy-4);
      ctx.font="16px system-ui, -apple-system, 'Segoe UI', Roboto";
      ctx.fillText(fmtMoney(total),cx,cy+18);
    }

    /* 最常記的 5 筆（金額+類別；只統計支出） */
    function renderFrequentPairs(all){
      const map = new Map(); // "80|吃" -> {amount, category, count}
      for(const it of all){
        if(it.type !== "expense") continue;
        const amt = round2(it.amount);
        const cat = it.category || "";
        const key = `${amt}|${cat}`;
        if(!map.has(key)) map.set(key, { amount: amt, category: cat, count: 0 });
        map.get(key).count++;
      }
      const arr = Array.from(map.values())
        .sort((a,b)=> (b.count - a.count) || (b.amount - a.amount) || a.category.localeCompare(b.category))
        .slice(0,5);

      const box = $("#quickList");
      box.innerHTML = arr.length ? "" : `<div class="muted">目前還沒有可統計的常用項目</div>`;

      for(const it of arr){
        const div = document.createElement("div");
        div.className = "quick-item";
        div.innerHTML = `
          <div class="left">
            <strong>${fmtMoney(it.amount)}</strong>
            <span class="muted">（${it.category || "—"}）</span>
            <span class="badge">×${it.count}</span>
          </div>
          <button class="again" data-amount="${it.amount}" data-category="${it.category}">再記一次</button>
        `;
        box.appendChild(div);
      }

      // 再記一次：把金額/類別帶回表單（日期使用目前表單）
      $$("#quickList .again").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          $("#type").value = "expense";
          $("#category").style.display = "block";
          $("#amount").value = btn.dataset.amount;
          $("#category").value = btn.dataset.category || "";
        });
      });
    }

    /* 每週支出統計（Mon~Sun） */
    function renderWeekly(all, y, m){
      const {start, end} = getMonthRange(y, m - 1);
      const weeks = [];
      const firstDay = new Date(Date.UTC(y, m-1, 1));
      const firstDow = (firstDay.getUTCDay() + 6) % 7; // 週一=0
      const firstMonday = new Date(firstDay); firstMonday.setUTCDate(firstDay.getUTCDate() - firstDow);

      for(let i=0;;i++){
        const ws = new Date(firstMonday); ws.setUTCDate(firstMonday.getUTCDate()+ i*7);
        const we = new Date(ws); we.setUTCDate(ws.getUTCDate()+6);
        if(ws > end && we > end) break;
        if(we < start || ws > end) continue;
        weeks.push({ws, we});
        if(we >= end) break;
      }

      const tbody = $("#weekTbody");
      tbody.innerHTML = "";
      weeks.forEach((w, idx)=>{
        let sum = 0;
        for(const it of all){
          if(it.type !== "expense") continue;
          const d = toDate(it.date);
          if(d >= w.ws && d <= w.we) sum += it.amount;
        }
        const tr = document.createElement("tr");
        const startStr = `${String(w.ws.getUTCMonth()+1).padStart(2,'0')}/${String(w.ws.getUTCDate()).padStart(2,'0')}`;
        const endStr   = `${String(w.we.getUTCMonth()+1).padStart(2,'0')}/${String(w.we.getUTCDate()).padStart(2,'0')}`;
        tr.innerHTML = `<td>第 ${idx+1} 週</td><td>${startStr} ~ ${endStr}</td><td class="amount">${fmtMoney(round2(sum))}</td>`;
        tbody.appendChild(tr);
      });
    }

    /* GitHub 按鈕事件 */
    document.getElementById("ghLoginBtn").addEventListener("click", () => {
      const cur = ghGetToken();
      const t = prompt("貼上你的 GitHub Fine-grained Token（只會存本機）:", cur || "");
      if(t) ghSetToken(t.trim());
    });
    document.getElementById("ghSaveBtn").addEventListener("click", async () => {
      try{
        await ghWriteFile(GH_ENTRIES_PATH, entries, "save: entries");
        await ghWriteFile(GH_INITIALS_PATH, initials, "save: initials");
        alert("已同步到 GitHub ✅");
      }catch(e){ alert("同步失敗：\n" + e.message); }
    });
    document.getElementById("ghLoadBtn").addEventListener("click", async () => {
      if(!confirm("這會用 GitHub 上的資料覆蓋本機（此裝置）的資料，確定？")) return;
      try{
        const eRes = await ghReadFile(GH_ENTRIES_PATH);
        const iRes = await ghReadFile(GH_INITIALS_PATH);
        entries  = base64ToJson(eRes.content);
        initials = base64ToJson(iRes.content);
        await saveUnified();
        renderWithEnsure();
        alert("已從 GitHub 載入 ✅");
      }catch(e){ alert("載入失敗：\n" + e.message + "\n\n提示：先按一次『同步到 GitHub』建立檔案。"); }
    });

    /* 啟動：讀資料 → 渲染 */
    (async () => {
      const loaded = await loadUnified();
      entries  = loaded.list;
      initials = loaded.initials;
      renderWithEnsure();
    })();
  </script>
</body>
</html>
