<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>我的記帳本</title>
  <style>
    :root{
      --bg:#0b0b0b;
      --panel:#151515cc;
      --muted:#bbbbbb;
      --accent:#6ee7ff;
      --danger:#ff7b7b;
      --ok:#8cff9c;
      --border:#2a2a2a;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0;
      color:#fff; /* 全站白字 */
     background-image: url("https://i.pinimg.com/736x/9e/79/c3/9e79c358e0914cd144e90a39f102e1cc.jpg");
      background-repeat: no-repeat;  
      background-size: cover;        
      background-attachment: fixed; 
    }
    .container{
      max-width:1100px; margin:32px auto; padding:0 16px;
    }
    header{
      display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px;
    }
    h1{font-size:28px; margin:0;}
    .controls{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      background:var(--panel); padding:10px 12px; border:1px solid var(--border); border-radius:14px;
    }
    .controls button, .controls select, .controls input{
      background:#202020; color:#fff; border:1px solid var(--border); padding:8px 10px; border-radius:10px; outline:none;
    }
    .controls button:hover{filter:brightness(1.15); cursor:pointer}
    .row{display:grid; gap:16px; grid-template-columns: 1.1fr 1fr;}
    @media (max-width: 900px){ .row{grid-template-columns:1fr;} }

    /* 表單 */
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
    }
    .card h2{margin:0 0 10px 0; font-size:20px;}
    form.grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(6, 1fr);
    }
    form.grid > *{min-width:0}
    form.grid input, form.grid select, form.grid button{
      width:100%;
      background:#202020; color:#fff; border:1px solid var(--border); padding:10px; border-radius:10px;
    }
    form .col-span-2{grid-column: span 2;}
    form .col-span-3{grid-column: span 3;}
    form .col-span-6{grid-column: span 6;}
    @media (max-width:900px){
      form.grid{grid-template-columns:1fr 1fr;}
      form .col-span-2, form .col-span-3, form .col-span-6{grid-column: span 2;}
    }

    /* 表格 */
    table{width:100%; border-collapse:collapse; margin-top:10px;}
    th, td{border-bottom:1px solid var(--border); padding:10px 8px; text-align:left; font-size:14px;}
    th{color:var(--muted); font-weight:600;}
    td.amount{font-variant-numeric: tabular-nums;}
    .type-income{color:var(--ok); font-weight:600;}
    .type-expense{color:var(--danger); font-weight:600;}
    .actions button{
      background:#2a2a2a; border:1px solid var(--border); color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer;
    }

    /* 總結板 */
    .summary{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:8px;
    }
    .tile{
      background:#101010; border:1px solid var(--border); border-radius:14px; padding:14px;
    }
    .tile h3{margin:0 0 8px 0; font-size:14px; color:var(--muted)}
    .tile .val{font-size:22px; font-variant-numeric: tabular-nums;}
    .tile.income .val{color:var(--ok)}
    .tile.expense .val{color:var(--danger)}
    .tile.net .val{color:var(--accent)}
    .muted{color:var(--muted)}
    .right{display:flex;align-items:center;gap:8px;}
    .spacer{flex:1}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>我的記帳本</h1>
      <div class="controls">
        <button id="prevMonth" title="上一個月">◀</button>
        <input type="month" id="monthPicker" />
        <button id="nextMonth" title="下一個月">▶</button>
        <span class="muted" id="rangeHint"></span>
        <div class="spacer"></div>
        <button id="exportBtn" title="匯出 JSON">匯出</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="importBtn" title="匯入 JSON">匯入</button>
        <button id="clearBtn" title="清空所有資料">清空</button>
      </div>
    </header>

    <div class="row">
      <!-- 左側：新增記帳 -->
      <section class="card">
        <h2>新增一筆</h2>
        <form id="entryForm" class="grid">
          <input class="col-span-2" type="date" id="date" required />
          <select class="col-span-2" id="type" required>
            <option value="expense">支出</option>
            <option value="income">收入</option>
          </select>
          <input class="col-span-2" type="number" id="amount" inputmode="decimal" step="0.01" placeholder="金額" required />
<select class="col-span-3" id="category">
  <option value="">選擇類別</option>
  <option value="吃">吃</option>
  <option value="交通">交通</option>
  <option value="玩">玩</option>
  <option value="其他">其他</option>
</select>
          <input class="col-span-3" type="text" id="note" placeholder="備註（可留空）" />
          <button class="col-span-6" type="submit">加入</button>
        </form>
        <p class="muted" style="margin-top:8px;">提示：日期會影響統計月份（以每月 1 日 ~ 該月最後一天計算）。</p>
      </section>

      <!-- 右側：列表與統計 -->
      <section class="card">
        <h2>本月明細</h2>
        <div class="summary">
          <div class="tile income">
            <h3>本月收入</h3>
            <div class="val" id="sumIncome">$0</div>
          </div>
          <div class="tile expense">
            <h3>本月支出</h3>
            <div class="val" id="sumExpense">$0</div>
          </div>
          <div class="tile net">
            <h3>本月淨額（收入−支出）</h3>
            <div class="val" id="sumNet">$0</div>
          </div>
        </div>

        <table id="table">
          <thead>
            <tr>
              <th style="width:110px">日期</th>
              <th style="width:80px">收/支</th>
              <th style="width:110px">金額</th>
              <th>類別</th>
              <th>備註</th>
              <th style="width:90px">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </section>
    </div>
  </div>

  <script>
    // ===== 工具 =====
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const LS_KEY = "ledgerEntries_v1"; // localStorage key

    const fmtMoney = (n) => {
      if (Number.isNaN(n)) return "$0";
      // 以「元」顯示，保留 2 位小數；可改成 TWD 標準格式
      return new Intl.NumberFormat("zh-Hant-TW", { style: "currency", currency: "TWD" }).format(n);
    };
    const ymd = (d) => d.toISOString().slice(0,10);
    const toDate = (s) => new Date(s + "T00:00:00");

    const getMonthRange = (year, monthIdx /*0-11*/) => {
      const start = new Date(Date.UTC(year, monthIdx, 1));
      const end = new Date(Date.UTC(year, monthIdx + 1, 0)); // 該月最後一天
      return { start, end }; // 含首尾
    };

    // ===== 狀態 =====
    let entries = load();
    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){ return []; }
    }
    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(entries));
    }

    // ===== 初始化月份選擇器 =====
    const monthPicker = $("#monthPicker");
    const today = new Date();
    // 預設顯示本月
    monthPicker.value = today.toISOString().slice(0,7);

    // 範例：表單預設日期填今天
    $("#date").value = ymd(today);

    // ===== 新增 =====
    $("#entryForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const date = $("#date").value;
      const type = $("#type").value; // 'income' | 'expense'
      const amountStr = $("#amount").value.trim();
      const category = $("#category").value.trim();
      const note = $("#note").value.trim();

      if(!date || !type || !amountStr){ return; }
      const amount = parseFloat(amountStr);
      if(isNaN(amount) || amount <= 0){
        alert("請輸入正確金額（> 0）");
        return;
      }

      const entry = {
        id: crypto.randomUUID(),
        date, type, amount: round2(amount),
        category, note,
        createdAt: Date.now()
      };
      entries.push(entry);
      save();

      // 清空可選欄位
      $("#amount").value = "";
      $("#category").value = "";
      $("#note").value = "";

      render();
    });

    // 四捨五入到 2 位小數（避免浮點誤差）
    function round2(n){
      return Math.round(n * 100) / 100;
    }

    // ===== 刪除 =====
    function removeEntry(id){
      if(!confirm("確定刪除此筆？")) return;
      entries = entries.filter(e => e.id !== id);
      save();
      render();
    }

    // ===== 匯出 / 匯入 / 清空 =====
    $("#exportBtn").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(entries, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "ledger_backup.json"; a.click();
      URL.revokeObjectURL(url);
    });
    $("#importBtn").addEventListener("click", () => $("#importFile").click());
    $("#importFile").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!Array.isArray(data)) throw new Error("格式錯誤");
        // 簡易驗證
        for(const it of data){
          if(!it.id || !it.date || !it.type || !it.amount) throw new Error("缺少必要欄位");
        }
        entries = data;
        save(); render();
        alert("匯入完成！");
      }catch(err){
        alert("匯入失敗：" + err.message);
      }finally{
        e.target.value = "";
      }
    });
    $("#clearBtn").addEventListener("click", () => {
      if(confirm("這會刪除所有記帳資料（不可復原）。確定？")){
        entries = []; save(); render();
      }
    });

    // ===== 月份切換 =====
    $("#prevMonth").addEventListener("click", () => shiftMonth(-1));
    $("#nextMonth").addEventListener("click", () => shiftMonth(1));
    function shiftMonth(delta){
      const [y, m] = monthPicker.value.split("-").map(x=>parseInt(x,10));
      const d = new Date(Date.UTC(y, m - 1 + delta, 1));
      monthPicker.value = d.toISOString().slice(0,7);
      render();
    }
    monthPicker.addEventListener("change", render);

    // ===== 計算 & 呈現 =====
    function render(){
      const [y, m] = monthPicker.value.split("-").map(x=>parseInt(x,10));
      const {start, end} = getMonthRange(y, m - 1);

      // 顯示區間提示（x月1號到x月x號）
      const hint = `${y}年${m}月 1 日 ~ ${y}年${m}月 ${end.getUTCDate()} 日`;
      $("#rangeHint").textContent = hint;

      // 篩選本月資料（含起迄）
      const monthItems = entries
        .filter(e => {
          const d = toDate(e.date);
          return d >= start && d <= end;
        })
        // 依日期、建立時間排序
        .sort((a,b) => (a.date === b.date ? a.createdAt - b.createdAt : a.date.localeCompare(b.date)));

      // 表格
      const tbody = $("#tbody");
      tbody.innerHTML = "";
      for(const it of monthItems){
        const tr = document.createElement("tr");
        const typeClass = it.type === "income" ? "type-income" : "type-expense";
        tr.innerHTML = `
          <td>${it.date}</td>
          <td class="${typeClass}">${it.type === "income" ? "收入" : "支出"}</td>
          <td class="amount">${fmtMoney(it.amount)}</td>
          <td>${escapeHtml(it.category || "")}</td>
          <td>${escapeHtml(it.note || "")}</td>
          <td class="actions">
            <button data-id="${it.id}" class="del">刪除</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
      // 刪除事件
      $$("#tbody .del").forEach(btn => {
        btn.addEventListener("click", () => removeEntry(btn.dataset.id));
      });

      // 統計
      let income = 0, expense = 0;
      for(const it of monthItems){
        if(it.type === "income") income += it.amount;
        else expense += it.amount;
      }
      income = round2(income); expense = round2(expense);
      const net = round2(income - expense);
      $("#sumIncome").textContent = fmtMoney(income);
      $("#sumExpense").textContent = fmtMoney(expense);
      $("#sumNet").textContent = fmtMoney(net);
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    }
$("#type").addEventListener("change", () => {
      if ($("#type").value === "income") {
        $("#category").style.display = "none";
      } else {
        $("#category").style.display = "block";
      }
    });
    // 初始化呼叫一次
    $("#type").dispatchEvent(new Event("change"));
    // << 新增結束
    render();
  </script>
</body>
</html>
